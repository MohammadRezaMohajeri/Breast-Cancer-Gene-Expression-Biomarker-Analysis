<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>R Code For 4 Datasets (FC/FDR)</title>
	<style>
		/* CSS Styles */
		/* To highlight different  parts of the text in red, green, and blue, you can use the <span> element and apply CSS styles to  it */ 
		
		.orange-text {
			color: orange;
			font-weight: bold;
		}
		.dark-yellow-text {
			color: hsl(50, 100%, 30%); /* Adjust the hue and saturation values as needed */
			font-weight: bold;
		}
		.brown-text {
			color: hsl(30, 100%, 30%); /* Adjust the hue and saturation values as needed */
			font-weight: bold;
		}
		.green-text {
			color: green;
			font-weight: bold;
		}
		.purple-text {
			color: purple;
			font-weight: bold;
		}
		.blue-text {
			color: blue;
			font-weight: bold;
		}

		/* Header Styles */
		header {
			background-color: #073008;
			color: white;
			text-align: center;
			padding: 5px;
		}

		h1 {
			color: white; /* Adjust the font color as desired */
			font-size: 30px; /* Adjust the font size as desired */
			font-weight: bold; /* Add font weight as desired */
			text-align: center; /* Center the header title */
			padding: 0px; /* Add padding around the header title */
		}
		
		hr {
			width: 100%; /* Adjust the width as desired */
		}
		
		/* Drop-down Styles */
		.drop-down-content {
			display: none;
		}

		.dropdown-trigger {
			cursor: pointer;
		}

		.drop-down-content.active {
			display: block;
		}
		
		
		h3.dropdown-trigger {
		font-size: 24px; /* Adjust the font size as desired */
		}

	        /* Adjust font size for paragraph under 1-1- Explanation:*/
		.drop-down-content p {
			font-size: 16px; /* Adjust the font size as desired */
		}

		/* Adjust font size for list items */
		.drop-down-content ul li {
			font-size: 16px; /* Adjust the font size as desired */
		}

			/* Adjust font size for the explanation paragraph */
		#explanation-content p {
			font-size: 20px; /* Adjust the font size as desired */
		}
		
		/* Adjust font size for the headings */
		#plots-tables-content ul li a {
			font-size: 20px; /* Adjust the font size as desired */
		}
		
		/* Adjust font size for the code block */
		#code-content pre code {
			font-size: 20px; /* Adjust the font size as desired */
		}
		
		/* Footer Styles */
		.footer {
		        background-color: #333;
		        color: #fff;
		        padding: 10px;
		        text-align: center;
		        position: fixed;
		        left: 0;
		        bottom: 0;
		        width: 100%;
		}

		
	</style>
	
</head>
<body>
	<header>
		<h1>R Code <br> For 4 Datasets (FC/FDR) </h1>
	</header>
	
	
	<h2 style="font-size: 28px; text-align: center;">1- Differential Expression Analysis of Breast Cancer Dataset (GSE25055) using limma in R: Comparing Molecular Subtypes and Grading System</h2>

	
	<hr>
	<h3 class="dropdown-trigger" onclick="toggleDropDown('explanation-content')">About this code</h3>
	<div class="drop-down-content" id="explanation-content" style="text-align: justify;">
		<p>I want to have a paragraph here to explain the analysis.</p>
	</div>
	<hr>

	
	<h3 class="dropdown-trigger" onclick="toggleDropDown('plots-tables-content')">Generated Plots & Tables:</h3>
	<div class="drop-down-content" id="plots-tables-content">
		<ul>
			<li><a href="#">Volcano plots for comparing grade 1 vs grade 3 (GSE25055 dataset)</a></li>
			<li><a href="#">Volcano plots for comparing Luminal A, Normal-like vs Luminal B, Basal-like, and HER2 (GSE25055 dataset)</a></li>
			<li><a href="#">Tables</a></li>
		</ul>
	</div>
	<hr>

	<h3 class="dropdown-trigger" onclick="toggleDropDown('code-content')">Code</h3>
	<div class="drop-down-content" id="code-content">
		<pre><code>
			<!--
			<span class="green-text">GREEN TEXTTTTTT</span> 
			<span class="purple-text">PURPLE TEXTTTTTT</span> 
			<span class="orange-text">ORANGE TEXTTTT</span> 
			<span class="dark-yellow-text">DARK YELLOW TEXTTT</span> 
			<span class="brown-text">BROWN TEXTTTT</span> 
			<span class="blue-text">BLUE TEXTTTTT</span> 
			<strong>BOLD TEXTTTTTT</strong> 
			-->
<span style="color: #04cc04; font-style: italic;"></span>
<span style="color: #07e307; font-style: italic;">2FUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTION</span>
<span style="color: #07f707; font-style: italic;">3FUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTION</span>
<span style="color: #05a105; font-style: italic;">4FUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTION</span>
<span style="color: #038003; font-style: italic;">5FUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTION</span>
<span style="color: #036303; font-style: italic;">6FUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTION</span>
<span style="color: #024d02; font-style: italic;">7FUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTION</span>
<span style="color: #1e611e; font-style: italic;">8FUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTION</span>
<span style="color: #298029; font-style: italic;">9FUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTION</span>
<span style="color: #369936; font-style: italic;">10FUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTION</span>
<span style="color: #42bd42; font-style: italic;">11FUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTION</span>
<span style="color: #53e053; font-style: italic;">12FUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTION</span>
<span style="color: #62f562; font-style: italic;">13FUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTION</span>
<span style="color: #6df26d; font-style: italic;">14FUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTION</span>
<span style="color: #0d8f50; font-style: italic;">15FUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTION</span>
<span style="color: #097a43; font-style: italic;">16FUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTIONFUNCTION</span>			

<span style="color: #999999; font-style: italic;"># Load the GEOquery library for accessing GEO data</span>			
require(GEOquery)
<span style="color: #999999; font-style: italic;"># Load the limma library for differential expression analysis	</span>		
require(limma)
<span style="color: #999999; font-style: italic;"># Load the tidyverse library, which includes several useful packages for data manipulation and visualization</span>		
require(tidyverse)
<span style="color: #999999; font-style: italic;"># Load the plotly library for interactive plots</span>			
require(plotly)
<span style="color: #999999; font-style: italic;"># Load the ggvenn library for creating Venn diagrams using ggplot2</span>			
require(ggvenn)
<span style="color: #999999; font-style: italic;"># Uncomment the line below if devtools package is not installed</span>
<span style="color: #999999; font-style: italic;"># if (!require(devtools)) install.packages("devtools")</span>
<span style="color: #999999; font-style: italic;"># devtools::install_github("yanlinlin82/ggvenn")</span>
require(ggvenn)

<span style="color: #999999; font-style: italic;"># Function to download the specified GEO dataset</span> 
DownloadGEO <- <span style="color: #53e053; font-style: italic;">function</span>(GSEname = <span style="color: #04cc04; font-style: italic;">"GSE11121"</span>) {
  <span style="color: #999999; font-style: italic;"># Create a folder for the dataset</span>
  dir.create(GSEname, showWarnings = <span style="color: #0548e8; font-style: italic;">FALSE</span>)
   
  <span style="color: #999999; font-style: italic;"># Increase memory allocation for efficient data processing</span>
  Sys.setenv(<span style="color: #04cc04; font-style: italic;">"VROOM_CONNECTION_SIZE"</span> = 131072 * 10)
  
  <span style="color: #999999; font-style: italic;"># Download the dataset from the GEO database</span>
  gset <- getGEO(GSEname, GSEMatrix = <span style="color: #0548e8; font-style: italic;">TRUE</span>, AnnotGPL = <span style="color: #0548e8; font-style: italic;">TRUE</span>,
                 destdir = paste0(getwd(), <span style="color: #04cc04; font-style: italic;"><span style="color: #04cc04; font-style: italic;">"/"</span></span>, GSEname))
  
  <span style="color: #999999; font-style: italic;"># Check if the dataset was successfully downloaded</span>
  <span style="color: #0548e8; font-style: italic;">if</span> (!is.null(gset)) {
    <span style="color: #999999; font-style: italic;"># Extract matrix data from the downloaded dataset</span>
    matrix <- gset[[paste0(GSEname, <span style="color: #04cc04; font-style: italic;">"_series_matrix.txt.gz"</span>)]]@assayData[[<span style="color: #04cc04; font-style: italic;">"exprs"</span>]]
    
    <span style="color: #999999; font-style: italic;"><strong># Perform log2 transformation if the matrix is not already transformed</strong></span>
    <span style="color: #999999; font-style: italic;"># Determine if log2 transformation is required based on the quantiles of the matrix values</span>
    qx <- as.numeric(quantile(matrix, c(0., 0.25, 0.5, 0.75, 0.99, 1.0), na.rm = <span style="color: #0548e8; font-style: italic;">TRUE</span>))
    LogC <- (qx[5] > 100) || (qx[6] - qx[1] > 50 && qx[2] > 0)
    
    <span style="color: #999999; font-style: italic;"># Check if log2 transformation is required</span>
    <span style="color: #0548e8; font-style: italic;">if</span> (LogC) {
      <span style="color: #999999; font-style: italic;"># Replace non-positive values with NA</span>
      matrix[matrix <= 0] <- <span style="color: #0548e8; font-style: italic;">NA</span>
      <span style="color: #999999; font-style: italic;"># Perform log2 transformation on the matrix</span>
      matrix <- log2(matrix)
    }
    
    <span style="color: #999999; font-style: italic;"><strong># Add row names to the matrix:</strong></span>
    <span style="color: #999999; font-style: italic;"># Add row names as the first column of the matrix using cbind()</span>
    matrix <- cbind(rownames(matrix), matrix)
    <span style="color: #999999; font-style: italic;"># Set the column name of the first column as "ID" using colnames()</span>
    colnames(matrix)[1] <- <span style="color: #04cc04; font-style: italic;">"ID"</span>
    
    <span style="color: #999999; font-style: italic;"><strong># Extract phenotype information from the dataset:</strong></span>
    <span style="color: #999999; font-style: italic;"># Extract the phenotype information from the dataset</span>
    phenotype <- gset[[paste0(GSEname, <span style="color: #04cc04; font-style: italic;">"_series_matrix.txt.gz"</span>)]]@phenoData@data  
    <span style="color: #999999; font-style: italic;"># Add row names as the first column of the phenotype data using cbind()</span>
    phenotype <- cbind(rownames(phenotype), phenotype)  
    <span style="color: #999999; font-style: italic;"># Set the column name of the first column as "ID" using colnames()</span>
    colnames(phenotype)[1] <- <span style="color: #04cc04; font-style: italic;">"ID" </span> 
    
    <span style="color: #999999; font-style: italic;"># Extract annotation information from the dataset</span>
    annot <- gset[[paste0(GSEname, <span style="color: #04cc04; font-style: italic;">"_series_matrix.txt.gz"</span>)]]@featureData@data
    
    <span style="color: #999999; font-style: italic;"><strong># Write the extracted variables to files:</strong></span>
    <span style="color: #999999; font-style: italic;"># Write the 'matrix' variable to a CSV file</span>
    write.csv(matrix, paste0(GSEname, <span style="color: #04cc04; font-style: italic;">"/"</span>, <span style="color: #04cc04; font-style: italic;">"matrix.csv"</span>), quote = <span style="color: #0548e8; font-style: italic;">FALSE</span>, row.names = <span style="color: #0548e8; font-style: italic;">FALSE</span>)
    <span style="color: #999999; font-style: italic;"># Write the 'phenotype' variable to a TSV file</span>
    write_tsv(phenotype, paste0(GSEname, <span style="color: #04cc04; font-style: italic;">"/"</span>, "phenotype.tsv"))
    <span style="color: #999999; font-style: italic;"># Write the 'annot' variable to a TSV file</span>
    write_tsv(annot, paste0(GSEname, <span style="color: #04cc04; font-style: italic;">"/"</span>, "annot.tsv"))
    
    <span style="color: #999999; font-style: italic;"># Remove unnecessary variables to free up memory</span>
    rm(gset, matrix, phenotype, annot)

    <span style="color: #999999; font-style: italic;"># Display a completion message</span>
    message("+++++ Dataset is ready to be analyzed. +++++")
  }
}


<span style="color: #999999; font-style: italic;"># Function to perform differential expression analysis on the specified GEO dataset.</span>
DEGanalysis <- <span style="color: #0548e8; font-style: italic;">function</span>(projname,
                        compare = "subtype",
                        groups,
                        adjust = "fdr") {
  <span style="color: #999999; font-style: italic;"><strong># Reading the files:</strong></span>
  <span style="color: #999999; font-style: italic;"># Read the matrix file and store it in a variable</span>
  matrix <- read_csv(paste0(projname, <span style="color: #04cc04; font-style: italic;">"/"</span>, "matrix.csv"), )
  <span style="color: #999999; font-style: italic;"># Convert the matrix into a data frame</span>
  matrix <- data.frame(matrix)
  <span style="color: #999999; font-style: italic;"># Set row names of the matrix</span>
  rownames(matrix) <- matrix[, 1]
  <span style="color: #999999; font-style: italic;"># Remove the first column of the matrix</span>
  matrix <- matrix[, -1]
  
  <span style="color: #999999; font-style: italic;"># Read the phenotype file and store it in a variable</span>
  phenotype <- read_tsv(paste0(projname, <span style="color: #04cc04; font-style: italic;">"/"</span>, "phenotype.tsv"))
  <span style="color: #999999; font-style: italic;"># Convert the phenotype into a data frame</span>
  phenotype <- data.frame(phenotype)
  <span style="color: #999999; font-style: italic;"># Set row names of the phenotype</span>
  rownames(phenotype) <- phenotype[, 1]
  <span style="color: #999999; font-style: italic;"># Remove the first column of the phenotype</span>
  phenotype <- phenotype[, -1]
  
  <span style="color: #999999; font-style: italic;"># Read the annotation file and store it in a variable</span>
  annot <- read_tsv(paste0(projname, <span style="color: #04cc04; font-style: italic;">"/"</span>, "annot.tsv"))
  <span style="color: #999999; font-style: italic;"># Convert the annotation into a data frame</span>
  annot <- data.frame(annot)
  <span style="color: #999999; font-style: italic;"># Set row names of the annotation</span>
  rownames(annot) <- annot[, 1]
  <span style="color: #999999; font-style: italic;"># Remove the first column of the annotation</span>
  annot <- annot[, -1]
  
  <span style="color: #999999; font-style: italic;"># Extract sample IDs based on user-specified groups for differential analysis</span>
  <span style="color: #0548e8; font-style: italic;">if</span> (compare == "subtype") {
    
    <span style="color: #999999; font-style: italic;"># Preparing the breast cancer subtype</span>
    phecoln <- grep("pam50", phenotype)
    <span style="color: #0548e8; font-style: italic;">if</span> (length(phecoln) > 0) {
      <span style="color: #999999; font-style: italic;"># Prepare breast cancer subtypes into a dataframe</span>
      pheno <- data.frame(phenotype[, phecoln])
      <span style="color: #999999; font-style: italic;"># Extract relevant columns from the phenotype file for breast cancer subtypes and rename them</span>
      colnames(pheno) <- "subtype"
      pheno$subtype <- gsub("pam50.+:", "", pheno$subtype)
      rownames(pheno) <- rownames(phenotype)
      <span style="color: #999999; font-style: italic;"># Store the extracted subtypes in a list, grouped by user-specified group names</span>
      grouplis <- list()
      <span style="color: #999999; font-style: italic;"># Iterate over each group specified by the user</span>
      <span style="color: #0548e8; font-style: italic;">for</span> (i <span style="color: #0548e8; font-style: italic;">in</span> seq_along(groups)) {
        <span style="color: #999999; font-style: italic;"># Create a regular expression pattern by concatenating group elements with a "|"</span>
        name <- paste0(groups[[i]], collapse = "|")
        <span style="color: #999999; font-style: italic;"># Find the row numbers in the "subtype" column of the phenotype data that match the pattern</span>
        rownum <- grep(name, pheno$subtype)
        <span style="color: #999999; font-style: italic;"># Store the row names corresponding to the matched rows in the grouplis list</span>
        grouplis[[names(groups)[i]]] <- rownames(pheno)[rownum]
      }
    }
  } <span style="color: #0548e8; font-style: italic;">else</span> {
    
    <span style="color: #999999; font-style: italic;"><strong># Preparing the breast cancer grades:</strong></span>
    <span style="color: #999999; font-style: italic;"># Find columns containing "grade:" in the 'phenotype' data frame</span>
    gradecoln <- grep("grade:", phenotype)
    
    <span style="color: #999999; font-style: italic;"># Check if there are any columns with "grade:" found</span>
    <span style="color: #0548e8; font-style: italic;">if</span> (length(gradecoln) > 0) {
      <span style="color: #999999; font-style: italic;"># Prepare breast cancer grades into a dataframe</span>
      grade <- data.frame(phenotype[, gradecoln])
      
      <span style="color: #999999; font-style: italic;"><strong># Extract relevant columns from phenotype file for breast cancer grades and rename them:</strong></span>
      <span style="color: #999999; font-style: italic;"># Rename the column in 'grade' data frame to "grade"</span>
      colnames(grade) <- "grade"
      <span style="color: #999999; font-style: italic;"># Remove unwanted text patterns from the 'grade' column using regular expressions</span>
      grade$grade <- gsub("grade:|grade: |B-R grade: ", "", grade$grade)
      grade$grade <- gsub("=.+", "", grade$grade)
      
      <span style="color: #999999; font-style: italic;"># Identify rows containing the pattern "III" in the 'grade' column</span>
      greek <- grep("III", grade$grade)
      <span style="color: #0548e8; font-style: italic;">if</span> (length(greek) > 0) {
        
        <span style="color: #999999; font-style: italic;"><strong># Convert grade names to numeric values:</strong></span>
        <span style="color: #999999; font-style: italic;"># Identify rows with grade "I"</span>
        one <- which(factor(grade$grade) == "I")
        <span style="color: #999999; font-style: italic;"># Identify rows with grade "II"</span>
        two <- which(factor(grade$grade) == "II")
        <span style="color: #999999; font-style: italic;"># Identify rows with grade "III"</span>
        three <- which(factor(grade$grade) == "III")
        
        <span style="color: #999999; font-style: italic;"># Convert grade values to numeric: "I" -> 1, "II" -> 2, "III" -> 3</span>
        grade[one, ] <- "1"
        grade[two, ] <- "2"
        grade[three, ] <- "3"
      }
      
      <span style="color: #999999; font-style: italic;"># Set row names of 'grade' data frame to row names of 'phenotype'</span>
      rownames(grade) <- rownames(phenotype)
      
      <span style="color: #999999; font-style: italic;"># Store the extracted grades in a list, grouped by user-specified group names</span>
      grouplis <- list()
      <span style="color: #0548e8; font-style: italic;">for</span> (i <span style="color: #0548e8; font-style: italic;">in</span> seq_along(groups)) {
        <span style="color: #999999; font-style: italic;"># Generate a group name by collapsing the elements of 'groups' with "|"</span>
        name <- paste0(groups[[i]], collapse = "|")
        <span style="color: #999999; font-style: italic;"># Find the row numbers in 'grade' where the group name is present in the 'grade' column</span>
        rownum <- grep(name, grade$grade)
        <span style="color: #999999; font-style: italic;"># Store the corresponding row names in the 'grouplis' list under the appropriate group name</span>
        grouplis[[names(groups)[i]]] <- rownames(grade)[rownum]
      }
    }
  }
  
  <span style="color: #999999; font-style: italic;"><strong># Rename the matrix file according to the groups name specified by the user:</strong></span>
  <span style="color: #999999; font-style: italic;"># Iterate over each group in grouplis</span>		
  <span style="color: #0548e8; font-style: italic;">for</span> (i <span style="color: #0548e8; font-style: italic;">in</span> seq_along(grouplis)) {
    <span style="color: #999999; font-style: italic;"># Generate a group name by collapsing the elements of 'grouplis[[i]]' with "|"</span>
    matname <- paste0(grouplis[[i]], collapse = "|")
    <span style="color: #999999; font-style: italic;"># Find the column numbers in 'matrix' where the group name is present in the column names</span>
    matcoln <- grep(matname, colnames(matrix))
    <span style="color: #999999; font-style: italic;"># Rename the columns of 'matrix' with the group name followed by a numeric index</span>
    colnames(matrix)[matcoln] <- paste0(names(grouplis)[i], 1:length(grouplis[[i]]))
  }
   
  <span style="color: #999999; font-style: italic;"><strong># Keep only the renamed samples in the matrix and order them:</strong></span>
  <span style="color: #999999; font-style: italic;"># Subset and reorder the 'matrix' data frame based on the group names</span>
  matnames <- grep(paste0(names(grouplis), collapse = "|"), colnames(matrix))
  <span style="color: #999999; font-style: italic;"># Subset the 'matrix' data frame to include only the columns corresponding to the renamed samples</span>
  matrix <- matrix[, matnames]
  <span style="color: #999999; font-style: italic;"># Reorder the columns of the 'matrix' data frame based on the column names</span>
  matrix <- matrix[, order(colnames(matrix))]
  
  <span style="color: #999999; font-style: italic;"><strong># Creating a factor of 0 and 1 according to the length of groups specified by the user:</strong></span>
  <span style="color: #999999; font-style: italic;"># Create an empty list to store the factors</span>
  gname <- list()
  <span style="color: #999999; font-style: italic;"># Iterate over each group in grouplis</span>
  <span style="color: #0548e8; font-style: italic;">for</span> (i <span style="color: #0548e8; font-style: italic;">in</span> seq_along(grouplis)) {
    <span style="color: #999999; font-style: italic;"># Count the number of columns in matrix corresponding to the group</span>
    number <- length(grep(names(grouplis)[i], colnames(matrix)))
    <span style="color: #999999; font-style: italic;"># Create a factor variable with values i - 1 repeated number times</span>
    gname[[i]] <- factor(rep(i - 1, number))
  }
  <span style="color: #999999; font-style: italic;"># Convert the list of factors to a single vector</span>
  grouping <- unlist(gname)
  
  <span style="color: #999999; font-style: italic;"><strong># Create a design matrix for the linear model:</strong></span>
  <span style="color: #999999; font-style: italic;"># Create a design matrix with the factor variables as predictors</span>
  design <- model.matrix(~ 0 + grouping)
  <span style="color: #999999; font-style: italic;"># Assign column names to the design matrix based on the group names</span>
  colnames(design) <- names(grouplis)
  
  <span style="color: #999999; font-style: italic;"><strong># Fit the linear model to the data:</strong></span>
  <span style="color: #999999; font-style: italic;"># Fit the linear model using the matrix and design matrix</span>
  fit1 <- lmFit(matrix, design)
  <span style="color: #999999; font-style: italic;"># Get the number of group names</span>
  l <- length(names(grouplis))
  <span style="color: #999999; font-style: italic;"># Create a string representation of group names for contrasts</span>
  cts <- paste0(names(grouplis)[l:1], collapse = "-")
  <span style="color: #999999; font-style: italic;"># Create contrasts for pairwise comparisons of groups</span>
  cont.matrix <- makeContrasts(contrasts = cts, levels = design)
  <span style="color: #999999; font-style: italic;"># Fit the contrasts to the model</span>
  fit2 <- contrasts.fit(fit1, cont.matrix)
  <span style="color: #999999; font-style: italic;"># Perform empirical Bayes moderation on the fitted model</span>
  fit2 <- eBayes(fit2)
  
  <span style="color: #999999; font-style: italic;"># Generate a top table of differentially expressed genes</span>
  DEGs <- topTable(fit2, adjust = adjust, number = <span style="color: #0548e8; font-style: italic;">Inf</span>)
  <span style="color: #999999; font-style: italic;"># Add row names as a separate column in the DEGs table</span>
  DEGs <- cbind(rownames(DEGs), DEGs)
  <span style="color: #999999; font-style: italic;"># Rename the first column as "ID"</span>
  colnames(DEGs)[1] <- "ID"
  
  <span style="color: #999999; font-style: italic;"><strong># Preparing the annotation variable:</strong></span>
  <span style="color: #999999; font-style: italic;"># Extract relevant columns from the 'annot' data frame</span>
  annotation <- annot[, c("Gene.symbol", "Chromosome.location", "GO.Function")]
  <span style="color: #999999; font-style: italic;"># Add row names as a separate column in the 'annotation' data frame</span>
  annotation <- cbind(rownames(annotation), annotation)
  <span style="color: #999999; font-style: italic;"># Rename the first column as "ID"</span>
  colnames(annotation)[1] <- "ID"
  
  <span style="color: #999999; font-style: italic;"><strong># Making sure that both DEGs and annotation row names are the same:</strong></span>
  <span style="color: #999999; font-style: italic;"># Sort the 'annotation' data frame by the "ID" column</span>
  annotation <- annotation[order(annotation$ID), ]
  <span style="color: #999999; font-style: italic;"># Sort the 'DEGs' data frame by the "ID" column</span>
  DEGs <- DEGs[order(DEGs$ID), ]
  
  <span style="color: #999999; font-style: italic;"># Merge the top table with the annotation data </span>
  DEGs <- cbind(DEGs, annotation[, c(2, 3, 4)])
  
  <span style="color: #999999; font-style: italic;"><strong># Removing missing gene symbols:</strong></span>
  <span style="color: #999999; font-style: italic;"># Find the indices of rows with missing gene symbols</span>
  genemissing <- which(is.na(DEGs$Gene.symbol) == <span style="color: #0548e8; font-style: italic;">TRUE</span>)
  <span style="color: #999999; font-style: italic;"># Remove the rows with missing gene symbols from the 'DEGs' data frame</span>
  DEGs <- DEGs[-genemissing, ]
  
  <span style="color: #999999; font-style: italic;"># Write the resulting top table to a file</span>
  write_tsv(DEGs, paste0(projname, <span style="color: #04cc04; font-style: italic;">"/"</span>, "DEGs.tsv"))
  
  <span style="color: #999999; font-style: italic;"># Display a completion message</span>
  message("+++++ Analysis has completed. +++++")
}



<span style="color: #999999; font-style: italic;"># Function to generates volcano plots for the specified GEO datasets.</span>
Makevolcano <- <span style="color: #0548e8; font-style: italic;">function</span>(projname,
                        padjlevel = 0.05,
                        uplogFC = 1,
                        downlogFC = -1,
                        ntop = 10,
                        voltype = "plotly") {
  <span style="color: #999999; font-style: italic;"># Read the tab-separated DEGs file into a data frame</span>
  table <- read_tsv(paste0(projname, <span style="color: #04cc04; font-style: italic;">"/"</span>, "DEGs.tsv"))
  table <- data.frame(table)
  
  <span style="color: #999999; font-style: italic;"># Define a vector of color codes</span>
  my_pal <- c("#1B9E77","#7570B3", "#E7298A", "#66A61E", "#E6AB02", "#A6761D", "#666666", "#9A7D0A")
  
  <span style="color: #999999; font-style: italic;"><strong># Add DEG column based on the value of adj.P.Val and logFC:</strong></span>
  volcano <- table %>%
    <span style="color: #999999; font-style: italic;"># Calculate AdjustedPvalue as the negative logarithm (base 10) of adj.P.Val</span>
    mutate(AdjustedPvalue = -log10(adj.P.Val)) %>%
    <span style="color: #999999; font-style: italic;"># Initialize DEG column with "Non-Significant" for all rows</span>
    mutate(DEG = "NotSignificant") %>%
    <span style="color: #999999; font-style: italic;"># Update DEG based on conditions for upregulation</span>
    mutate(DEG = ifelse(AdjustedPvalue > -log10(padjlevel) & logFC > uplogFC, "Upregulated", DEG)) %>%
    <span style="color: #999999; font-style: italic;"># Update DEG based on conditions for downregulation</span>
    mutate(DEG = ifelse(AdjustedPvalue > -log10(padjlevel) & logFC < downlogFC, "Downregulated", DEG))
  
  <span style="color: #999999; font-style: italic;"><strong># Separate the DEGs into three categories: Upregulated, Downregulated, Non-Significant:</strong></span>
  <span style="color: #999999; font-style: italic;"># Subset the 'volcano' data frame to select only the rows where the 'DEG' column is equal to "Upregulated".</span>
  volcano_up <- volcano[which(volcano$DEG == "Upregulated"), ]
  <span style="color: #999999; font-style: italic;"># Sort the 'volcano_up' data frame in descending order based on the 'logFC' column.</span>
  volcano_up <- volcano_up[order(volcano_up$logFC, decreasing = T), ]
  <span style="color: #999999; font-style: italic;"># Subset the 'volcano' data frame to select only the rows where the 'DEG' column is equal to "Downregulated".</span>
  volcano_down <- volcano[which(volcano$DEG == "Downregulated"), ]
  <span style="color: #999999; font-style: italic;"># Sort the 'volcano_down' data frame in ascending order based on the 'logFC' column.</span>
  volcano_down <- volcano_down[order(volcano_down$logFC, decreasing = F), ]
  <span style="color: #999999; font-style: italic;"># Subset the 'volcano' data frame to select only the rows where the 'DEG' column is equal to "Non-Significant".</span>
  volcano_NA <- volcano[which(volcano$DEG == "NotSignificant"), ]
  
  <span style="color: #999999; font-style: italic;"><strong># Combine the DEGs into a single data frame:</strong></span>
  <span style="color: #999999; font-style: italic;"># Combine the 'volcano_up', 'volcano_down', and 'volcano_NA' data frames vertically using the 'rbind' function.</span>
  volcano_all <- rbind(volcano_up, volcano_down, volcano_NA)
  
  <span style="color: #999999; font-style: italic;"><strong># Replace the top probes with the word "Top" in the DEGs column:</strong></span>
  <span style="color: #999999; font-style: italic;"># Create a vector 'ntop_rep' with length 'ntop' where each element is "Top".</span>
  ntop_rep <- rep("Top", ntop)
  <span style="color: #999999; font-style: italic;"># Create a new column 'DEGs' in the 'volcano_all' data frame.</span>
  volcano_all$DEGs <- c(ntop_rep, volcano_up$DEG[-c(1:ntop)], ntop_rep, volcano_down$DEG[-c(1:ntop)], volcano_NA$DEG)
  
  <span style="color: #999999; font-style: italic;"><strong># Label only top genes:</strong></span>
  <span style="color: #999999; font-style: italic;"># Assign the gene symbol as a label for top genes</span>
  volcano_all$Top <- ifelse(volcano_all$DEGs == "Top", volcano_all$Gene.symbol, "")
  
  <span style="color: #999999; font-style: italic;"># Plotting either with plotly or ggplot</span>
  <span style="color: #0548e8; font-style: italic;">if</span> (voltype == "plotly") {
    <span style="color: #999999; font-style: italic;"># Create a ggplot object with layers and annotations</span>
    p <- ggplot(data = volcano_all, aes(x = logFC, y = AdjustedPvalue, color = DEGs, fill = DEGs, text = paste("ID: ", ID,
													       <span style="color: #999999; font-style: italic;"># Tooltip text for gene symbol</span>
	                                                                                                       "&lt;br&gt; Gene: ", Gene.symbol,
	                                                                                                       <span style="color: #999999; font-style: italic;"># Tooltip text for chromosome location</span>
	                                                                                                       "&lt;br&gt; Chromosome: ", Chromosome.location,
	                                                                                                       <span style="color: #999999; font-style: italic;"># Tooltip text for GO function</span>
	                                                                                                       "&lt;br&gt; GO function: ", GO.Function))) +
      <span style="color: #999999; font-style: italic;"># Set the x-axis label, y-axis label, and plot title</span>
      labs(x = 'log2 (Fold Change)', y = "-log10(Adjusted P-value)", title = paste0("Volcano plot-", projname)) +
      <span style="color: #999999; font-style: italic;"># Add points to the plot with specified size and shape</span>
      geom_point(size = 1, shape = 21) +
      <span style="color: #999999; font-style: italic;"># Set the color scale of the plot manually</span>
      scale_color_manual(values = c(my_pal)) +
      <span style="color: #999999; font-style: italic;"># Set the fill color scale of the plot manually</span>
      scale_fill_manual(values = c(paste(my_pal, "66", sep = ""))) +
      <span style="color: #999999; font-style: italic;"># Apply the "classic" theme to the plot</span>
      theme_classic() +
      <span style="color: #999999; font-style: italic;"># Set axis text font and size</span>
      theme(axis.text = element_text(family = "Arial", size = 24, colour = "black"),
            <span style="color: #999999; font-style: italic;"># Set x-axis text color and size</span>
            axis.text.x = element_text(family = "Arial", colour = "black", size = 24),
            <span style="color: #999999; font-style: italic;"># Set y-axis text color and size</span>
            axis.text.y = element_text(family = "Arial", colour = "black", size = 24),
            <span style="color: #999999; font-style: italic;"># Set subtitle font, size, and color</span>
            plot.subtitle = element_text(family = "Arial", size = 24, colour = "black", hjust = 0.5),
            <span style="color: #999999; font-style: italic;"># Set y-axis title font, size, and angle</span>
            axis.title.y = element_text(family = "Arial", size = 24, angle = 90),
            <span style="color: #999999; font-style: italic;"># Set x-axis title font, size, and angle</span>
            axis.title.x = element_text(family = "Arial", size = 24, angle = 00))
    
    <span style="color: #999999; font-style: italic;"># Convert ggplot object to plotly object and customize layout</span>
    p <- ggplotly(p, tooltip = "text") %>%
      <span style="color: #999999; font-style: italic;"># Set the title of the plot</span>
      layout(title = paste0("Volcano plot-", projname),
             <span style="color: #999999; font-style: italic;"># Customize font properties</span>
             font = list(family = "Arial", color = "black", size = 24),
             <span style="color: #999999; font-style: italic;"># Customize legend properties</span>
             legend = list(family = "Arial", color = "black", size = 20, itemclick = "toggle"))
  } <span style="color: #0548e8; font-style: italic;">else</span> {
    <span style="color: #999999; font-style: italic;"># Create a ggplot object with layers and annotations:</span>
    p <- ggplot(data = volcano_all, aes(x = logFC, y = AdjustedPvalue, color = DEGs, fill = DEGs, label = Top)) + 
      <span style="color: #999999; font-style: italic;"># Set the labels for x and y axes</span>
      labs(x = 'log2 (Fold Change)', y = "-log10(Adjusted P-value)") +
      <span style="color: #999999; font-style: italic;"># Add points to the plot</span>
      geom_point(size = 1, shape = 21) +
      <span style="color: #999999; font-style: italic;"># Add text annotations to the plot</span>
      geom_text(check_overlap = F, vjust = 0.1, nudge_y = 0.4) +
      <span style="color: #999999; font-style: italic;"># Set manual color scale for DEGs</span>
      scale_color_manual(values = c(my_pal)) +
      <span style="color: #999999; font-style: italic;"># Set manual fill scale for DEGs</span>
      scale_fill_manual(values = c(paste(my_pal, "66", sep = ""))) +
      <span style="color: #999999; font-style: italic;"># Use classic theme for the plot</span>
      theme_classic() +
      
      theme(
        <span style="color: #999999; font-style: italic;"># Customize axis text properties</span>
        axis.text = element_text(family = "Arial", size = 24, colour = "black"),
        <span style="color: #999999; font-style: italic;"># Customize x-axis text properties</span>    
        axis.text.x = element_text(family = "Arial", colour = "black", size = 24),
        <span style="color: #999999; font-style: italic;"># Customize y-axis text properties</span>    
        axis.text.y = element_text(family = "Arial", colour = "black", size = 24),
        <span style="color: #999999; font-style: italic;"># Customize subtitle text properties</span>    
        plot.subtitle = element_text(family = "Arial", size = 24, colour = "black", hjust = 0.5),
        <span style="color: #999999; font-style: italic;"># Customize y-axis title properties</span>    
        axis.title.y = element_text(family = "Arial", size = 24, angle = 90),
        <span style="color: #999999; font-style: italic;"># Customize x-axis title properties </span>   
        axis.title.x = element_text(family = "Arial", size = 24, angle = 00),
        <span style="color: #999999; font-style: italic;"># Customize legend text properties</span>    
        legend.text = element_text(size = 10, family = "Arial"), 
        <span style="color: #999999; font-style: italic;"># Customize legend title properties</span>    
        legend.title = element_text(size = 20, family = "Arial")
      ) +
      <span style="color: #999999; font-style: italic;"># Set the subtitle of the plot</span>
      labs(subtitle = paste0("Volcano plot-", projname))
  }
  
  <span style="color: #999999; font-style: italic;"><strong># Calculate the number of up-regulated and down-regulated genes:</strong></span>
  <span style="color: #999999; font-style: italic;"># Write the up-regulated and down-regulated genes to a TSV file</span>
  write_tsv(rbind(volcano_up, volcano_down), paste0(projname, <span style="color: #04cc04; font-style: italic;">"/"</span>, "all_top_down.tsv"))
  
  <span style="color: #999999; font-style: italic;"># Create the top table containing the top up-regulated and down-regulated genes</span>
  top <- rbind(volcano_up[1:ntop, ], volcano_down[1:ntop, ])
  <span style="color: #999999; font-style: italic;"># Reorder columns in the top table</span>
  top <- top[, c(1:6, 11, 7, 8, 9, 10, 12)]
  <span style="color: #999999; font-style: italic;"># Rename the 7th column as "n.log10(adj.P.Val)"</span>
  colnames(top)[7] <- "n.log10(adj.P.Val)"
  
  <span style="color: #999999; font-style: italic;"># Save the top table as a CSV file in the project folder</span>
  write.csv(top, paste0(projname, <span style="color: #04cc04; font-style: italic;">"/"</span>, "top.csv"), quote = <span style="color: #0548e8; font-style: italic;">FALSE</span>, row.names = <span style="color: #0548e8; font-style: italic;">FALSE</span>)
  
  <span style="color: #999999; font-style: italic;"># Display the number of up-regulated and down-regulated genes</span>
  message(sprintf("Up-regulated genes: %s; Down-regulated genes: %s", nrow(volcano_up), nrow(volcano_down)))
  
  <span style="color: #999999; font-style: italic;"># Return the generated plot</span>
  return(p)
}


<span style="color: #999999; font-style: italic;"># Function to creates a Venn diagram to visualize common differentially expressed genes among specified GEO datasets.</span>
MakeVenna <- <span style="color: #0548e8; font-style: italic;">function</span>(common, ntop = 10) {
  
  <span style="color: #999999; font-style: italic;"># Create a directory to store the output files</span>
  dir.create("common", showWarnings = <span style="color: #0548e8; font-style: italic;">FALSE</span>)
  
  <span style="color: #999999; font-style: italic;"># Reading all all_top_down files and processing them</span>
  com_table <- list()
  
  <span style="color: #999999; font-style: italic;"># Process each dataset</span>
  <span style="color: #0548e8; font-style: italic;">for</span> (i <span style="color: #0548e8; font-style: italic;">in</span> seq_along(common)) {
    <span style="color: #999999; font-style: italic;"># Read the all_top_down file for the current dataset</span>
    DEG_table <- data.frame(read_tsv(paste0(common[i], <span style="color: #04cc04; font-style: italic;">"/"</span>, "all_top_down.tsv")))
    
    <span style="color: #999999; font-style: italic;"># Finding duplicated genes</span>
    <span style="color: #999999; font-style: italic;"># Find the indices of duplicated genes</span>
    dup_genes_n <- which(duplicated(DEG_table$Gene.symbol))
    <span style="color: #999999; font-style: italic;"># Get unique duplicated genes</span>
    dup_uniq_genes <- unique(DEG_table[dup_genes_n, "Gene.symbol"])
    <span style="color: #999999; font-style: italic;"># Find the indices of all duplicated genes</span>
    find_dup <- which(DEG_table$Gene.symbol %in% dup_uniq_genes)
    <span style="color: #999999; font-style: italic;"># Extract all duplicated genes</span>
    all_dup <- DEG_table[find_dup, ]
    <span style="color: #999999; font-style: italic;"># Remove duplicated genes from the DEG table</span>
    DEG_table <- DEG_table[-find_dup, -11]
    
    <span style="color: #999999; font-style: italic;"># Calculation the mean for logFC/AveExpr/t value/P-value/adjusted P-value/B value of duplicated genes</span>
    uniq_genes_list <- list()
    
    <span style="color: #999999; font-style: italic;"># Process each duplicated gene</span>
    <span style="color: #999999; font-style: italic;">for</span> (j <span style="color: #0548e8; font-style: italic;">in</span> seq_along(dup_uniq_genes)) {
      <span style="color: #999999; font-style: italic;"># Find the indices of the current duplicated gene</span>
      c <- which(all_dup$Gene.symbol %in% dup_uniq_genes[j])
      <span style="color: #999999; font-style: italic;"># Calculate the mean logFC</span>
      b <- c(mean(all_dup$logFC[c]),
             <span style="color: #999999; font-style: italic;"># Calculate the mean AveExpr</span>
             mean(all_dup$AveExpr[c]),
             <span style="color: #999999; font-style: italic;"># Calculate the mean t value</span>
             mean(all_dup$t[c]),
             <span style="color: #999999; font-style: italic;"># Calculate the mean P-value</span>
             mean(all_dup$P.Value[c]),
             <span style="color: #999999; font-style: italic;"># Calculate the mean adjusted P-value</span>
             mean(all_dup$adj.P.Val[c]),
             <span style="color: #999999; font-style: italic;"># Calculate the mean B value</span>
             mean(all_dup$B[c]))
      
      <span style="color: #999999; font-style: italic;"># Assign column names and create a new data frame with the mean values</span>
      <span style="color: #999999; font-style: italic;"># Assign column names to the mean values</span>
      names(b) <- c("logFC", "AveExpr", "t", "P.Value", "adj.P.Val", "B")
      <span style="color: #999999; font-style: italic;"># Create a new data frame with the mean values</span>
      d <- data.frame(c(all_dup[c[1], -c(2, 3, 4, 5, 6, 7, 11)], b))
      <span style="color: #999999; font-style: italic;"># Reorder the columns of the data frame</span>
      d <- d[, c(1, 6, 7, 8, 9, 10, 11, 2, 3, 4, 5)]
      <span style="color: #999999; font-style: italic;"># Store the data frame in the list for unique genes</span>
      uniq_genes_list[[j]] <- d
    }
    
    <span style="color: #999999; font-style: italic;"># Joining the mean calculated and unique genes with the rest of genes</span>
    <span style="color: #999999; font-style: italic;"># Combine the data frames in the list into one data frame</span>
    uniq_genes_df <- do.call(rbind, uniq_genes_list)
    <span style="color: #999999; font-style: italic;"># Append the unique genes data frame to the DEG_table</span>
    DEG_table <- rbind(DEG_table, uniq_genes_df)
    
    <span style="color: #999999; font-style: italic;"># Store the processed DEG table for the current dataset</span>
    com_table[[common[i]]] <- DEG_table
  }
  
  <span style="color: #999999; font-style: italic;"># Calculating up and down-regulated genes for each dataset</span>
  <span style="color: #999999; font-style: italic;"># Create an empty list to store the up and down-regulated genes</span>
  DEGslist <- list()
  
  <span style="color: #0548e8; font-style: italic;">for</span> (i <span style="color: #0548e8; font-style: italic;">in</span> seq_along(com_table)) {
    <span style="color: #999999; font-style: italic;"># Extract the 8th column (DEGs) and store it in the list</span>
    DEGslist[[common[i]]] <- com_table[[i]][8]
  }
  
  <span style="color: #999999; font-style: italic;"># Find common genes among all datasets</span>
  com_prob <- Reduce(intersect, DEGslist)
  
  <span style="color: #999999; font-style: italic;"># Writing all common genes into separated files as well as the top files</span>
  <span style="color: #999999; font-style: italic;"># Create an empty list to store all common genes</span>
  all_com <- list()
  <span style="color: #999999; font-style: italic;"># Create an empty list to store all common genes (including all samples)</span>
  all_com_all <- list()
  
  <span style="color: #0548e8; font-style: italic;">for</span> (i <span style="color: #0548e8; font-style: italic;">in</span> seq_along(com_table)) {
    <span style="color: #999999; font-style: italic;"># Extract the common differentially expressed genes for the current dataset</span>
    comn <- which(com_table[[names(com_table)[i]]][["Gene.symbol"]] %in% com_prob$Gene.symbol)
    <span style="color: #999999; font-style: italic;"># Subset the current dataset with the common DEGs</span>
    com_final_DEG  <- com_table[[names(com_table)[i]]][comn, ]
    <span style="color: #999999; font-style: italic;"># Sort the subsetted data frame based on the "DEG" column</span>
    com_final_DEG <- com_final_DEG[order(com_final_DEG$DEG), ]
    
    <span style="color: #999999; font-style: italic;"># Save the common differentially expressed genes as a TSV file</span>
    write_tsv(com_final_DEG, paste0("common", <span style="color: #04cc04; font-style: italic;">"/"</span>, names(com_table)[i], "_common_DEGs.tsv"))
    
    <span style="color: #999999; font-style: italic;"># Extract the top up-regulated genes for the current dataset</span>
    com_final_up <- com_final_DEG[which(com_final_DEG$DEG == "Upregulated"), ]
    <span style="color: #999999; font-style: italic;"># Sort the subsetted data frame based on the "logFC" column in decreasing order</span>
    com_final_up <- com_final_up[order(com_final_up$logFC, decreasing = <span style="color: #0548e8; font-style: italic;">TRUE</span>), ]
    
    <span style="color: #999999; font-style: italic;"># Extract the top down-regulated genes for the current dataset</span>
    com_final_down <- com_final_DEG[which(com_final_DEG$DEG == "Downregulated"), ]
    <span style="color: #999999; font-style: italic;"># Sort the subsetted data frame based on the "logFC" column in increasing order</span>
    com_final_down <- com_final_down[order(com_final_down$logFC, decreasing = <span style="color: #0548e8; font-style: italic;">FALSE</span>), ]
    
    <span style="color: #999999; font-style: italic;"># Save the top common differentially expressed genes as a TSV file</span>
    write_tsv(rbind(com_final_up[1:ntop, ], com_final_down[1:ntop, ]), paste0("common", "/", names(com_table)[i], "_top_common_DEGs.tsv"))
    
    <span style="color: #999999; font-style: italic;"># Store the common differentially expressed genes and all genes for each dataset</span>
    <span style="color: #999999; font-style: italic;"># Store the subsetted com_final_DEG data frame in all_com list</span>
    all_com[[names(com_table)[i]]] <- com_final_DEG[, c(2:7)]
    <span style="color: #999999; font-style: italic;"># Store the complete com_final_DEG data frame in all_com_all list</span>
    all_com_all[[names(com_table)[i]]] <- com_final_DEG
  }
  
  <span style="color: #999999; font-style: italic;"># Calculate the mean of logFC for all common genes in each dataset</span> 
  <span style="color: #999999; font-style: italic;"># Combine the data frames in all_com list into a single data frame, all_com_df</span>
  all_com_df <- do.call(cbind, all_com)
  <span style="color: #999999; font-style: italic;"># Find the column indices of columns containing "logFC" in their names</span>
  logfc_n <- grep("logFC", colnames(all_com_df))
  
  <span style="color: #999999; font-style: italic;"># Extract the columns containing logFC values from all_com_all_df</span>
  logfc_df <- all_com_df[, logfc_n]
  
  <span style="color: #999999; font-style: italic;"># Calculate the row means of logFC values to obtain the mean logFC for each common gene</span>
  logfc_df <- data.frame(logFC = rowMeans(logfc_df))
  
  <span style="color: #999999; font-style: italic;"># Extract columns containing adj.P.Val values from all_com_df:</span>
  <span style="color: #999999; font-style: italic;"># Find the column indices of columns containing "adj.P.Val" in their names</span>
  adj.P.Val_n <- grep("adj.P.Val", colnames(all_com_df))
  <span style="color: #999999; font-style: italic;"># Extract the columns containing adj.P.Val values</span>
  adj.P.Val_df <- all_com_df[, adj.P.Val_n]
  <span style="color: #999999; font-style: italic;"># Calculate the row means of adj.P.Val values to obtain the mean adj.P.Val for each common gene:</span>
  <span style="color: #999999; font-style: italic;"># Create a data frame with a single column "adj.P.Val" containing the mean adj.P.Val values</span>
  adj.P.Val_df <- data.frame(adj.P.Val = rowMeans(adj.P.Val_df))
  
  <span style="color: #999999; font-style: italic;"># Extract columns containing B values from all_com_df</span>
  B_n <- grep("B", colnames(all_com_df))
  B_df <- all_com_df[, B_n]
  <span style="color: #999999; font-style: italic;"># Calculate the row means of B values to obtain the mean B for each common gene</span>
  B_df <- data.frame(B = rowMeans(B_df))
  
  <span style="color: #999999; font-style: italic;"># Extract columns containing t values from all_com_df</span>
  t_n <- grep(".t", colnames(all_com_df))
  t_df <- all_com_df[, t_n]
  <span style="color: #999999; font-style: italic;"># Calculate the row means of t values to obtain the mean t for each common gene</span>
  t_df <- data.frame(t = rowMeans(t_df))
  
  <span style="color: #999999; font-style: italic;"># Extract columns containing P.Value values from all_com_df</span>
  P.Value_n <- grep("P.Value", colnames(all_com_df))
  P.Value_df <- all_com_df[, P.Value_n]
  <span style="color: #999999; font-style: italic;"># Calculate the row means of P.Value values to obtain the mean P.Value for each common gene</span>
  P.Value_df <- data.frame(P.Value = rowMeans(P.Value_df))
  
  <span style="color: #999999; font-style: italic;"># Extract columns containing AveExpr values from all_com_df:</span>
  <span style="color: #999999; font-style: italic;"># Find the column indices of columns containing "AveExpr" in their names</span>
  AveExpr_n <- grep("AveExpr", colnames(all_com_df))
  <span style="color: #999999; font-style: italic;"># Extract the columns containing AveExpr values</span>
  AveExpr_df <- all_com_df[, AveExpr_n]
  <span style="color: #999999; font-style: italic;"># Calculate the row means of AveExpr values to obtain the mean AveExpr for each common gene:</span>
  <span style="color: #999999; font-style: italic;"># Create a data frame with a single column "AveExpr" containing the mean AveExpr values</span>
  AveExpr_df <- data.frame(AveExpr = rowMeans(AveExpr_df))
  
  <span style="color: #999999; font-style: italic;"># Combining all calculated means into one data frame </span>
  all_com_all_df <- data.frame(do.call(cbind, all_com_all[[1]]))
  <span style="color: #999999; font-style: italic;"># Removing unnecessary columns from all_com_all_df</span>
  all_com_all_df <- all_com_all_df[, -c(2:7)]
  <span style="color: #999999; font-style: italic;"># Combining the calculated means with all_com_all_df</span>
  all_com_all_df <- cbind(all_com_all_df, logfc_df, adj.P.Val_df, B_df, t_df, AveExpr_df, P.Value_df)
  <span style="color: #999999; font-style: italic;"># Reordering the columns of all_com_all_df</span>
  all_com_all_df <- all_com_all_df[, c(1, 6, 10, 9, 11, 7, 8, 2, 3, 4, 5)]
  
  <span style="color: #999999; font-style: italic;"># Writing the combined data frame of all calculated means to a TSV file</span>
  write_tsv(all_com_all_df, paste0("common", <span style="color: #04cc04; font-style: italic;">"/"</span>, "all_mean_common_DEGs.tsv"))
  
  <span style="color: #999999; font-style: italic;"># Displaying a message to indicate that the common genes have been saved</span>
  message("+++++ Common genes between all datasets have been saved into the 'common' folder. +++++")
  
  <span style="color: #999999; font-style: italic;"># Creating a list of DEGs for each dataset to generate a Venn diagram</span>
  venlist <- list()
  <span style="color: #999999; font-style: italic;"># Iterating over the DEGslist to populate the venlist</span>
  <span style="color: #0548e8; font-style: italic;">for</span> (i <span style="color: #0548e8; font-style: italic;">in</span> seq_along(DEGslist)) {
    venlist[[common[i]]] <- DEGslist[[i]][[1]]
  }
  
  <span style="color: #999999; font-style: italic;"># Generate the Venn diagram using the logFC mean values for common genes</span>
  <span style="color: #999999; font-style: italic;"># Set the seed for random number generation</span>
  set.seed(1234)
  <span style="color: #999999; font-style: italic;"># Define color palette for the Venn diagram</span>
  my_pal <- c("#1B9E77", "#7570B3", "#E7298A", "#66A61E", "#E6AB02", "#A6761D", "#666666", "#9A7D0A")
  <span style="color: #999999; font-style: italic;"># Create the Venn diagram using ggvenn package</span>
  venaa <- ggvenn(venlist, 
                  fill_color = my_pal,
                  stroke_size = 0.5,
                  set_name_size = 4)
  
  <span style="color: #999999; font-style: italic;"># Return the generated Venn diagram</span>
  return(venaa)
}



<span style="color: #999999; font-style: italic;"># Function to prepares files for network analysis using the specified GEO datasets.</span>
Makenetworkanalyst <- <span style="color: #0548e8; font-style: italic;">function</span>(projname,
                               compare = "grade",
                               groups) {
  <span style="color: #999999; font-style: italic;"># Reading files</span>
  <span style="color: #999999; font-style: italic;"># Create 'networkanalyst' directory to store the output files</span>
  dir.create("networkanalyst", showWarnings = <span style="color: #0548e8; font-style: italic;">FALSE</span>)
  
  <span style="color: #999999; font-style: italic;"># Read the 'matrix.csv' file</span>
  matrix <- read_csv(paste0(projname, <span style="color: #04cc04; font-style: italic;">"/"</span>, "matrix.csv"))
  matrix <- data.frame(matrix)
  
  <span style="color: #999999; font-style: italic;"># Read the 'phenotype.tsv' file</span>
  phenotype <- read_tsv(paste0(projname, <span style="color: #04cc04; font-style: italic;">"/"</span>, "phenotype.tsv"))
  phenotype <- data.frame(phenotype)
  
  <span style="color: #999999; font-style: italic;"># Set the row names of the 'phenotype' dataframe</span>
  rownames(phenotype) <- phenotype[, 1]
  
  <span style="color: #999999; font-style: italic;"># Calculating DEGs:</span>
  <span style="color: #999999; font-style: italic;"># Read the 'all_top_down.tsv' file containing up and down genes</span>
  updown <- data.frame(read_tsv(paste0(projname, <span style="color: #04cc04; font-style: italic;">"/"</span>, "all_top_down.tsv")))
  
  <span style="color: #999999; font-style: italic;"># Creating a file that contains up and down genes based on groups specified:</span>
  
  <span style="color: #999999; font-style: italic;"># Identify the rows in 'matrix' corresponding to up and down genes</span>
  updown_genes <- which(matrix$ID %in% updown$ID)
  <span style="color: #999999; font-style: italic;"># Create a new matrix 'updown_matrix' containing the identified rows</span>
  updown_matrix <- matrix[updown_genes, ]
  
  <span style="color: #999999; font-style: italic;"># Add gene symbols to the 'updown_matrix' dataframe</span>
  updown_matrix <- cbind(updown$Gene.symbol, updown_matrix)
  <span style="color: #999999; font-style: italic;"># Rename the first column as "Symbol"</span>
  colnames(updown_matrix)[1] <- "Symbol"
  <span style="color: #999999; font-style: italic;"># Remove the second column from the dataframe</span>
  updown_matrix <- updown_matrix[, -2]
  
  <span style="color: #999999; font-style: italic;"># Extract the gene symbols from the 'updown_matrix' dataframe</span>
  genes <- updown_matrix$Symbol
  <span style="color: #999999; font-style: italic;"># Remove the first column (gene symbols) from 'updown_matrix', round the remaining expression values to 2 decimal places</span>
  updown_matrix <- round(updown_matrix[-1], 2)
  <span style="color: #999999; font-style: italic;"># Add the gene symbols column back to the 'updown_matrix' dataframe</span>
  updown_matrix <- cbind(genes, updown_matrix)
  
  <span style="color: #0548e8; font-style: italic;">if</span> (compare == "subtype") {
    <span style="color: #999999; font-style: italic;"># Prepare data based on subtype comparison</span>
    
    <span style="color: #999999; font-style: italic;"># Find the column index for 'pam50' in 'phenotype'</span>
    phecoln <- grep("pam50", phenotype)
    
    <span style="color: #999999; font-style: italic;"># Check if the length of 'phecoln' is greater than 0 (if there are subtype columns present in 'phenotype' dataframe.)</span>
    <span style="color: #0548e8; font-style: italic;">if</span> (length(phecoln) > 0) {
      <span style="color: #999999; font-style: italic;"># Extract the subtype column from 'phenotype'</span>
      pheno <- data.frame(phenotype[, phecoln])
      <span style="color: #999999; font-style: italic;"># Rename the column to "subtype"</span>
      colnames(pheno) <- "subtype"
      
      <span style="color: #999999; font-style: italic;"># Clean up the subtype values by removing the "pam50" prefix</span>
      pheno$subtype <- gsub("pam50.+:", "", pheno$subtype)
      <span style="color: #999999; font-style: italic;"># Assign the row names of 'phenotype' as the row names of 'pheno'</span>
      rownames(pheno) <- rownames(phenotype)
      
      <span style="color: #999999; font-style: italic;"># Creating groups of samples based on specified conditions:</span>
      <span style="color: #999999; font-style: italic;"># Create an empty list to store groups of samples</span>
      grouplis <- list()
      <span style="color: #0548e8; font-style: italic;">for</span> (i <span style="color: #0548e8; font-style: italic;">in</span> seq_along(groups)) {
        <span style="color: #999999; font-style: italic;"># Combine the group names using the '|' separator</span>
        name <- paste0(groups[[i]], collapse = "|")
        <span style="color: #999999; font-style: italic;"># Find the rows in 'pheno$subtype' that match the group name</span>
        rownum <- grep(name, pheno$subtype)
        <span style="color: #999999; font-style: italic;"># Store the matching row names in 'grouplis' with the group name as the key</span>
        grouplis[[names(groups)[i]]] <- rownames(pheno)[rownum]
      }
    }
  } <span style="color: #0548e8; font-style: italic;">else</span> {
    <span style="color: #999999; font-style: italic;"># Preparing the breast cancer grades into a dataframe:</span>
    <span style="color: #999999; font-style: italic;"># Find the column index containing "grade:" in the phenotype data</span>
    gradecoln <- grep("grade:", phenotype)
    <span style="color: #999999; font-style: italic;"># Check if any column contains "grade:"</span>
    <span style="color: #0548e8; font-style: italic;">if</span> (length(gradecoln) > 0) {
      <span style="color: #999999; font-style: italic;"># Extract the column with "grade:" and create a data frame</span>
      grade <- data.frame(phenotype[, gradecoln])
      <span style="color: #999999; font-style: italic;"># Rename the column to "grade"</span>
      colnames(grade) <- "grade"
      <span style="color: #999999; font-style: italic;"># Remove "grade:", "grade: ", and "B-R grade: " from the values in the column</span>
      grade$grade <- gsub("grade:|grade: |B-R grade: ", "", grade$grade)
      <span style="color: #999999; font-style: italic;"># Remove any characters after "=" in the values</span>
      grade$grade <- gsub("=.+", "", grade$grade)
      <span style="color: #999999; font-style: italic;"># Find the rows with "III" in the grade column</span>
      greek <- grep("III", grade$grade)
      <span style="color: #999999; font-style: italic;"># Check if any rows contain "III"</span>
      <span style="color: #0548e8; font-style: italic;">if</span> (length(greek) > 0) {
        <span style="color: #999999; font-style: italic;"># Find the rows with "I", "II", "III" in the grade column</span>
        one <- which(factor(grade$grade) == "I")
        two <- which(factor(grade$grade) == "II")
        three <- which(factor(grade$grade) == "III")
        <span style="color: #999999; font-style: italic;"># Replace the rows with "I" with "1"</span>
        grade[one, ] <- "1"
        <span style="color: #999999; font-style: italic;"># Replace the rows with "II" with "2"</span>
        grade[two, ] <- "2"
        <span style="color: #999999; font-style: italic;"># Replace the rows with "III" with "3"</span>
        grade[three, ] <- "3"
      }
      <span style="color: #999999; font-style: italic;"># Set the row names of the 'grade' data frame to match the row names of the 'phenotype' data frame</span>
      rownames(grade) <- rownames(phenotype)
      <span style="color: #999999; font-style: italic;"># Create an empty list to store the group information</span>
      grouplis <- list()
      <span style="color: #0548e8; font-style: italic;">for</span> (i <span style="color: #0548e8; font-style: italic;">in</span> seq_along(groups)) {
        <span style="color: #999999; font-style: italic;"># Concatenate the elements of 'groups' with a '|' separator</span>
        name <- paste0(groups[[i]], collapse = "|")
        <span style="color: #999999; font-style: italic;"># Find the rows in the 'grade' data frame where the 'grade' column matches the group name</span>
        rownum <- grep(name, grade$grade)
        <span style="color: #999999; font-style: italic;"># Store the row names corresponding to the group in the 'grouplis' list</span>
        grouplis[[names(groups)[i]]] <- rownames(grade)[rownum]
      }
    }
  }
  
  <span style="color: #999999; font-style: italic;"># Renaming the matrix file according to the groups name specified by the user:</span>
  <span style="color: #999999; font-style: italic;"># Bind the column names of 'updown_matrix' as the first row of 'updown_matrix'</span>
  updown_matrix <- rbind(colnames(updown_matrix), updown_matrix)
  <span style="color: #0548e8; font-style: italic;">for</span> (i <span style="color: #0548e8; font-style: italic;">in</span> seq_along(grouplis)) {
    <span style="color: #999999; font-style: italic;"># Concatenate the elements of 'grouplis[[i]]' with a '|' separator</span>
    matname <- paste0(grouplis[[i]], collapse = "|")
    <span style="color: #999999; font-style: italic;"># Find the columns in 'updown_matrix' that match the group name specified by 'matname'</span>
    matcoln <- grep(matname, colnames(updown_matrix))
    <span style="color: #999999; font-style: italic;"># Replace the corresponding columns in the first row of 'updown_matrix' with the group name</span>
    updown_matrix[1, matcoln] <- names(grouplis)[i]
  }
  
  <span style="color: #999999; font-style: italic;"># Adding column names and the second row according to the file for networkanalyst:</span>
  <span style="color: #999999; font-style: italic;"># Find the columns in the first row of 'updown_matrix' that match the names of 'grouplis'</span>
  changedcol <- grep(paste0(names(grouplis), collapse = "|"), updown_matrix[1, ])
  <span style="color: #999999; font-style: italic;"># Keep the first column and the columns selected by 'changedcol' in 'updown_matrix'</span>
  updown_matrix <- updown_matrix[, c(1, changedcol)]
  <span style="color: #999999; font-style: italic;"># Replace the first cell of 'updown_matrix' with "#CLASS"</span>
  updown_matrix[1, 1] <- "#CLASS"
  <span style="color: #999999; font-style: italic;"># Replace the column name of the first column in 'updown_matrix' with "#NAME"</span>
  colnames(updown_matrix)[1] <- "#NAME"
  
  <span style="color: #999999; font-style: italic;"># Write 'updown_matrix' to a tab-separated file</span>
  write.table(updown_matrix, paste0("networkanalyst", <span style="color: #04cc04; font-style: italic;">"/"</span>, projname, "_dataanlys.txt"), quote = <span style="color: #0548e8; font-style: italic;">FALSE</span>, row.names = <span style="color: #0548e8; font-style: italic;">FALSE</span>, sep = "\t")
  
  <span style="color: #999999; font-style: italic;"># Display a message indicating that the file has been saved</span>
  message("+++++ Your file has been saved in the networkanalyst folder. +++++")
}


	  
<span style="color: #c20818; font-style: italic;"><strong>#===================================================== Q1 =====================================================#</strong></span>
# other adjust methods ---> "holm", "hochberg", "hommel", "bonferroni", "BH", "BY", "fdr", "none"

<span style="color: #75020c; font-style: italic;"><strong>################################################# GSE25055 #################################################</strong></span> 
<span style="color: #999999; font-style: italic;"># Download the GEO dataset GSE25055</span>
DownloadGEO("GSE25055")

<span style="color: #999999; font-style: italic;"># Perform DEG analysis on GSE25055 dataset</span>
DEGanalysis(projname = "GSE25055",
            compare = "grade",
            groups = list(normal = c("1"), tumor = c("3")),
            adjust = "fdr")

# Create a volcano plot for GSE25055 dataset
volcano_GSE25055 <- Makevolcano(projname = "GSE25055",
                                padjlevel = 0.05,
                                uplogFC = 1,
                                downlogFC = -1,
                                ntop = 10,
                                voltype = "ggplot")
volcano_GSE25055

<span style="color: #999999; font-style: italic;"># Prepare files for network analysis on GSE25055 dataset</span>
Makenetworkanalyst(projname = "GSE25055",
                   compare = "grade",
                   groups = list(normal = c("1"), tumor = c("3")))

<span style="color: #75020c; font-style: italic;"><strong>################################################# GSE7390 #################################################</strong></span>
<span style="color: #999999; font-style: italic;"># Download the GEO dataset GSE7390</span>
DownloadGEO("GSE7390")

<span style="color: #999999; font-style: italic;"># Perform DEG analysis on GSE7390 dataset</span>
DEGanalysis(projname = "GSE7390",
            compare = "grade",
            groups = list(normal = c("1"), tumor = c("3")),
            adjust = "fdr")

<span style="color: #999999; font-style: italic;"># Create a volcano plot for GSE7390 dataset</span>
volcano_GSE7390 <- Makevolcano(projname = "GSE7390",
                               padjlevel = 0.05,
                               uplogFC = 1,
                               downlogFC = -1,
                               ntop = 10,
                               voltype = "ggplot")
volcano_GSE7390

<span style="color: #999999; font-style: italic;"># Prepare files for network analysis on GSE7390 dataset</span>
Makenetworkanalyst(projname = "GSE7390",
                   compare = "grade",
                   groups = list(normal = c("1"), tumor = c("3")))

<span style="color: #75020c; font-style: italic;"><strong>################################################# GSE11121 #################################################</strong></span>
<span style="color: #999999; font-style: italic;"># Download the GEO dataset GSE11121</span>
DownloadGEO("GSE11121")

<span style="color: #999999; font-style: italic;"># Perform DEG analysis on GSE11121 dataset</span>
DEGanalysis(projname = "GSE11121",
            compare = "grade",
            groups = list(normal = c("1"), tumor = c("3")),
            adjust = "fdr")

<span style="color: #999999; font-style: italic;"># Create a volcano plot for GSE11121 dataset</span>
volcano_GSE11121 <- Makevolcano(projname = "GSE11121",
                                padjlevel = 0.05,
                                uplogFC = 1,
                                downlogFC = -1,
                                ntop = 10,
                                voltype = "ggplot")
volcano_GSE11121

<span style="color: #999999; font-style: italic;"># Prepare files for network analysis on GSE11121 dataset</span>
Makenetworkanalyst(projname = "GSE11121",
                   compare = "grade",
                   groups = list(normal = c("1"), tumor = c("3")))

<span style="color: #75020c; font-style: italic;"><strong>################################################# GSE25065 #################################################</strong></span>
<span style="color: #999999; font-style: italic;"></span># Download the GEO dataset GSE25065
DownloadGEO("GSE25065")

<span style="color: #999999; font-style: italic;"># Perform DEG analysis on GSE25065 dataset</span>
DEGanalysis(projname = "GSE25065",
            compare = "grade",
            groups = list(normal = c("1"), tumor = c("3")),
            adjust = "fdr")

<span style="color: #999999; font-style: italic;"># Create a volcano plot for GSE25065 dataset</span>
volcano_GSE25065 <- Makevolcano(projname = "GSE25065",
                                padjlevel = 0.05,
                                uplogFC = 1,
                                downlogFC = -1,
                                ntop = 10,
                                voltype = "ggplot")
volcano_GSE25065

<span style="color: #999999; font-style: italic;"># Prepare files for network analysis on GSE25065 dataset</span>
Makenetworkanalyst(projname = "GSE25065",
                   compare = "grade",
                   groups = list(normal = c("1"), tumor = c("3")))


<span style="color: #999999; font-style: italic;"># Create a Venn diagram for the common differentially expressed genes across the datasets</span>
MakeVenna(common = c("GSE25055", "GSE7390", "GSE11121", "GSE25065"), ntop = 10)


			
			
			
			
			
		</code></pre>
	</div>


	<hr>
	
	<footer class="footer">
	    		<p>&copy; 2023 Mohammad Reza Mohajeri. All rights reserved.</p>
	</footer>
	
	<!-- JavaScript for Drop-down Functionality -->
	<script>
		function toggleDropDown(id) {
			var content = document.getElementById(id);
			content.classList.toggle("active");
		}
	</script>

</body>
</html>
