<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>R Code <br> For 4 Datasets (Meta-analysis)</title>
	<style>

		body {
			background-color: #12243d; /*  Cobalt color code */

		}
		
				
		/* CSS Styles  */
		/* To highlight different parts of the text in red<span style="color: #ebedf0; font-style: italic;">,</span> green<span style="color: #ebedf0; font-style: italic;">,</span> and blue<span style="color: #ebedf0; font-style: italic;">,</span> you can use the <span> element and apply CSS styles to it */ 
		
		.orange-text {
			color: orange;
			font-weight: bold;
		}
		.dark-yellow-text {
			color: hsl(50<span style="color: #ebedf0; font-style: italic;">,</span> 100%<span style="color: #ebedf0; font-style: italic;">,</span> 30%); /* Adjust the hue and saturation values as needed */
			font-weight: bold;
		}
		.brown-text {
			color: hsl(30<span style="color: #ebedf0; font-style: italic;">,</span> 100%<span style="color: #ebedf0; font-style: italic;">,</span> 30%); /* Adjust the hue and saturation values as needed */
			font-weight: bold;
		}
		.green-text {
			color: green;
			font-weight: bold;
		}
		.purple-text {
			color: purple;
			font-weight: bold;
		}
		.blue-text {
			color: blue;
			font-weight: bold;
		}


		/* Header Styles */
		header {
			background-color: #274f4f;
			color: white;
			text-align: center;
			padding: 5px;
		}

		h1 {
			color: white; /* Adjust the font color as desired */
			font-size: 30px; /* Adjust the font size as desired */
			font-weight: bold; /* Add font weight as desired */
			text-align: center; /* Center the header title */
			padding: 0px; /* Add padding around the header title */
			margin-bottom: 20px; /* Add margin below the header title */
		}
		
		hr {
			width: 100%; /* Adjust the width as desired */
		}
		
		/* Adjust font size for the code block */
		pre code {
		        font-size: 17px; /* Adjust the font size as desired */
	        }
		
		/* Footer Styles */
		.footer {
		        background-color: #333;
		        color: #fff;
		        padding: 10px;
		        text-align: center;
		        position: fixed;
		        left: 0;
		        bottom: 0;
		        width: 100%;
		}
	</style>
	
</head>
<body>
	<header>
		<h1>R Code <br> For 4 Datasets (Meta-analysis)</h1>
	</header>

	<section>
		
<pre><code>

	
<span style="color: #05c6e3; font-style: italic;">################################################################# "Package Installation" #################################################################</span>
<span style="color: #05c6e3; font-style: italic;">#################################### Uncomment the following lines if any of the packages are not already installed or need to be reinstalled.############</span>
<span style="color: #05c6e3; font-style: italic;"># BiocManager packages</span> 
<span style="color: #05c6e3; font-style: italic;"># Install required Bioconductor packages</span>
<span style="color: #05c6e3; font-style: italic;"># BiocManager::install("sva", force = TRUE)</span>
<span style="color: #05c6e3; font-style: italic;"># BiocManager::install("GeneMeta", force = TRUE)</span>
<span style="color: #05c6e3; font-style: italic;"># BiocManager::install("ComplexHeatmap", force = TRUE)</span>
<span style="color: #05c6e3; font-style: italic;"># BiocManager::install("fgsea", force = TRUE)</span>
<span style="color: #05c6e3; font-style: italic;"># BiocManager::install("clusterProfiler", force = TRUE)</span>
			
<span style="color: #05c6e3; font-style: italic;"># Other packages</span>
<span style="color: #05c6e3; font-style: italic;"># Install required CRAN packages:</span>
<span style="color: #05c6e3; font-style: italic;"># install.packages("RColorBrewer")</span>
<span style="color: #05c6e3; font-style: italic;"># install.packages("msigdbr")</span>
<span style="color: #05c6e3; font-style: italic;"># install.packages("ggpubr")</span>
<span style="color: #05c6e3; font-style: italic;"># install.packages("reshape2")</span>
<span style="color: #05c6e3; font-style: italic;"># install.packages("caret")</span>
<span style="color: #05c6e3; font-style: italic;"># install.packages("rgl")</span>

<span style="color: #05c6e3; font-style: italic;"># sva package installation</span>
<span style="color: #05c6e3; font-style: italic;"># Install "sva" package using BiocManager</span>
<span style="color: #05c6e3; font-style: italic;"># if (!require("BiocManager", quietly = TRUE))</span>
<span style="color: #05c6e3; font-style: italic;">#   install.packages("BiocManager")</span>
<span style="color: #05c6e3; font-style: italic;"># BiocManager::install("sva")</span>

<span style="color: #05c6e3; font-style: italic;"># VSN package installation</span>
<span style="color: #05c6e3; font-style: italic;"># Install "vsn" package using BiocManager</span>
<span style="color: #05c6e3; font-style: italic;"># if (!require("BiocManager", quietly = TRUE))</span>
<span style="color: #05c6e3; font-style: italic;">#   install.packages("BiocManager")</span>
<span style="color: #05c6e3; font-style: italic;"># BiocManager::install("vsn")</span>

<span style="color: #05c6e3; font-style: italic;"># tidyverse package installation</span>
<span style="color: #05c6e3; font-style: italic;"># install.packages("tidyverse")</span>

<span style="color: #05c6e3; font-style: italic;"># GEOquery package installation</span>
<span style="color: #05c6e3; font-style: italic;"># Install "GEOquery" package using BiocManager</span>
<span style="color: #05c6e3; font-style: italic;"># if (!require("BiocManager", quietly = TRUE))</span>
<span style="color: #05c6e3; font-style: italic;">#   install.packages("BiocManager")</span>
<span style="color: #05c6e3; font-style: italic;"># BiocManager::install("GEOquery")</span>

<span style="color: #05c6e3; font-style: italic;"># limma package installation</span>
<span style="color: #05c6e3; font-style: italic;"># install.packages("limma")</span>

<span style="color: #05c6e3; font-style: italic;"># plotly package installation</span>
<span style="color: #05c6e3; font-style: italic;"># install.packages("plotly")</span>

<span style="color: #05c6e3; font-style: italic;"># ggvenn package installation</span>
<span style="color: #05c6e3; font-style: italic;"># install.packages("ggvenn")</span>

<span style="color: #05c6e3; font-style: italic;"># ggpubr package installation</span>
<span style="color: #05c6e3; font-style: italic;"># install.packages("ggpubr")</span>

<span style="color: #05c6e3; font-style: italic;"># rgl package installation</span>
<span style="color: #05c6e3; font-style: italic;"># For rgl installation, require remotes package first</span>
<span style="color: #05c6e3; font-style: italic;"># install.packages("remotes")</span>
<span style="color: #05c6e3; font-style: italic;"># require(remotes)</span>
<span style="color: #05c6e3; font-style: italic;"># remotes::install_github("dmurdoch/rgl")</span>


<span style="color: #05c6e3; font-style: italic;"># Package Loading</span>
<span style="color: #05c6e3; font-style: italic;"># Load the required packages for data analysis and visualization.</span>
			
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">tidyverse</span><span style="color: #68affc; font-style: italic;">)</span>       <span style="color: #05c6e3; font-style: italic;"># Package for comprehensive data manipulation and visualization, including dplyr, ggplot2, and other useful packages</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOquery</span><span style="color: #68affc; font-style: italic;">)</span>        <span style="color: #05c6e3; font-style: italic;"># Package for accessing and retrieving gene expression data from the Gene Expression Omnibus (GEO) database</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">reshape2</span><span style="color: #68affc; font-style: italic;">)</span>        <span style="color: #05c6e3; font-style: italic;"># Package for reshaping data from wide to long format and vice versa, useful for data preprocessing</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">caret</span><span style="color: #68affc; font-style: italic;">)</span>           <span style="color: #05c6e3; font-style: italic;"># Package for machine learning and predictive modeling, providing a unified interface for various algorithms and performance evaluation</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GeneMeta</span><span style="color: #68affc; font-style: italic;">)</span>        <span style="color: #05c6e3; font-style: italic;"># Package for meta-analysis of gene expression data, allowing combining results from multiple studies</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">limma</span><span style="color: #68affc; font-style: italic;">)</span>           <span style="color: #05c6e3; font-style: italic;"># Package for analyzing microarray data using linear models, including differential expression analysis</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rgl</span><span style="color: #68affc; font-style: italic;">)</span>             <span style="color: #05c6e3; font-style: italic;"># Package for creating interactive 3D visualizations, useful for exploring complex data structures</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">sva</span><span style="color: #68affc; font-style: italic;">)</span>             <span style="color: #05c6e3; font-style: italic;"># Package for surrogate variable analysis, used to identify and adjust for unwanted variation in high-dimensional datasets</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">plotly</span><span style="color: #68affc; font-style: italic;">)</span>          <span style="color: #05c6e3; font-style: italic;"># Package for creating interactive and dynamic plots, including scatter plots, bar plots, and more</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">ggvenn</span><span style="color: #68affc; font-style: italic;">)</span>          <span style="color: #05c6e3; font-style: italic;"># Package for creating Venn diagrams using ggplot2, useful for visualizing set relationships</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">ggpubr</span><span style="color: #68affc; font-style: italic;">)</span>          <span style="color: #05c6e3; font-style: italic;"># Package for creating publication-ready plots using ggplot2, providing additional customization options</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">ComplexHeatmap</span><span style="color: #68affc; font-style: italic;">)</span>  <span style="color: #05c6e3; font-style: italic;"># Package for creating complex heatmaps, allowing visualization of multiple layers of data and annotations</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">RColorBrewer</span><span style="color: #68affc; font-style: italic;">)</span>    <span style="color: #05c6e3; font-style: italic;"># Package for providing color palettes suitable for data visualization</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">msigdbr</span><span style="color: #68affc; font-style: italic;">)</span>         <span style="color: #05c6e3; font-style: italic;"># Package for accessing and using the Molecular Signatures Database (MSigDB) for gene set enrichment analysis</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">fgsea</span><span style="color: #68affc; font-style: italic;">)</span>           <span style="color: #05c6e3; font-style: italic;"># Package for performing gene set enrichment analysis (GSEA) using fast gene set testing algorithms</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">locfit</span><span style="color: #68affc; font-style: italic;">)</span>          <span style="color: #05c6e3; font-style: italic;"># Package for local regression modeling, useful for fitting flexible curves to data</span>
<span style="color: #f79502; font-style: italic;">require</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">vsn</span><span style="color: #68affc; font-style: italic;">)</span>             <span style="color: #05c6e3; font-style: italic;"># Package for variance stabilization and normalization, specifically for microarray data analysis</span>


	
<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span>
<span style="color: #05c6e3; font-style: italic;">####################################################### 1- DownloadGEO Function#######################################################</span>
<span style="color: #05c6e3; font-style: italic;"># DownloadGEO: Downloads a Gene Expression Omnibus (GEO) dataset and prepares it for analysis</span> 

<span style="color: #05c6e3; font-style: italic;"># Input (Arguments):</span> 
<span style="color: #05c6e3; font-style: italic;">#   - GSEname: A character vector specifying the GEO dataset name (default: "GSE25065")</span>

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - Extracted variables saved as separate files (matrix.csv, phenotype.tsv, annot.tsv)</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function downloads a specified GEO dataset from Gene Expression Omnibus (GEO) and prepares it for analysis. </span>
<span style="color: #05c6e3; font-style: italic;"># It creates a folder to store the downloaded dataset, increases memory allocation for efficient processing,</span>  
<span style="color: #05c6e3; font-style: italic;"># and downloads the specified GEO dataset. It then extracts the gene expression matrix, phenotype information,</span> 
<span style="color: #05c6e3; font-style: italic;"># and annotation data from the downloaded dataset. The extracted variables are saved as separate files.</span> 
	
<span style="color: #ebedf0; font-style: italic;">DownloadGEO</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GSEname</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  <span style="color: #05c6e3; font-style: italic;"># Create a folder to store the downloaded dataset</span> 
  <span style="color: #ebedf0; font-style: italic;">dir.create</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GSEname</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">showWarnings</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Increase the memory allocation for efficient processing</span> 
  <span style="color: #ebedf0; font-style: italic;">Sys.setenv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"VROOM_CONNECTION_SIZE"</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #cf4275; font-style: italic;">131072</span> <span style="color: #68affc; font-style: italic;">*</span><span style="color: #cf4275; font-style: italic;">131072</span><span style="color: #68affc; font-style: italic;">)</span>
  
  <span style="color: #05c6e3; font-style: italic;">#Download dataset</span> 
  <span style="color: #ebedf0; font-style: italic;">gset</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">getGEO</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GSEname</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">GSE<span style="color: #ebedf0; font-style: italic;">matrix</span></span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">TRUE</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">AnnotGPL</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">TRUE</span><span style="color: #ebedf0; font-style: italic;">,</span>
                 <span style="color: #ebedf0; font-style: italic;">destdir</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">getwd</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">GSEname</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
	
 <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">!</span><span style="color: #ebedf0; font-style: italic;">is.null</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">gset</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #05c6e3; font-style: italic;"># Extract the gene expression matrix, phenotype information, and annotation data:</span> 
    <span style="color: #05c6e3; font-style: italic;"># Extract the gene expression matrix from the downloaded dataset</span> 
    <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">gset</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GSEname</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"_series_matrix.txt.gz"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">@</span><span style="color: #ebedf0; font-style: italic;">assayData</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #2ad43b; font-style: italic;">"exprs"</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span>
	
    <span style="color: #05c6e3; font-style: italic;"># Check if the matrix has undergone log2 transformation</span> 
    <span style="color: #ebedf0; font-style: italic;">qx</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">as.numeric</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">quantile</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">0.</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">0.25</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">0.5</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">0.75</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">0.99</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">1.0</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">na.rm</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">TRUE</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">LogC</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">qx</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">5</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;"> ></span> <span style="color: #cf4275; font-style: italic;">100</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">||</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">qx</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">6</span><span style="color: #68affc; font-style: italic;">]</span>-<span style="color: #ebedf0; font-style: italic;">qx</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;"><span style="color: #cf4275; font-style: italic;">1</span></span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;"> ></span> <span style="color: #cf4275; font-style: italic;">50</span> <span style="color: #68affc; font-style: italic;">&</span><span style="color: #68affc; font-style: italic;">&</span> <span style="color: #ebedf0; font-style: italic;">qx</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;"><span style="color: #cf4275; font-style: italic;">2</span></span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;"> ></span> <span style="color: #cf4275; font-style: italic;">0</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">!</span><span style="color: #ebedf0; font-style: italic;">LogC</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
      <span style="color: #05c6e3; font-style: italic;"># Reverse the log2 transformation if applied</span> 
      <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #cf4275; font-style: italic;"></span><span style="color: #cf4275; font-style: italic;">2</span><span style="color: #68affc; font-style: italic;">^</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #68affc; font-style: italic;">}</span>

    <span style="color: #05c6e3; font-style: italic;"># Add row names to the matrix and set the column name for the identifier column</span> 
    <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"ID"</span>

    <span style="color: #05c6e3; font-style: italic;"># Extract the phenotype information from the downloaded dataset</span> 
    <span style="color: #ebedf0; font-style: italic;">phenotype</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">gset</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GSEname</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"_series_matrix.txt.gz"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">@</span><span style="color: #ebedf0; font-style: italic;">phenoData</span><span style="color: #68affc; font-style: italic;">@</span><span style="color: #ebedf0; font-style: italic;">data</span>
    <span style="color: #ebedf0; font-style: italic;">phenotype</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">phenotype</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">phenotype</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">phenotype</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"ID"</span>

    <span style="color: #05c6e3; font-style: italic;"># Extract the annotation data from the downloaded dataset</span> 
    <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">gset</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GSEname</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"_series_matrix.txt.gz"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">@</span><span style="color: #ebedf0; font-style: italic;">featureData</span><span style="color: #68affc; font-style: italic;">@</span><span style="color: #ebedf0; font-style: italic;">data</span>
    
	
    <span style="color: #05c6e3; font-style: italic;"># Write the extracted variables to separate files:</span> 
    <span style="color: #05c6e3; font-style: italic;"># Write the gene expression matrix to a CSV file</span> 
    <span style="color: #ebedf0; font-style: italic;">write.csv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GSEname</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"matrix.csv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">quote</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">row.names</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Write the phenotype information to a tab-separated values (TSV) file</span> 
    <span style="color: #ebedf0; font-style: italic;">write_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">phenotype</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GSEname</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"phenotype.tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Write the annotation data to a TSV file</span> 
    <span style="color: #ebedf0; font-style: italic;">write_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GSEname</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"annot.tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    
    <span style="color: #05c6e3; font-style: italic;"># Remove unnecessary variables from memory</span> 
    <span style="color: #ebedf0; font-style: italic;">rm</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">gset</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">phenotype</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Display a message indicating that the dataset is ready for analysis</span> 
    <span style="color: #ebedf0; font-style: italic;">message</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"+++++ Datatset is ready to analyse. +++++"</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #68affc; font-style: italic;">}</span>
<span style="color: #68affc; font-style: italic;">}</span>


<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span>
<span style="color: #05c6e3; font-style: italic;">######################################################### 2- ReadGEO Function#########################################################</span>   
<span style="color: #05c6e3; font-style: italic;"># ReadGEO: Reads the gene expression matrix file for a given project</span> 

<span style="color: #05c6e3; font-style: italic;"># Input (Arguments):</span> 
<span style="color: #05c6e3; font-style: italic;">#   - projname: A character vector specifying the project name</span> 

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - A data frame containing the gene expression matrix</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function reads the gene expression matrix file for a specified project.</span>  
<span style="color: #05c6e3; font-style: italic;"># It takes the argument `projname`, which is a character vector specifying the project name. </span>
<span style="color: #05c6e3; font-style: italic;"># The function reads the matrix file in CSV format using the `read_csv` function and stores it in the variable `matrix`.</span>  
<span style="color: #05c6e3; font-style: italic;"># The gene expression matrix is assumed to be stored in a file named "matrix.csv" in the project folder.</span> 
<span style="color: #05c6e3; font-style: italic;"># Finally, the matrix is converted to a data frame using the `data.frame` function before being returned as the output.</span> 
<span style="color: #05c6e3; font-style: italic;"># The function does not modify the original matrix file; it only reads the file and returns the matrix as a data frame.</span> 

<span style="color: #ebedf0; font-style: italic;">ReadGEO</span>  <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  <span style="color: #05c6e3; font-style: italic;"># Reading the gene expression matrix file</span> 
  <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">read_csv</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"matrix.csv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Converting the matrix to a data frame</span> 	
  <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #68affc; font-style: italic;">}</span>

	
	
<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">###################################################### 3- MakePhenotype Function #####################################################</span> 
<span style="color: #05c6e3; font-style: italic;"># MakePhenotype: Creates a phenotype file based on project-specific phenotype data</span> 

<span style="color: #05c6e3; font-style: italic;"># Input (Arguments):</span> 
<span style="color: #05c6e3; font-style: italic;">#   - projname: A character vector of project names</span> 
<span style="color: #05c6e3; font-style: italic;">#   - compare: A string indicating whether to compare "subtype" or "grade"</span> 

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - A phenotype file containing the selected comparison (subtype or grade)</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function creates a phenotype file based on project-specific phenotype data. It takes the argument `projname`,</span>  
<span style="color: #05c6e3; font-style: italic;"># which is a character vector of project names. The function reads the phenotype file for each project, converts</span>  
<span style="color: #05c6e3; font-style: italic;"># the phenotype data to a data frame, and sets row names. Depending on the value of the `compare` argument, the function </span> 
<span style="color: #05c6e3; font-style: italic;"># either compares subtype or grade information. For subtype comparison, it extracts subtype data, formats it, and stores </span>
<span style="color: #05c6e3; font-style: italic;"># it in a new list. For grade comparison, it extracts grade data, handles special cases (such as Greek symbols), and</span>  
<span style="color: #05c6e3; font-style: italic;"># formats it. The formatted phenotype data is stored in a new list for each project. The function then combines the</span>  
<span style="color: #05c6e3; font-style: italic;"># phenotype data from all projects into a single data frame. Finally, it writes the phenotype data to a CSV file and</span>  
<span style="color: #05c6e3; font-style: italic;"># displays a message indicating that the phenotype file is created.</span> 

<span style="color: #ebedf0; font-style: italic;">Makephenotype</span>  <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  <span style="color: #05c6e3; font-style: italic;"># Create a folder to store the phenotype file</span>
  <span style="color: #ebedf0; font-style: italic;">dir.create</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"phenotype"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">showWarnings</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Initialize an empty list to store the phenotype data for each project</span>	
  <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Iterate over each project name</span>	
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #05c6e3; font-style: italic;"># Read the phenotype file for the current project</span>
    <span style="color: #ebedf0; font-style: italic;">phenotype</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">read_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"phenotype.tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Convert the phenotype data to a data frame and set row names</span>
    <span style="color: #ebedf0; font-style: italic;">phenotype</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">phenotype</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">phenotype</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">phenotype</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #ebedf0; font-style: italic;">phenotype</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">phenotype</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>

    <span style="color: #05c6e3; font-style: italic;"># Add the phenotype data to the list using the project name as the key</span>
    <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">phenotype</span>
  <span style="color: #68affc; font-style: italic;">}</span>
	
 <span style="color: #05c6e3; font-style: italic;"># Choose either subtype or grade for comparison</span>
 <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"subtype"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">pheno2</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Iterate over each project in the phenotype list</span>
    <span style="color: #f79502; font-style: italic;">for</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
      <span style="color: #05c6e3; font-style: italic;"># Find columns related to subtype information (e.g., pam50)</span>
      <span style="color: #ebedf0; font-style: italic;">phecoln</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">grep</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"pam50"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>

     <span style="color: #05c6e3; font-style: italic;"># Check if any subtype columns were found</span>
     <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">phecoln</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;"> ></span> <span style="color: #cf4275; font-style: italic;">0</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
	<span style="color: #05c6e3; font-style: italic;"># Extract the subtype data and format it</span>
        <span style="color: #ebedf0; font-style: italic;">pheno1</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">[</span> <span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">phecoln</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
        <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno1</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"subtype"</span>
        <span style="color: #ebedf0; font-style: italic;"><span style="color: #ebedf0; font-style: italic;">pheno1</span></span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">subtype</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">gsub</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"pam50.+:"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">""</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;"><span style="color: #ebedf0; font-style: italic;">pheno1</span></span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">subtype</span><span style="color: #68affc; font-style: italic;">)</span>

	<span style="color: #05c6e3; font-style: italic;"># Prepare the final phenotype data by adding sample identifiers and column names</span>
        <span style="color: #ebedf0; font-style: italic;">pheno1</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;"> pheno1</span><span style="color: #68affc; font-style: italic;">)</span>
        <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno1</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"Sample"</span>

	<span style="color: #05c6e3; font-style: italic;"># Store the formatted phenotype data in a new list using the project name as the key</span>
        <span style="color: #ebedf0; font-style: italic;">pheno2</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">names</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno1</span>
      <span style="color: #68affc; font-style: italic;">}</span>
    <span style="color: #68affc; font-style: italic;">}</span>

    <span style="color: #05c6e3; font-style: italic;"># Combine the phenotype data from all projects into a single data frame</span>
    <span style="color: #ebedf0; font-style: italic;">pheno3</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">do.call</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">pheno2</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno3</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #cf4275; font-style: italic;">NULL</span> 

	
  <span style="color: #68affc; font-style: italic;">}</span><span style="color: #f79502; font-style: italic;"> else</span><span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">pheno2</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Iterate over each project in the phenotype list</span>	
    <span style="color: #f79502; font-style: italic;">for</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
      <span style="color: #05c6e3; font-style: italic;"># Find columns related to grade information</span>
      <span style="color: #ebedf0; font-style: italic;">gradecoln</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">grep</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"grade:"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>

     <span style="color: #05c6e3; font-style: italic;"># Check if any grade columns were found</span>
     <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">gradecoln</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;"> ></span> <span style="color: #cf4275; font-style: italic;">0</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
	<span style="color: #05c6e3; font-style: italic;"># Extract the grade data and format it</span>
        <span style="color: #ebedf0; font-style: italic;">pheno1</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">[</span> <span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">gradecoln</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
        <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno1</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span>
        <span style="color: #ebedf0; font-style: italic;">pheno1</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">gsub</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"grade:|grade: |B-R grade: "</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">""</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;"><span style="color: #ebedf0; font-style: italic;">pheno1</span></span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span><span style="color: #68affc; font-style: italic;">)</span>
        <span style="color: #ebedf0; font-style: italic;">pheno1</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">gsub</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"=.+"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">""</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;"><span style="color: #ebedf0; font-style: italic;">pheno1</span></span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span><span style="color: #68affc; font-style: italic;">)</span>

	<span style="color: #05c6e3; font-style: italic;"># Handle special cases where grades are represented as Greek symbols</span>
        <span style="color: #ebedf0; font-style: italic;">greek</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">grep</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"III"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;"><span style="color: #ebedf0; font-style: italic;">pheno1</span></span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span><span style="color: #68affc; font-style: italic;">)</span>
        <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">greek</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;"> ></span> <span style="color: #cf4275; font-style: italic;">0</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
          <span style="color: #ebedf0; font-style: italic;">one</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">factor</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;"><span style="color: #ebedf0; font-style: italic;">pheno1</span></span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"I"</span><span style="color: #68affc; font-style: italic;">)</span>
          <span style="color: #ebedf0; font-style: italic;">two</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">factor</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;"><span style="color: #ebedf0; font-style: italic;">pheno1</span></span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"II"</span><span style="color: #68affc; font-style: italic;">)</span>
          <span style="color: #ebedf0; font-style: italic;">three</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">factor</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;"><span style="color: #ebedf0; font-style: italic;">pheno1</span></span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"III"</span><span style="color: #68affc; font-style: italic;">)</span>
          <span style="color: #ebedf0; font-style: italic;">pheno1</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">one</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"1"</span>
          <span style="color: #ebedf0; font-style: italic;">pheno1</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">two</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"2"</span>
          <span style="color: #ebedf0; font-style: italic;">pheno1</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">three</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"3"</span>
        <span style="color: #68affc; font-style: italic;">}</span>

	<span style="color: #05c6e3; font-style: italic;"># Prepare the final phenotype data by adding sample identifiers and column names</span>
        <span style="color: #ebedf0; font-style: italic;">pheno1</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;"> pheno1</span><span style="color: #68affc; font-style: italic;">)</span>
        <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno1</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"Sample"</span>

	<span style="color: #05c6e3; font-style: italic;"># Store the formatted phenotype data in a new list using the project name as the key</span>
        <span style="color: #ebedf0; font-style: italic;">pheno2</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">names</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno1</span>
      <span style="color: #68affc; font-style: italic;">}</span>
    <span style="color: #68affc; font-style: italic;">}</span>

    <span style="color: #05c6e3; font-style: italic;"># Combine the phenotype data from all projects into a single data frame</span>
    <span style="color: #ebedf0; font-style: italic;">pheno3</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">do.call</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">pheno2</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno3</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #cf4275; font-style: italic;">NULL</span> 
  <span style="color: #68affc; font-style: italic;">}</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Write the phenotype data to a CSV file</span>
  <span style="color: #ebedf0; font-style: italic;">write.csv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno3</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"phenotype"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"phenotype_"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">compare</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">".csv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">row.names</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">quote</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Display a message indicating that the phenotype file is created</span>	
  <span style="color: #ebedf0; font-style: italic;">message</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"phenotype file is created into phenotype folder"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #68affc; font-style: italic;">}</span>


	
<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">####################################################### 4- MakeBoxPlot Function ######################################################</span> 
<span style="color: #05c6e3; font-style: italic;"># MakeBoxPlot: Creates a box plot to visualize gene expression values from a gene expression matrix</span> 

<span style="color: #05c6e3; font-style: italic;"># Input (Arguments):</span> 
<span style="color: #05c6e3; font-style: italic;">#   - GEOmatrix: A gene expression matrix in data frame format</span> 
<span style="color: #05c6e3; font-style: italic;">#   - projname: A character vector specifying the project name</span> 

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - A box plot visualizing the gene expression values</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function creates a box plot to visualize the gene expression values from a gene expression matrix.</span>  
<span style="color: #05c6e3; font-style: italic;"># It takes two arguments: `GEOmatrix`, which is the gene expression matrix in data frame format, and `projname`, </span> 
<span style="color: #05c6e3; font-style: italic;"># which is a character vector specifying the project name. The function converts the gene expression matrix into </span> 
<span style="color: #05c6e3; font-style: italic;"># a long format data frame using the `melt` function. It then uses `ggplot2` to create the box plot, with the</span>  
<span style="color: #05c6e3; font-style: italic;"># x-axis representing the samples and the y-axis representing the gene expression values. The plot is customized</span>  
<span style="color: #05c6e3; font-style: italic;"># with color and fill options, axis labels, y-axis scale labels, and theme settings. The resulting box plot</span>  
<span style="color: #05c6e3; font-style: italic;"># is displayed, with the subtitle indicating the project name.</span> 
	
<span style="color: #ebedf0; font-style: italic;">MakeBoxPlot</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">projname</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  <span style="color: #05c6e3; font-style: italic;"># Convert the gene expression matrix into a long format data frame</span>
  <span style="color: #ebedf0; font-style: italic;">melted</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">melt</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">id.vars</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"ID"</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Define a color palette for the plot</span>	
  <span style="color: #ebedf0; font-style: italic;">my_pal</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #1B9E77; font-style: italic; padding: 2px;">#1B9E77</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Plot the box plot using ggplot2 </span>
  <span style="color: #ebedf0; font-style: italic;">ggplot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">data</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">melted</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">aes</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">variable</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">value</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Add the box plot layer with color and fill options</span>
    <span style="color: #ebedf0; font-style: italic;">geom_boxplot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">aes</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">color</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #45B39D; font-style: italic; padding: 2px;">#45B39D</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">fill</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #45B39D; font-style: italic; padding: 2px;">#45B39D</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">outlier.alpha</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.1</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Set the x and y axis labels</span>
    <span style="color: #ebedf0; font-style: italic;">labs</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">'SampleID'</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">'Values'</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Customize the y-axis scale labels</span>
    <span style="color: #ebedf0; font-style: italic;">scale_y_continuous</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">labels</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">scales</span><span style="color: #68affc; font-style: italic;">::</span><span style="color: #ebedf0; font-style: italic;">comma</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Apply a classic theme to the plot</span>	
    <span style="color: #ebedf0; font-style: italic;">theme_classic</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Set the color scale manually</span>
    <span style="color: #ebedf0; font-style: italic;">scale_color_manual</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">values</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">my_pal</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Set the fill scale manually with a modified transparency value</span>
    <span style="color: #ebedf0; font-style: italic;">scale_fill_manual</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">values</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">my_pal</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"66"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">sep</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">""</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Customize the appearance of the axes, text, and title</span>
    <span style="color: #ebedf0; font-style: italic;">theme</span><span style="color: #68affc; font-style: italic;">(</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize axis labels and text styles:</span>
        <span style="color: #05c6e3; font-style: italic;"># Customize axis text font, size, color, and angle</span>
	<span style="color: #ebedf0; font-style: italic;">axis.text</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">90</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize x-axis text font, color, and size</span>
        <span style="color: #ebedf0; font-style: italic;">axis.text.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">6</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize y-axis text font, color, and size</span>
        <span style="color: #ebedf0; font-style: italic;">axis.text.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">12</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize plot subtitle font, size, color, and horizontal justification</span>
        <span style="color: #ebedf0; font-style: italic;">plot.subtitle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">hjust</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.5</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize y-axis title font, size, and angle</span>
        <span style="color: #ebedf0; font-style: italic;">axis.title.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">90</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize x-axis title font, size, and angle</span>
        <span style="color: #ebedf0; font-style: italic;">axis.title.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">00</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Remove the legend from the plot</span>
        <span style="color: #ebedf0; font-style: italic;">legend.position</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #2ad43b; font-style: italic;">"none"</span>
    <span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>

    <span style="color: #05c6e3; font-style: italic;"># Add a subtitle to the plot indicating the project name</span>
    <span style="color: #ebedf0; font-style: italic;">labs</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">subtitle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"Box plot - "</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #68affc; font-style: italic;">}</span>


	
<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">####################################################### 5- the MakePCA Function ######################################################</span> 
<span style="color: #05c6e3; font-style: italic;"># MakePCA: Performs principal component analysis (PCA) and generates a plot</span> 
 
<span style="color: #05c6e3; font-style: italic;"># Input (Arguments):</span> 
<span style="color: #05c6e3; font-style: italic;">#   - GEOmatrix: A gene expression matrix in data frame format</span> 
<span style="color: #05c6e3; font-style: italic;">#   - studies: A list of gene expression matrices from different studies (optional)</span> 
<span style="color: #05c6e3; font-style: italic;">#   - projname: A character vector specifying the project name(s)</span> 
<span style="color: #05c6e3; font-style: italic;">#   - compare: A character specifying the comparison type (e.g., "grade")</span> 

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - A PCA plot or a 3D plot (based on the number of studies)</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function performs principal component analysis (PCA) on the gene expression matrix provided. </span> 
<span style="color: #05c6e3; font-style: italic;"># It takes the gene expression matrix, `GEOmatrix`, as the primary input. Additionally, it can take a</span>  
<span style="color: #05c6e3; font-style: italic;"># list of gene expression matrices from different studies, `studies`, the project name(s), `projname`, </span> 
<span style="color: #05c6e3; font-style: italic;"># and the comparison type, `compare` (e.g., "grade"). The function first prepares the data by scaling</span>  
<span style="color: #05c6e3; font-style: italic;"># the gene expression matrix and performing PCA using the `preProcess` function from the `caret` package. </span> 
<span style="color: #05c6e3; font-style: italic;"># It then plots the PCA results either as a 2D plot for multiple studies or a 3D plot for a single study. </span> 
<span style="color: #05c6e3; font-style: italic;"># The plot is customized with colors, legends, axis labels, and theme settings. The resulting PCA plot </span> 
<span style="color: #05c6e3; font-style: italic;"># or 3D plot is displayed or saved as an HTML widget based on the number of studies provided.</span> 
	
<span style="color: #ebedf0; font-style: italic;">MakePCA</span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">studies </span><span style="color: #68affc; font-style: italic;">=</span>  <span style="color: #cf4275; font-style: italic;">NULL</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>

  <span style="color: #05c6e3; font-style: italic;"># Create a directory to store the plots</span>	
  <span style="color: #ebedf0; font-style: italic;">dir.create</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"Plots"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">showWarnings</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Read the gene expression matrix file</span>
  <span style="color: #ebedf0; font-style: italic;">set.seed</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">123</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Check if the first column of GEOmatrix is "ID"</span>	
  <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"ID"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #05c6e3; font-style: italic;"># Set the row names of GEOmatrix to the first column and remove the ID column</span>
    <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #68affc; font-style: italic;">}</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Read the phenotype file</span>
  <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">read_csv</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"phenotype/phenotype_"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">".csv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Subset the phenotype data for samples present in the gene expression matrix</span>
  <span style="color: #ebedf0; font-style: italic;">paired_pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Sample</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">paired_pheno</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Perform PCA analysis:</span>
  <span style="color: #05c6e3; font-style: italic;"># Convert the gene expression matrix to a data frame and transpose it</span>
  <span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">t</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Scale the data for PCA</span>	
  <span style="color: #ebedf0; font-style: italic;">pca_df</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">scale</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Create a PCA model</span>
  <span style="color: #ebedf0; font-style: italic;">pca</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">preProcess</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">pca_df</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">method</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">'pca'</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">pcaComp</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">3</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Apply the PCA transformation to the data</span>	
  <span style="color: #ebedf0; font-style: italic;">pca_df</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">predict</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pca</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">pca_df</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Sort the PCA data frame and the phenotype data frame by row names</span>
  <span style="color: #ebedf0; font-style: italic;">pca_df</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pca_df</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">order</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pca_df</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">order</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Sample</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
 
  <span style="color: #05c6e3; font-style: italic;"># Handling missing values in phenotype data:</span>
  <span style="color: #05c6e3; font-style: italic;"># Identify rows with NA values in the "grade" column</span>	
  <span style="color: #ebedf0; font-style: italic;">na_row</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">is.na</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Execute the following code if there are NA values in the row</span>	
  <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">na_row</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;"> ></span> <span style="color: #cf4275; font-style: italic;">0</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #05c6e3; font-style: italic;"># Get the sample names with NA values</span>
    <span style="color: #ebedf0; font-style: italic;">na_samp</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">na_row</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>

    <span style="color: #05c6e3; font-style: italic;"># Identify the corresponding columns in the PCA data frame</span>
    <span style="color: #ebedf0; font-style: italic;">na_colm</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pca_df</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">na_samp</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Remove rows with NA values from the phenotype data frame and corresponding columns from the PCA data frame</span>
    <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">na_row</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #ebedf0; font-style: italic;">pca_df</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pca_df</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">na_colm</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #68affc; font-style: italic;">}</span>

  <span style="color: #05c6e3; font-style: italic;"># Assign class labels to PCA data:</span>
  <span style="color: #05c6e3; font-style: italic;"># Create a factor variable for class labels based on the "grade" column</span> 
  <span style="color: #ebedf0; font-style: italic;">pca_df</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Class</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">factor</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Define a color palette for the 2D plot for multi-studies</span> 
  <span style="color: #ebedf0; font-style: italic;">my_pal</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #7570B3; font-style: italic; padding: 2px;">#7570B3</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #E7298A; font-style: italic; padding: 2px;">#E7298A</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #66A61E; font-style: italic; padding: 2px;">#66A61E</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #E6AB02; font-style: italic; padding: 2px;">#E6AB02</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #A6761D; font-style: italic; padding: 2px;">#A6761D</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #666666; font-style: italic; padding: 2px;">#666666</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #9A7D0A; font-style: italic; padding: 2px;">#9A7D0A</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Execute the following code if the length of projname is greater than 1</span>
  <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">></span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>

    <span style="color: #05c6e3; font-style: italic;"># Get the row names of the PCA data frame</span>
    <span style="color: #ebedf0; font-style: italic;">pca_rownames</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pca_df</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Create a batch variable for different studies</span>
    <span style="color: #ebedf0; font-style: italic;">study_list</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">studies</span>
    <span style="color: #ebedf0; font-style: italic;">batch</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Iterate over each element in study_list</span>
    <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">study_list</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
      <span style="color: #05c6e3; font-style: italic;"># Determine the number of samples from each study present in the PCA data frame</span>
      <span style="color: #ebedf0; font-style: italic;">l</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">study_list</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">pca_rownames</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
      <span style="color: #05c6e3; font-style: italic;"># Create a list with repeated project names for each sample from the corresponding study</span>
      <span style="color: #ebedf0; font-style: italic;">batch</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;"> rep</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">l</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #68affc; font-style: italic;">}</span>
    <span style="color: #05c6e3; font-style: italic;"># Combine the list into a single vector</span>
    <span style="color: #ebedf0; font-style: italic;">batch</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">unlist</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">batch</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Assign the batch information as a factor variable in the PCA data frame</span>
    <span style="color: #ebedf0; font-style: italic;">pca_df</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">studies</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">factor</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">batch</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Generate the PCA plot using ggplot2</span>
    <span style="color: #ebedf0; font-style: italic;">ggplot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">data</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">pca_df</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">aes</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">PC1</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">PC2</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">color</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">Class</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">fill</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">Class</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #05c6e3; font-style: italic;"># Add points with shape based on the "Studies" variable</span>
      <span style="color: #ebedf0; font-style: italic;">geom_point</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">3</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">aes</span><span style="color: #68affc; font-style: italic;">(</span> <span style="color: #ebedf0; font-style: italic;">shape</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #05c6e3; font-style: italic;"># Customize color scale for class labels</span>
      <span style="color: #ebedf0; font-style: italic;">scale_color_manual</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">values</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">my_pal</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #05c6e3; font-style: italic;"># Customize fill colors for class labels</span>
      <span style="color: #ebedf0; font-style: italic;">scale_fill_manual</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">values</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">my_pal</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"66"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">sep</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">""</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #05c6e3; font-style: italic;"># Apply a classic theme to the plot</span>
      <span style="color: #ebedf0; font-style: italic;">theme_classic</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #05c6e3; font-style: italic;"># Customize the appearance of the axes, text, and title</span>
      <span style="color: #ebedf0; font-style: italic;">theme</span><span style="color: #68affc; font-style: italic;">(</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize axis text font, size, and color</span>
	<span style="color: #ebedf0; font-style: italic;">axis.text</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize x-axis text font, color, and size</span>
        <span style="color: #ebedf0; font-style: italic;">axis.text.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize y-axis text font, color, and size</span>
        <span style="color: #ebedf0; font-style: italic;">axis.text.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize plot subtitle text font, size, color, and position</span>
        <span style="color: #ebedf0; font-style: italic;">plot.subtitle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">hjust</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.5</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize y-axis title font, size, and rotation angle</span>
        <span style="color: #ebedf0; font-style: italic;">axis.title.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">90</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize x-axis title font, size, and rotation angle</span>
        <span style="color: #ebedf0; font-style: italic;">axis.title.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">00</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize legend text size and font</span>
        <span style="color: #ebedf0; font-style: italic;">legend.text</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">10</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> 
	<span style="color: #05c6e3; font-style: italic;"># Customize legend title size and font</span>
        <span style="color: #ebedf0; font-style: italic;">legend.title</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">20</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #68affc; font-style: italic;">)</span>
      <span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #05c6e3; font-style: italic;"># Set the subtitle of the plot</span>
      <span style="color: #ebedf0; font-style: italic;">labs</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">subtitle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"PCA plot- Merged studies"</span><span style="color: #68affc; font-style: italic;">)</span>
    
  <span style="color: #68affc; font-style: italic;">}</span><span style="color: #f79502; font-style: italic;"> else</span> <span style="color: #68affc; font-style: italic;">{</span>
    
    <span style="color: #05c6e3; font-style: italic;"># Plot a 3D plot for a single study:</span>
    <span style="color: #05c6e3; font-style: italic;"># Plotting using the plot3d function</span>
    <span style="color: #ebedf0; font-style: italic;">plot3d</span><span style="color: #68affc; font-style: italic;">(</span> 
	<span style="color: #05c6e3; font-style: italic;"># Specify the coordinates for the 3D plot</span>
        <span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">pca_df</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">PC1</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">pca_df</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">PC2</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">z</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">pca_df</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">PC3</span><span style="color: #ebedf0; font-style: italic;">,</span> 
        <span style="color: #05c6e3; font-style: italic;"># Set color based on the class labels</span>
        <span style="color: #ebedf0; font-style: italic;">col</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">my_pal</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">pca_df</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Class</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Set the point type as "s" for spheres </span>
        <span style="color: #ebedf0; font-style: italic;">type</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">'s'</span><span style="color: #ebedf0; font-style: italic;">,</span> 
	<span style="color: #05c6e3; font-style: italic;"># Set the radius of the spheres</span>
        <span style="color: #ebedf0; font-style: italic;">radius</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">4</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Set the size of the spheres</span>
        <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">3</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Set the axis labels</span>
        <span style="color: #ebedf0; font-style: italic;">xlab</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #2ad43b; font-style: italic;">"PC1"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">ylab</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #2ad43b; font-style: italic;">"PC2"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">zlab</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #2ad43b; font-style: italic;">"PC3"</span>
    <span style="color: #68affc; font-style: italic;">)</span>
    
    <span style="color: #05c6e3; font-style: italic;"># Add a legend to the plot</span>
    <span style="color: #ebedf0; font-style: italic;">legend3d</span><span style="color: #68affc; font-style: italic;">(</span>
	<span style="color: #05c6e3; font-style: italic;"># Set the position of the legend</span>
        <span style="color: #2ad43b; font-style: italic;">"topright"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
	<span style="color: #05c6e3; font-style: italic;"># Set the legend labels based on the class labels</span>
        <span style="color: #ebedf0; font-style: italic;">legend</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">levels</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">factor</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pca_df</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Class</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> 
	<span style="color: #05c6e3; font-style: italic;"># Set the legend title</span>
        <span style="color: #ebedf0; font-style: italic;">title</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">compare</span> <span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Set the legend marker type</span>
        <span style="color: #ebedf0; font-style: italic;">pch</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">16</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Set the legend marker colors</span>
        <span style="color: #ebedf0; font-style: italic;">col</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">my_pal</span><span style="color: #ebedf0; font-style: italic;">,</span> 
	<span style="color: #05c6e3; font-style: italic;"># Set the legend text size</span>
        <span style="color: #ebedf0; font-style: italic;">cex</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #cf4275; font-style: italic;">1.2</span><span style="color: #ebedf0; font-style: italic;">,</span> 
	<span style="color: #05c6e3; font-style: italic;"># Set the inset position of the legend</span>
        <span style="color: #ebedf0; font-style: italic;">inset</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">0.02</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #68affc; font-style: italic;">)</span>
    
    <span style="color: #05c6e3; font-style: italic;"># Save the 3D plot as an HTML widget:</span>
    <span style="color: #05c6e3; font-style: italic;"># Combine project names into a single string</span>
    <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">collapse</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"-"</span><span style="color: #68affc; font-style: italic;">)</span> 
    <span style="color: #05c6e3; font-style: italic;"># Save the 3D plot as an HTML widget using the saveWidget() function</span>
    <span style="color: #ebedf0; font-style: italic;">htmlwidgets</span><span style="color: #68affc; font-style: italic;">::</span><span style="color: #ebedf0; font-style: italic;">saveWidget</span><span style="color: #68affc; font-style: italic;">(</span>
        <span style="color: #05c6e3; font-style: italic;"># Specify the dimensions of the widget</span>
        <span style="color: #ebedf0; font-style: italic;">rglwidget</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">width</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">800</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">height</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">800</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> 
        <span style="color: #05c6e3; font-style: italic;"># Set the file name</span>
        <span style="color: #ebedf0; font-style: italic;">file</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"Plots/PCA_"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">".html"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Specify the library directory</span>
        <span style="color: #ebedf0; font-style: italic;">libdir</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"libs"</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Set the title of the HTML file</span>
	<span style="color: #ebedf0; font-style: italic;">title</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"PCA - "</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Specify whether the HTML file should be self-contained</span>
        <span style="color: #ebedf0; font-style: italic;">selfcontained</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span>
    <span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #68affc; font-style: italic;">}</span>
<span style="color: #68affc; font-style: italic;">}</span>



<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">##################################################### 6- VSNQuantilNorm Function######################################################</span>
<span style="color: #05c6e3; font-style: italic;"># VSNQuantilNorm: Performs VSN (Variance Stabilizing Normalization) followed by quantile normalization on the input gene expression matrix</span> 

<span style="color: #05c6e3; font-style: italic;"># Input (Arguments):</span> 
<span style="color: #05c6e3; font-style: italic;">#   - GEOmatrix: The gene expression matrix to be normalized</span> 

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - A data frame containing the normalized gene expression matrix</span> 
 
<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function performs Variance Stabilizing Normalization (VSN) followed by quantile normalization on the</span>  
<span style="color: #05c6e3; font-style: italic;"># input gene expression matrix, `GEOmatrix`. VSN is used to stabilize the variance of gene expression values</span> 
<span style="color: #05c6e3; font-style: italic;"># across samples, and quantile normalization is applied to ensure that the distribution of gene expression values</span>  
<span style="color: #05c6e3; font-style: italic;"># is the same across samples. The function first sets the row names of the gene expression matrix and removes the</span>  
<span style="color: #05c6e3; font-style: italic;"># ID column. Then, it performs VSN normalization using the `normalizeVSN` function. After VSN normalization, the</span>  
<span style="color: #05c6e3; font-style: italic;"># function applies quantile normalization by ranking and sorting each column of the normalized matrix. It calculates</span>  
<span style="color: #05c6e3; font-style: italic;"># the mean across rows and applies an indexing function to retrieve the mean values using column indices. Finally,</span>  
<span style="color: #05c6e3; font-style: italic;"># the function returns a data frame containing the normalized gene expression matrix, where the first column is</span>  
<span style="color: #05c6e3; font-style: italic;"># named "ID" and row names are combined with the normalized matrix.</span> 

<span style="color: #ebedf0; font-style: italic;">VSNQuantilNorm</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
 <span style="color: #05c6e3; font-style: italic;"># Set the seed for reproducibility of random processes</span> 	
  <span style="color: #ebedf0; font-style: italic;">set.seed</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">1234</span><span style="color: #68affc; font-style: italic;">)</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Reading the gene expression matrix and setting row names</span>	
  <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Normalize the gene expression data using the VSN (variance stabilization and normalization) method</span>
  <span style="color: #ebedf0; font-style: italic;">vsnnorm</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">normalizeVSN</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #68affc; font-style: italic;">)</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Quantile normalization:</span>
  <span style="color: #05c6e3; font-style: italic;"># Rank each column of the normalized matrix</span>
  <span style="color: #ebedf0; font-style: italic;">df_rank</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">apply</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">vsnnorm</span><span style="color: #ebedf0; font-style: italic;">,</span>2<span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">rank</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">ties.method</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #2ad43b; font-style: italic;">"min"</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Sort each column of the normalized matrix</span>
  <span style="color: #ebedf0; font-style: italic;">df_sorted</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">apply</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">vsnnorm</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">2</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">sort</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Calculate the mean across rows</span>	
  <span style="color: #ebedf0; font-style: italic;">df_mean</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">apply</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">df_sorted</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">mean</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Function to retrieve mean values using column indices</span>
  <span style="color: #ebedf0; font-style: italic;">index_to_mean</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">my_index</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">my_mean</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>

    <span style="color: #05c6e3; font-style: italic;"># Return the mean value at the specified index</span>	
    <span style="color: #ebedf0; font-style: italic;">return</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">my_mean</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">my_index</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #68affc; font-style: italic;">}</span>

  <span style="color: #05c6e3; font-style: italic;"># Apply the index_to_mean function to the ranked matrix to obtain the final normalized matrix</span>	
  <span style="color: #ebedf0; font-style: italic;">norm_final</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">apply</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">df_rank</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">2</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">index_to_mean</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">my_mean</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">df_mean</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Convert the final normalized matrix into a data frame</span>
  <span style="color: #ebedf0; font-style: italic;">norm_final</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">norm_final</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Convert all columns of the data frame to numeric type</span>	
  <span style="color: #ebedf0; font-style: italic;">norm_finall</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">sapply</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">norm_final</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #ebedf0; font-style: italic;">as.numeric</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">as.character</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">check.names</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Combine the row names of the original matrix with the normalized matrix</span>
  <span style="color: #ebedf0; font-style: italic;">norm_finall</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">norm_finall</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Rename the first column as "ID"</span>	
  <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">norm_finall</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"ID"</span>

  <span style="color: #05c6e3; font-style: italic;"># Return the normalized gene expression matrix</span>
  <span style="color: #ebedf0; font-style: italic;">return</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">norm_finall</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #68affc; font-style: italic;">}</span>


	
<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">###################################################### 7- MergeStudies function ######################################################</span>   
<span style="color: #05c6e3; font-style: italic;"># MergeStudies: Merge multiple matrices</span> 

<span style="color: #05c6e3; font-style: italic;"># Input (Arguments):</span> 
<span style="color: #05c6e3; font-style: italic;">#   - studies: A list of matrices to be merged</span> 

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - The merged matrix</span>

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function merges multiple matrices provided as a list, 'studies'. It uses the 'merge' function to combine</span>  
<span style="color: #05c6e3; font-style: italic;"># the matrices, ensuring that all rows and columns from each matrix are included in the merged result by setting</span>  
<span style="color: #05c6e3; font-style: italic;"># the 'all=TRUE' argument. The function returns the merged matrix, which contains the combined data from all</span>  
<span style="color: #05c6e3; font-style: italic;"># input matrices.</span> 
	
<span style="color: #ebedf0; font-style: italic;">Mergestudies</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Merging two or more matrices using the 'merge' function with 'all=TRUE' to include all rows and columns</span>
  <span style="color: #ebedf0; font-style: italic;">study_list</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">Reduce</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #ebedf0; font-style: italic;">merge</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">all</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">TRUE</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">return</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">study_list</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #68affc; font-style: italic;">}</span>


	
<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">#################################################### 8- StudyBatchEffect Function ####################################################</span>  
<span style="color: #05c6e3; font-style: italic;"># StudyBatchEffect: Perform batch effect correction on merged matrices</span> 

<span style="color: #05c6e3; font-style: italic;"># Input (Arguments):</span> 
<span style="color: #05c6e3; font-style: italic;">#   - studies: A list of matrices with batch effects</span>

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - The batch-corrected matrix</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function performs batch effect correction on a list of matrices provided in 'studies'.</span>  
<span style="color: #05c6e3; font-style: italic;"># It calculates the number of samples for each matrix and creates a vector of batch sizes based on the </span> 
<span style="color: #05c6e3; font-style: italic;"># number of samples in each matrix. The function then merges the matrices using the 'merge' function with</span>  
<span style="color: #05c6e3; font-style: italic;"># 'all=TRUE' to include all rows and columns. Next, it sets the row names of the merged matrix and performs</span>  
<span style="color: #05c6e3; font-style: italic;"># batch effect correction using the ComBat function. The corrected matrix is converted to a data frame,</span> 
<span style="color: #05c6e3; font-style: italic;"># ensuring columns are of numeric type. Finally, the row names are combined with the corrected matrix,</span>  
<span style="color: #05c6e3; font-style: italic;"># the first column is renamed as "ID", and the batch-corrected matrix is returned as the output of the function.</span> 
	
<span style="color: #ebedf0; font-style: italic;">StudyBatchEffect</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  <span style="color: #05c6e3; font-style: italic;"># Calculating the number of samples for each matrix</span>
  <span style="color: #ebedf0; font-style: italic;">study_list</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">studies</span>
  <span style="color: #05c6e3; font-style: italic;"># Create an empty list to store batches</span>	
  <span style="color: #ebedf0; font-style: italic;">batch</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Iterate over the indices of the study_list</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">study_list</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #05c6e3; font-style: italic;"># Subtract 1 to exclude the column containing row names</span>
    <span style="color: #ebedf0; font-style: italic;">batch</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">ncol</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">study_list</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">-</span> <span style="color: #cf4275; font-style: italic;">1</span>
  <span style="color: #68affc; font-style: italic;">}</span>

  <span style="color: #05c6e3; font-style: italic;"># Flatten the list to create a vector of batch sizes</span>
  <span style="color: #ebedf0; font-style: italic;">batch</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">unlist</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">batch</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Replicate the sequence of study indices based on batch sizes</span>	
  <span style="color: #ebedf0; font-style: italic;">batch</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;"> rep</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">study_list</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">batch</span><span style="color: #68affc; font-style: italic;">)</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Merging matrices using the 'merge' function with 'all=TRUE' to include all rows and columns</span>
  <span style="color: #ebedf0; font-style: italic;">study_list</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">Reduce</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #ebedf0; font-style: italic;">merge</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">all</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">TRUE</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">study_list</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Setting the row names of the merged matrix to the first column</span>
  <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">study_list</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">study_list</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #05c6e3; font-style: italic;"># Exclude the first column containing row names</span>	
  <span style="color: #ebedf0; font-style: italic;">study_list</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">study_list</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Perform batch effect correction using the ComBat function</span>
  <span style="color: #ebedf0; font-style: italic;">corrected_batch</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">ComBat</span><span style="color: #68affc; font-style: italic;">(</span>
	<span style="color: #05c6e3; font-style: italic;"># Input data for batch effect correction</span>
	<span style="color: #ebedf0; font-style: italic;">dat</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">study_list</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Batch information for correction</span>
        <span style="color: #ebedf0; font-style: italic;">batch</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">batch</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># No covariates specified for batch effect correction</span>
        <span style="color: #ebedf0; font-style: italic;">mod</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #cf4275; font-style: italic;">NULL</span> <span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Estimate empirical Bayes parameters</span>
        <span style="color: #ebedf0; font-style: italic;">par.prior</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">TRUE</span><span style="color: #ebedf0; font-style: italic;">,</span> 
	<span style="color: #05c6e3; font-style: italic;"># Disable diagnostic plots</span>
        <span style="color: #ebedf0; font-style: italic;">prior.plots</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Convert the corrected matrix to a data frame</span>	
  <span style="color: #ebedf0; font-style: italic;">corrected_batch</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">corrected_batch</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Convert columns of the data frame to numeric type</span>
  <span style="color: #ebedf0; font-style: italic;">corrected_batch</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span>
	<span style="color: #05c6e3; font-style: italic;"># Convert each column to numeric type using as.numeric(as.character(x))</span>
	<span style="color: #ebedf0; font-style: italic;">sapply</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">corrected_batch</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #ebedf0; font-style: italic;">as.numeric</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">as.character</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Set check.names to FALSE to preserve column names</span>
        <span style="color: #ebedf0; font-style: italic;">check.names</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #ebedf0; font-style: italic;">,</span> 
	<span style="color: #05c6e3; font-style: italic;"># Set row.names to the row names of the original corrected_batch object</span>
	<span style="color: #ebedf0; font-style: italic;">row.names</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">corrected_batch</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Combine the row names with the corrected matrix</span>	
  <span style="color: #ebedf0; font-style: italic;">corrected_batch</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">corrected_batch</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">corrected_batch</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Rename the first column as "ID"</span>
  <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">corrected_batch</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"ID"</span>

  <span style="color: #05c6e3; font-style: italic;"># Return the batch-corrected matrix as the output of the function</span>	
  <span style="color: #ebedf0; font-style: italic;">return</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">corrected_batch</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #68affc; font-style: italic;">}</span>


	
<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">#################################################### 9- MakeDensityPlot Function #################################################### </span> 
<span style="color: #05c6e3; font-style: italic;"># MakeDensityPlot: Create a density plot of gene expression values</span> 

<span style="color: #05c6e3; font-style: italic;"># Input:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - matrix: The gene expression matrix</span> 
<span style="color: #05c6e3; font-style: italic;">#   - studies: A list of matrices representing different studies</span> 

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - None (the plot is displayed)</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function creates a density plot to visualize the distribution of gene expression values across different studies.</span>  
<span style="color: #05c6e3; font-style: italic;"># It converts the gene expression matrix to a long format data frame, calculates the number of samples for each study,</span>  
<span style="color: #05c6e3; font-style: italic;"># and adds a study factor variable to the data frame. The function then plots the density plot using ggplot2,</span>  
<span style="color: #05c6e3; font-style: italic;"># with gene expression values on the x-axis and color-coded by studies. It customizes the appearance of the plot</span>  
<span style="color: #05c6e3; font-style: italic;"># and adds axis labels and a subtitle. The density plot provides insights into the distribution patterns and</span>  
<span style="color: #05c6e3; font-style: italic;"># potential differences in gene expression between studies.</span> 

<span style="color: #ebedf0; font-style: italic;">MakeDensityPlot</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  <span style="color: #05c6e3; font-style: italic;"># Set the random seed for reproducibility</span>
  <span style="color: #ebedf0; font-style: italic;">set.seed</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">1234</span><span style="color: #68affc; font-style: italic;">)</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Convert the gene expression matrix to a long format data frame</span>
  <span style="color: #ebedf0; font-style: italic;">melted</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">melt</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">id.vars</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"ID"</span><span style="color: #68affc; font-style: italic;">)</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Calculating the number of samples for each study:</span>
  <span style="color: #05c6e3; font-style: italic;"># Create an empty list named 'st'</span>
  <span style="color: #ebedf0; font-style: italic;">st </span><span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>


  <span style="color: #05c6e3; font-style: italic;"># Loop over the sequence of indices of the 'studies' vector</span>
  <span style="color: #05c6e3; font-style: italic;"># The variable 'i' represents the current index in each iteration</span>
  <span style="color: #05c6e3; font-style: italic;"># The loop iterates over each element in 'studies'</span>	
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #05c6e3; font-style: italic;"># Get the number of rows in the study matrix</span>
    <span style="color: #ebedf0; font-style: italic;">row_n</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">nrow</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Get the number of columns in the study matrix excluding the ID column</span>
    <span style="color: #ebedf0; font-style: italic;">col_n</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">ncol</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span>
    <span style="color: #05c6e3; font-style: italic;"># Create a vector of study names repeated for each sample</span>
    <span style="color: #ebedf0; font-style: italic;">st</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;"> rep</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">names</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">row_n</span><span style="color: #68affc; font-style: italic;">*</span><span style="color: #ebedf0; font-style: italic;">col_n</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #68affc; font-style: italic;">}</span>
	
  <span style="color: #05c6e3; font-style: italic;"# Combine the study name vectors into a single vector></span>
  <span style="color: #ebedf0; font-style: italic;">st </span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">unlist</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">st</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Add the study factor variable to the melted data frame</span>	
  <span style="color: #ebedf0; font-style: italic;">melted</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">studies</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">factor</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">st</span><span style="color: #68affc; font-style: italic;">)</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Plotting a density plot:</span>
  <span style="color: #05c6e3; font-style: italic;"># Define a color palette for the plot</span>
  <span style="color: #ebedf0; font-style: italic;">my_pal</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #7570B3; font-style: italic; padding: 2px;">#7570B3</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #E7298A; font-style: italic; padding: 2px;">#E7298A</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #66A61E; font-style: italic; padding: 2px;">#66A61E</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #E6AB02; font-style: italic; padding: 2px;">#E6AB02</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #A6761D; font-style: italic; padding: 2px;">#A6761D</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #666666; font-style: italic; padding: 2px;">#666666</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #9A7D0A; font-style: italic; padding: 2px;">#9A7D0A</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Create a ggplot object with the melted data as the input data</span>
  <span style="color: #05c6e3; font-style: italic;"># Specify x as gene expression values and color by studies</span>
  <span style="color: #ebedf0; font-style: italic;">ggplot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">data</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">melted</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">aes</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">value</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">color</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Add density plot with a specified line size</span>
    <span style="color: #ebedf0; font-style: italic;">geom_density</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">1.5</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Set axis labels</span>	
    <span style="color: #ebedf0; font-style: italic;">labs</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">y</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">'Density'</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">'Value'</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Apply a classic theme to the plot</span>
    <span style="color: #ebedf0; font-style: italic;">theme_classic</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Set manual color scale based on study names</span>
    <span style="color: #ebedf0; font-style: italic;">scale_color_manual</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">values</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">my_pal</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Set manual fill color scale</span>
    <span style="color: #ebedf0; font-style: italic;">scale_fill_manual</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">values</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">my_pal</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"66"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">sep</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">""</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Customize the appearance of the axes, text, and title</span>
    <span style="color: #ebedf0; font-style: italic;">theme</span><span style="color: #68affc; font-style: italic;">(</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize axis text styles</span>
	<span style="color: #ebedf0; font-style: italic;">axis.text</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">90</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize x-axis text style</span>
        <span style="color: #ebedf0; font-style: italic;">axis.text.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">12</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize y-axis text style</span>
        <span style="color: #ebedf0; font-style: italic;">axis.text.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize subtitle</span>
        <span style="color: #ebedf0; font-style: italic;">plot.subtitle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">hjust</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.5</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize y-axis title</span>
        <span style="color: #ebedf0; font-style: italic;">axis.title.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">90</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	<span style="color: #05c6e3; font-style: italic;"># Customize x-axis title</span>
        <span style="color: #ebedf0; font-style: italic;">axis.title.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">00</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Add a subtitle to the plot</span>
    <span style="color: #ebedf0; font-style: italic;">labs</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">subtitle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Density plot"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #68affc; font-style: italic;">}</span> 


	
<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">###################################################### 10- MakeMDSPlot Function ######################################################</span>  
<span style="color: #05c6e3; font-style: italic;"># MakeMDSPlot: Create a multidimensional scaling (MDS) plot</span> 

<span style="color: #05c6e3; font-style: italic;"># Input (Arguments):</span> 
<span style="color: #05c6e3; font-style: italic;">#   - matrix: The input matrix containing gene expression data</span> 
<span style="color: #05c6e3; font-style: italic;">#   - studies: A list of matrices representing different studies</span> 
<span style="color: #05c6e3; font-style: italic;">#   - projname: A vector of project names corresponding to each study</span> 
<span style="color: #05c6e3; font-style: italic;">#   - compare: A comparison variable</span> 
<span style="color: #05c6e3; font-style: italic;">#   - nstudies: The number of studies</span> 

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - None (the plot is displayed)</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function creates an MDS plot to visualize the relationship between samples based on their gene expression data.</span>  
<span style="color: #05c6e3; font-style: italic;"># The plot helps to identify clusters and patterns in the data, providing insights into similarities and differences among samples.</span> 

<span style="color: #05c6e3; font-style: italic;"># Define the MakeMDSPlot function with input parameters</span>
<span style="color: #ebedf0; font-style: italic;">MakeMDSPlot</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span><span style="color: #ebedf0; font-style: italic;">,</span>  <span style="color: #ebedf0; font-style: italic;">nstudies</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  <span style="color: #05c6e3; font-style: italic;"># Set the random seed for reproducibility</span>
  <span style="color: #ebedf0; font-style: italic;">set.seed</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">1234</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Check if the matrix has an "ID" column, and if so, set row names and remove the ID column</span>	
  <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"ID"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #05c6e3; font-style: italic;"># Set row names to the values in the "ID" column</span>
    <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #05c6e3; font-style: italic;"># Remove the "ID" column from the matrix</span>
    <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #68affc; font-style: italic;">}</span>

  <span style="color: #05c6e3; font-style: italic;"># Transpose the matrix and convert it to a data frame</span>	
  <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">t</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>


	
  <span style="color: #05c6e3; font-style: italic;"># Compute MDS using the dist() and cmdscale() functions:</span>
  <span style="color: #05c6e3; font-style: italic;"># Assign the input matrix to the variable mds</span>
  <span style="color: #ebedf0; font-style: italic;">mds</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;">%>%</span>
    <span style="color: #05c6e3; font-style: italic;"># Compute the distance matrix using the dist() function</span>
    <span style="color: #ebedf0; font-style: italic;">dist</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%>%</span>          
    <span style="color: #05c6e3; font-style: italic;"># Perform classical multidimensional scaling (MDS) on the distance matrix using the cmdscale() function.</span># Perform classical multidimensional scaling (MDS) on the distance matrix using the cmdscale() function.
    <span style="color: #ebedf0; font-style: italic;">cmdscale</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%>%</span>
    <span style="color: #05c6e3; font-style: italic;"># Convert the MDS output to a data frame and assign it to the variable mds.</span>
    <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Set column names as "Dim1" and "Dim2"</span>
  <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">mds</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"Dim1"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"Dim2"</span><span style="color: #68affc; font-style: italic;">)</span>

	
  <span style="color: #05c6e3; font-style: italic;"># Perform clustering using k-means on the MDS coordinates</span>
  <span style="color: #05c6e3; font-style: italic;"># Perform k-means clustering on mds with nstudies clusters and assign the resulting cluster assignments to the variable clust.</span>
  <span style="color: #ebedf0; font-style: italic;">clust</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">kmeans</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">mds</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">nstudies</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">cluster</span> <span style="color: #68affc; font-style: italic;">%>%</span>
    <span style="color: #05c6e3; font-style: italic;"># Convert the cluster assignments to a factor data type.</span>
    <span style="color: #ebedf0; font-style: italic;">as.factor</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Add clustering results to the MDS data frame</span>
  <span style="color: #05c6e3; font-style: italic;"># Update the 'mds' data frame</span>
  <span style="color: #ebedf0; font-style: italic;">mds</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">mds</span> <span style="color: #68affc; font-style: italic;">%>%</span>
    <span style="color: #05c6e3; font-style: italic;"># Add a new column called "Clusters" and assign cluster assignments from 'clust'</span>
    <span style="color: #ebedf0; font-style: italic;">mutate</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">clusters</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">clust</span><span style="color: #68affc; font-style: italic;">)</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Retrieve the row names of the MDS data frame</span>
  <span style="color: #ebedf0; font-style: italic;">mds_rownames</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">mds</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Assign study names to each sample based on column names of study matrices:</span>
  <span style="color: #05c6e3; font-style: italic;"# Assign the 'studies' object to 'study_list'></span>	
  <span style="color: #ebedf0; font-style: italic;">study_list</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">studies</span>
  <span style="color: #05c6e3; font-style: italic;"># Create an empty list called 'batch'</span>	
  <span style="color: #ebedf0; font-style: italic;">batch</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Loop over the indices of 'study_list'</span>	
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">study_list</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #05c6e3; font-style: italic;"># Determine the number of samples in the current study</span>
    <span style="color: #cf4275; font-style: italic;">l</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">study_list</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">mds_rownames</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Create a vector of project names for the samples in the current study</span>
    <span style="color: #ebedf0; font-style: italic;">batch</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;"> rep</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">l</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #68affc; font-style: italic;">}</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Combine the project names into a single vector</span>
  <span style="color: #ebedf0; font-style: italic;">batch</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">unlist</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">batch</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Add the project names as a factor to the MDS data frame</span>	
  <span style="color: #ebedf0; font-style: italic;">mds</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">studies</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">factor</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">batch</span><span style="color: #68affc; font-style: italic;">)</span> 

  <span style="color: #05c6e3; font-style: italic;"># MDS plot customization:</span>
  <span style="color: #05c6e3; font-style: italic;"># This section creates an MDS (Multidimensional Scaling) plot using the ggscatter function from the ggpubr package and customizes various plot elements:</span>
  <span style="color: #05c6e3; font-style: italic;"># Define a vector of color codes for plotting</span>
  <span style="color: #ebedf0; font-style: italic;">my_pal</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #7570B3; font-style: italic; padding: 2px;">#7570B3</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #E7298A; font-style: italic; padding: 2px;">#E7298A</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #66A61E; font-style: italic; padding: 2px;">#66A61E</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #E6AB02; font-style: italic; padding: 2px;">#E6AB02</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #A6761D; font-style: italic; padding: 2px;">#A6761D</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #666666; font-style: italic; padding: 2px;">#666666</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #9A7D0A; font-style: italic; padding: 2px;">#9A7D0A</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Create the scatter plot using ggscatter from the ggpubr package</span>
  <span style="color: #ebedf0; font-style: italic;">g</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">ggscatter</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">mds</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Dim1"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Dim2"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                 <span style="color: #05c6e3; font-style: italic;"># Specify the label, shape, color, palette, size, and other options for ggscatter:</span>
                 <span style="color: #05c6e3; font-style: italic;"># Set the labels for the points as row names of the MDS matrix</span>
                 <span style="color: #ebedf0; font-style: italic;">label</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">mds</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	         <span style="color: #05c6e3; font-style: italic;"># Use the "Studies" variable for shaping the points</span>
	         <span style="color: #ebedf0; font-style: italic;">shape</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Studies"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                 <span style="color: #05c6e3; font-style: italic;"># Set the theme of the ggplot to "classic"</span>
                 <span style="color: #ebedf0; font-style: italic;">ggtheme</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">theme_classic</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
	         <span style="color: #05c6e3; font-style: italic;"># Use the "Clusters" variable for coloring the points</span>
                 <span style="color: #ebedf0; font-style: italic;">color</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Clusters"</span><span style="color: #ebedf0; font-style: italic;">,</span>
	         <span style="color: #05c6e3; font-style: italic;"># Set the color palette for the points</span>
                 <span style="color: #ebedf0; font-style: italic;">palette</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">my_pal</span><span style="color: #ebedf0; font-style: italic;">,</span>
	         <span style="color: #05c6e3; font-style: italic;"># Set the size of the points</span>
                 <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">1.5</span><span style="color: #ebedf0; font-style: italic;">,</span> 
	         <span style="color: #05c6e3; font-style: italic;"># Display ellipses around the points</span>
                 <span style="color: #ebedf0; font-style: italic;">ellipse</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">TRUE</span><span style="color: #ebedf0; font-style: italic;">,</span>
	         <span style="color: #05c6e3; font-style: italic;"># Set the type of ellipse to "convex"</span>
                 <span style="color: #ebedf0; font-style: italic;">ellipse.type</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"convex"</span><span style="color: #ebedf0; font-style: italic;">,</span>
	         <span style="color: #05c6e3; font-style: italic;"># Enable point label repulsion to avoid overlapping labels</span>
                 <span style="color: #ebedf0; font-style: italic;">repel</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">TRUE</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Customize the appearance of the axes, text, and title</span>
  <span style="color: #05c6e3; font-style: italic;"># Add the theme and labels to the ggplot object</span>
  <span style="color: #ebedf0; font-style: italic;">g</span> <span style="color: #68affc; font-style: italic;">+</span> <span style="color: #ebedf0; font-style: italic;">theme</span><span style="color: #68affc; font-style: italic;">(</span>
    <span style="color: #05c6e3; font-style: italic;"># Customize axis text</span>
    <span style="color: #ebedf0; font-style: italic;">axis.text</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
    <span style="color: #05c6e3; font-style: italic;"># Customize x-axis text</span>
    <span style="color: #ebedf0; font-style: italic;">axis.text.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
    <span style="color: #05c6e3; font-style: italic;"># Customize y-axis text</span>
    <span style="color: #ebedf0; font-style: italic;">axis.text.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
    <span style="color: #05c6e3; font-style: italic;"># Customize subtitle</span>
    <span style="color: #ebedf0; font-style: italic;">plot.subtitle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">hjust</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.5</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
    <span style="color: #05c6e3; font-style: italic;"># Customize y-axis title</span>
    <span style="color: #ebedf0; font-style: italic;">axis.title.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">90</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
    <span style="color: #05c6e3; font-style: italic;"># Customize x-axis title</span>
    <span style="color: #ebedf0; font-style: italic;">axis.title.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">00</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Set the subtitle of the plot as "MDS plot"</span>
    <span style="color: #ebedf0; font-style: italic;">labs</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">subtitle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"MDS plot"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #68affc; font-style: italic;">}</span>



<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">##################################################### 11- CochranQTest Function ######################################################</span> ##################################################### 11- CochranQTest Function ###################################################### 
<span style="color: #05c6e3; font-style: italic;"># CochranQTest: Perform Cochran's Q Test on multiple studies</span> 

<span style="color: #05c6e3; font-style: italic;"># Input:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - studies: A list of matrices representing different studies</span>
<span style="color: #05c6e3; font-style: italic;">#   - groups: A vector specifying the comparison groups (e.g., grade1 vs grade3)</span> 
<span style="color: #05c6e3; font-style: italic;">#   - compare: A string indicating the type of comparison (e.g., "grade")</span> 

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - A list containing the mean and variance for each comparison mode</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># Cochran's Q Test: Perform statistical analysis to compare proportions across multiple groups</span> 

<span style="color: #05c6e3; font-style: italic;"># This function performs Cochran's Q Test on multiple studies to compare proportions across different groups.</span> 
<span style="color: #05c6e3; font-style: italic;"># It takes a list of matrices representing different studies, a vector specifying the comparison groups,</span>  
<span style="color: #05c6e3; font-style: italic;"># and a string indicating the type of comparison. The function calculates the mean and variance for each comparison mode</span>  
<span style="color: #05c6e3; font-style: italic;"># and returns them as a list. Cochran's Q Test is a statistical test used to determine if there are significant differences</span>  
<span style="color: #05c6e3; font-style: italic;"># in proportions between multiple groups. It helps to assess the homogeneity of proportions across the groups and</span>  
<span style="color: #05c6e3; font-style: italic;"># identify any significant departures from the null hypothesis of equal proportions.</span> 
	
<span style="color: #ebedf0; font-style: italic;">CochranQTest</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">groups</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span> <span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  <span style="color: #05c6e3; font-style: italic;"># Set the random seed for reproducibility</span>
  <span style="color: #ebedf0; font-style: italic;">set.seed</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">1234</span><span style="color: #68affc; font-style: italic;">)</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Reading matrix and phenotype:</span>
  <span style="color: #05c6e3; font-style: italic;"># Initialize a list to store the mean values for each study</span>
  <span style="color: #ebedf0; font-style: italic;">d.adj.Split</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># List to store variance values for each study</span>
  <span style="color: #ebedf0; font-style: italic;">var.d.adj.Split</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Iterate over each study in the 'studies' list</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #05c6e3; font-style: italic;"># Get the matrix for the current study</span>
    <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span>

    <span style="color: #05c6e3; font-style: italic;"># Check if the matrix has an "ID" column, and if so, handle it accordingly</span>
    <span style="color: #05c6e3; font-style: italic;"># (e.g., setting row names and removing the ID column)</span>
    <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"ID"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
      <span style="color: #05c6e3; font-style: italic;"># Set row names to the values in the first column</span>
      <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
      <span style="color: #05c6e3; font-style: italic;"># Remove the first column from the matrix</span>
      <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #68affc; font-style: italic;">}</span>
	
    <span style="color: #05c6e3; font-style: italic;"># Read the phenotype file for the corresponding comparison type:</span>
    <span style="color: #05c6e3; font-style: italic;"># Read the phenotype file</span>
    <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">read_csv</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"phenotype/phenotype_"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">".csv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Convert the read data into a data frame</span>
    <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Select the samples from the phenotype file that match the column names in the matrix:</span>
    <span style="color: #05c6e3; font-style: italic;"># Identify the matching column indices</span>
    <span style="color: #ebedf0; font-style: italic;">paired_pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Sample</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Select the rows that correspond to the matched samples</span>
    <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">paired_pheno</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>

    <span style="color: #05c6e3; font-style: italic;"># Identify the rows with missing values in the "grade" column</span>
    <span style="color: #ebedf0; font-style: italic;">na_row</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">is.na</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>


	
    <span style="color: #05c6e3; font-style: italic;"># Check if there are any rows with missing values in the "grade" column</span>
    <span style="color: #05c6e3; font-style: italic;"># and handle the missing values accordingly (e.g., removing corresponding rows and columns)</span>
    <span style="color: #05c6e3; font-style: italic;"># Check if the length of 'na_row' is greater than zero (if there are any missing values in the 'na_row' variable)</span>
    <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">na_row</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">></span> <span style="color: #cf4275; font-style: italic;">0</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
      <span style="color: #05c6e3; font-style: italic;"># Get the sample IDs with missing values</span>
      <span style="color: #ebedf0; font-style: italic;">na_samp</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">na_row</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
      <span style="color: #05c6e3; font-style: italic;"># Identify the matching column indices in the matrix</span>
      <span style="color: #ebedf0; font-style: italic;">na_colm</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">na_samp</span><span style="color: #68affc; font-style: italic;">)</span>
      <span style="color: #05c6e3; font-style: italic;"># Remove the rows with missing values from the phenotype data</span>
      <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">na_row</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
      <span style="color: #05c6e3; font-style: italic;"># Remove the corresponding columns from the matrix</span>
      <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span>  <span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">na_colm</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #68affc; font-style: italic;">}</span>

    <span style="color: #05c6e3; font-style: italic;"># Calculating the number of each comparison mode (grade1 vs grade3):</span>
    <span style="color: #05c6e3; font-style: italic;"># Empty list to store the factor levels (0 and 1) for each comparison group</span>
    <span style="color: #ebedf0; font-style: italic;">g_list</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Empty list to store the sample IDs for each comparison group</span>
    <span style="color: #ebedf0; font-style: italic;">sampleid</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Iterate over the comparison groups and perform operations for each group</span>
    <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">j</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">groups</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
      <span style="color: #05c6e3; font-style: italic;"># Identify the rows with the specified group</span> 
      <span style="color: #ebedf0; font-style: italic;">g_row</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">groups</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">j</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
      <span style="color: #05c6e3; font-style: italic;"># Get the sample IDs for the specified group</span> 
      <span style="color: #ebedf0; font-style: italic;">s_id</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">g_row</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
      <span style="color: #05c6e3; font-style: italic;"># Store the sample IDs for the comparison group</span> 
      <span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">j</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">s_id</span>
      <span style="color: #05c6e3; font-style: italic;"># Create the factor levels for the comparison group</span> 
      <span style="color: #ebedf0; font-style: italic;">g_list</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">j</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">factor</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rep</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">j</span> <span style="color: #68affc; font-style: italic;">-</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">g_row</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #68affc; font-style: italic;">}</span>
	
    <span style="color: #05c6e3; font-style: italic;"># Applying those modes and calculating the mean and variance for Cochran' Q Test</span> 
    <span style="color: #05c6e3; font-style: italic;"># Unlist the factor levels for all comparison groups to create a single vector of factor levels</span> 
    <span style="color: #ebedf0; font-style: italic;">spl</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">unlist</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">g_list</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Unlist the sample IDs for all comparison groups</span> 
    <span style="color: #ebedf0; font-style: italic;">spsam</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">unlist</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Select the columns in the matrix corresponding to the sample IDs</span> 
    <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">spsam</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #05c6e3; font-style: italic;"># Convert the matrix to a matrix object</span>
    <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">as.matrix</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Calculate the mean difference for each comparison mode</span> 
    <span style="color: #ebedf0; font-style: italic;">d.Split</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">getdF</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">spl</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Calculate the overall mean difference</span>
    <span style="color: #ebedf0; font-style: italic;">mean_d</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">dstar</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">d.Split</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">spl</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Store the mean difference for the current study</span> 
    <span style="color: #ebedf0; font-style: italic;">d.adj.Split</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">mean_d</span>
    <span style="color: #05c6e3; font-style: italic;"># Calculate the variance</span> 
    <span style="color: #ebedf0; font-style: italic;">var_d</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">sigmad</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">mean_d</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">sum</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">spl</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #cf4275; font-style: italic;">0</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">sum</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">spl</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Store the variance for the current study</span> 
    <span style="color: #ebedf0; font-style: italic;">var.d.adj.Split</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">var_d</span>
  <span style="color: #68affc; font-style: italic;">}</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Create a list containing the mean and variance values</span> 
  <span style="color: #ebedf0; font-style: italic;">output</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">d.adj.Split</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">var.d.adj.Split</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Return the output as a list containing mean differences and variances</span> 	
  <span style="color: #ebedf0; font-style: italic;">return</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">output</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Display a message indicating the completion of the analysis</span> 	
  <span style="color: #ebedf0; font-style: italic;">message</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"Analysis has completed."</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #68affc; font-style: italic;">}</span>



<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">###################################################### 12- MakeQQPlot Function #######################################################</span>  
<span style="color: #05c6e3; font-style: italic;"># MakeQQPlot: Generate a QQ plot for Cochran's Q Test</span> 

<span style="color: #05c6e3; font-style: italic;"># Input:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - cohranq: Output from CochranQTest function (list of means and variances)</span> 
<span style="color: #05c6e3; font-style: italic;">#   - nstudies: Number of studies</span> 

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - QQ plot</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function generates a QQ plot for Cochran's Q Test. It takes the output from the CochranQTest function,</span>  
<span style="color: #05c6e3; font-style: italic;"># which is a list of means and variances, and the number of studies as input. The function calculates the quantiles</span>  
<span style="color: #05c6e3; font-style: italic;"># of the chi-square distribution and the quantiles of the sample, and then plots them on a QQ plot.</span>  
<span style="color: #05c6e3; font-style: italic;"># A QQ plot (quantile-quantile plot) is used to assess whether a dataset follows a specific theoretical distribution</span>  
<span style="color: #05c6e3; font-style: italic;"># by comparing the observed quantiles against the expected quantiles. In this case, the QQ plot helps to visualize </span> 
<span style="color: #05c6e3; font-style: italic;"># the goodness-of-fit between the observed Cochran's Q statistics and the expected chi-square distribution.</span>  
<span style="color: #05c6e3; font-style: italic;"># Deviations from the diagonal reference line indicate departures from the expected distribution.</span> 
	
<span style="color: #ebedf0; font-style: italic;">MakeQQPlot</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">cohranq</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">nstudies</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  <span style="color: #05c6e3; font-style: italic;"># Unpack the previous list into data frames for means and variances</span> 
  <span style="color: #05c6e3; font-style: italic;"># Extract the means from the output list</span> 
  <span style="color: #ebedf0; font-style: italic;">output1</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cohranq</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> 
  <span style="color: #05c6e3; font-style: italic;"># Extract the variances from the output list</span>
  <span style="color: #ebedf0; font-style: italic;">output2</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cohranq</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">2</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #05c6e3; font-style: italic;"># Combine the means into a data frame</span>	
  <span style="color: #ebedf0; font-style: italic;">mymns</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">do.call</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">output1</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Combine the variances into a data frame</span>
  <span style="color: #ebedf0; font-style: italic;">myvars</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">do.call</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">output2</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Calculate Cochran's Q Test:</span>
  <span style="color: #05c6e3; font-style: italic;"># Compute Cochran's Q Test using means and variances</span>
  <span style="color: #ebedf0; font-style: italic;">my.Q</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">f.Q</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">mymns</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">myvars</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Store the number of studies for later use</span>
  <span style="color: #ebedf0; font-style: italic;">nstudies</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">nstudies</span>

	
  <span style="color: #05c6e3; font-style: italic;"># Calculate quantiles of the chi-square distribution</span>
  <span style="color: #ebedf0; font-style: italic;">chisqq</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">qchisq</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">seq</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">0</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">.9999</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">.001</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">df</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">nstudies</span><span style="color: #68affc; font-style: italic;">-</span>1<span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Calculate quantiles of the sample</span>
  <span style="color: #ebedf0; font-style: italic;">tmp</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">quantile</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">my.Q</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">seq</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">0</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">.9999</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">.001</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Create a data frame for QQ plot data</span>
  <span style="color: #ebedf0; font-style: italic;">qq</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">chisqq</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">chisqq</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">tmp</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">tmp</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Plotting the QQ plot:</span>
  <span style="color: #05c6e3; font-style: italic;"># Set data and aesthetics for the plot</span>
  <span style="color: #ebedf0; font-style: italic;">ggplot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">data</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">qq</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">aes</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">chisqq</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">tmp</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">color</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #1B9E77; font-style: italic; padding: 2px;">#1B9E77</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Add points to the plot</span>
    <span style="color: #ebedf0; font-style: italic;">geom_point</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Add a diagonal reference line to the plot</span>
    <span style="color: #ebedf0; font-style: italic;">geom_abline</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Apply a classic theme to the plot</span>
    <span style="color: #ebedf0; font-style: italic;">theme_classic</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Set labels for x and y axes</span>
    <span style="color: #ebedf0; font-style: italic;">labs</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">'quantiles of Chi square'</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">'quantiles of Sample'</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Customize the appearance of the axes, text, and title</span>
    <span style="color: #ebedf0; font-style: italic;">theme</span><span style="color: #68affc; font-style: italic;">(</span>
      <span style="color: #05c6e3; font-style: italic;"># Customize axis text appearance</span>
      <span style="color: #ebedf0; font-style: italic;">axis.text</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
      <span style="color: #05c6e3; font-style: italic;"># Customize x-axis text appearance</span>
      <span style="color: #ebedf0; font-style: italic;">axis.text.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
      <span style="color: #05c6e3; font-style: italic;"># Customize y-axis text appearance</span>
      <span style="color: #ebedf0; font-style: italic;">axis.text.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
      <span style="color: #05c6e3; font-style: italic;"># Customize plot subtitle appearance</span>
      <span style="color: #ebedf0; font-style: italic;">plot.subtitle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">hjust</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.5</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
      <span style="color: #05c6e3; font-style: italic;"># Customize y-axis title appearance</span>
      <span style="color: #ebedf0; font-style: italic;">axis.title.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">90</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
      <span style="color: #05c6e3; font-style: italic;"># Customize x-axis title appearance</span>
      <span style="color: #ebedf0; font-style: italic;">axis.title.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">00</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
      <span style="color: #05c6e3; font-style: italic;"># Remove the legend</span>
      <span style="color: #ebedf0; font-style: italic;">legend.position</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #2ad43b; font-style: italic;">"none"</span>
    <span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #05c6e3; font-style: italic;"># Set the plot subtitle</span>
    <span style="color: #ebedf0; font-style: italic;">labs</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">subtitle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"QQ Plot"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #68affc; font-style: italic;">}</span> 



<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">##################################################### 13- FEMREMAnalysis Function#####################################################</span> 
<span style="color: #05c6e3; font-style: italic;"># FEMREMAnalysis: Perform FEM-REM meta-analysis</span> 

<span style="color: #05c6e3; font-style: italic;"># Input:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - studies: A list of expression matrices from different studies</span> 
<span style="color: #05c6e3; font-style: italic;">#   - projname: Names of the projects or studies</span> 
<span style="color: #05c6e3; font-style: italic;">#   - compare: Comparison mode (e.g., "grade1_vs_grade3")</span>
<span style="color: #05c6e3; font-style: italic;">#   - groups: List of comparison groups</span> 
<span style="color: #05c6e3; font-style: italic;">#   - model: Model selection ("FEM" for fixed effects model, "REM" for random effects model)</span> 
<span style="color: #05c6e3; font-style: italic;">#   - FDR: False discovery rate threshold for filtering genes</span> 
<span style="color: #05c6e3; font-style: italic;">#   - nperm: Number of permutations for z-score calculation</span> 

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - Meta-analysis results</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function performs FEM-REM meta-analysis on expression matrices from different studies.</span>  
<span style="color: #05c6e3; font-style: italic;"># It takes as input a list of expression matrices, names of the projects or studies, a comparison mode,</span>  
<span style="color: #05c6e3; font-style: italic;"># a list of comparison groups, a model selection (FEM for fixed effects model or REM for random effects model),</span>  
<span style="color: #05c6e3; font-style: italic;"># a false discovery rate (FDR) threshold for gene filtering, and the number of permutations for z-score calculation.</span> 

<span style="color: #05c6e3; font-style: italic;"># The function first creates folders to store the meta-analysis results. It reads the phenotype file for the comparison</span>  
<span style="color: #05c6e3; font-style: italic;"># mode and the annotation files for each project. It then performs data preprocessing, including handling missing values</span> 
<span style="color: #05c6e3; font-style: italic;"># and filtering based on comparison groups. The expression matrices, class labels, and annotation data are prepared for analysis.</span>   

<span style="color: #05c6e3; font-style: italic;"># Next, the function determines the type of analysis based on the model selection and performs z-score calculation using </span>
<span style="color: #05c6e3; font-style: italic;"># the zScoreFDR function. The two-sided scores are extracted and combined with annotation information.</span>  
<span style="color: #05c6e3; font-style: italic;"># Missing gene symbols are removed, and the data frame is subsetted, counted, and checked for duplicated gene symbols. </span>  
<span style="color: #05c6e3; font-style: italic;"># For duplicated gene symbols, average expression values and associated information are calculated and stored. </span> 
<span style="color: #05c6e3; font-style: italic;"># The averaged genes are combined with unique genes into a single data frame, sorted by z-score in descending order, and written to files.</span> 

<span style="color: #05c6e3; font-style: italic;"># The function also performs FDR filtering on the data frame, writes the filtered results to files,</span> 
<span style="color: #05c6e3; font-style: italic;"># and displays summary information for each project. The completion message is displayed when the analysis is finished.</span> 
	
<span style="color: #ebedf0; font-style: italic;">FEMREMAnalysis</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">groups</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">model</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">FDR</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">nperm</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  <span style="color: #05c6e3; font-style: italic;"># Set the random seed for reproducibility</span>
  <span style="color: #ebedf0; font-style: italic;">set.seed</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">1234</span><span style="color: #68affc; font-style: italic;">)</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Creating folders for meta-analysis results:</span>
  <span style="color: #05c6e3; font-style: italic;"># Create MetaAnalysis folder</span>
  <span style="color: #ebedf0; font-style: italic;">dir.create</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">showWarnings</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Create filtered subfolder</span>	
  <span style="color: #ebedf0; font-style: italic;">dir.create</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/filtered"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">showWarnings</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Create volcano subfolder</span>
  <span style="color: #ebedf0; font-style: italic;">dir.create</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/volcano"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">showWarnings</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Reading phenotype file</span>
  <span style="color: #ebedf0; font-style: italic;">phenotype</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">read_csv</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"phenotype/phenotype_"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">".csv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">phenotype</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">phenotype</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Reading annotation file for each project:</span>
  <span style="color: #05c6e3; font-style: italic;"># Initialize an empty list to store annotations for each project</span>
  <span style="color: #ebedf0; font-style: italic;">annotations</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Iterate over each project to process annotations</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #05c6e3; font-style: italic;"># Read annotation file</span>
    <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">read_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"annot.tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Convert to data frame</span>
    <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Set row names</span>
    <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #05c6e3; font-style: italic;"># Remove the first column</span>
    <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #05c6e3; font-style: italic;"># Select specific columns</span>
    <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">[</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"Gene.symbol"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"Chromosome.location"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GO.Function"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #05c6e3; font-style: italic;"># Combine row names and data</span>
    <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Rename the first column</span>
    <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"ID"</span> 
    <span style="color: #05c6e3; font-style: italic;"># Order by ID column</span>
    <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">order</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">ID</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #05c6e3; font-style: italic;"># Store annotation data in a list</span>
    <span style="color: #ebedf0; font-style: italic;">annotations</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">annot</span>
  <span style="color: #68affc; font-style: italic;">}</span>

  <span style="color: #05c6e3; font-style: italic;"># Perform intersection of annotations</span>	
  <span style="color: #ebedf0; font-style: italic;">an</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">Reduce</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">intersect</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">annotations</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Combine annotations into a data frame</span>
  <span style="color: #ebedf0; font-style: italic;">annotations</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">do.call</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">an</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Create a list to store expression matrices</span>
  <span style="color: #ebedf0; font-style: italic;">matrices_list</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Create a list to store class labels</span>	
  <span style="color: #ebedf0; font-style: italic;">Class</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Iterate over each study to process data</span>	
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #05c6e3; font-style: italic;"># Get the expression matrix for the current study</span>
    <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">studies</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #05c6e3; font-style: italic;"># Check if the matrix has an "ID" column</span>
    <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"ID"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
      <span style="color: #05c6e3; font-style: italic;"># Set row names from the first column</span>
      <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
      <span style="color: #05c6e3; font-style: italic;"># Remove the first column</span>
      <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #68affc; font-style: italic;">}</span>
	
    <span style="color: #05c6e3; font-style: italic;"># Data preprocessing and cleaning for phenotype and gene expression matrices:</span>
    <span style="color: #05c6e3; font-style: italic;"># Identify the indices of samples in the phenotype matching matrix that are present in the column names of the matrix</span>
    <span style="color: #ebedf0; font-style: italic;">paired_pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">phenotype</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Sample</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Subset the phenotype data frame to include only the rows corresponding to the identified samples</span>
    <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">phenotype</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">paired_pheno</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #05c6e3; font-style: italic;"># Identify the indices of rows in the phenotype data frame where the grade column contains missing values (NA)</span>
    <span style="color: #ebedf0; font-style: italic;">na_row</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">is.na</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
	
   <span style="color: #05c6e3; font-style: italic;"># Check if there are any missing values in the rows of the phenotype data</span>
   <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">na_row</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">></span> <span style="color: #cf4275; font-style: italic;">0</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
      <span style="color: #05c6e3; font-style: italic;"># Get the sample IDs with missing grade values</span>
      <span style="color: #ebedf0; font-style: italic;">na_samp</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">na_row</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
      <span style="color: #05c6e3; font-style: italic;"># Get the corresponding column indices</span>
      <span style="color: #ebedf0; font-style: italic;">na_colm</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">na_samp</span><span style="color: #68affc; font-style: italic;">)</span>
      <span style="color: #05c6e3; font-style: italic;"># Remove rows with missing grade values from phenotype</span>
      <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">na_row</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
      <span style="color: #05c6e3; font-style: italic;"># Remove columns with missing grade values from matrix</span>
      <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span>  <span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">na_colm</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #68affc; font-style: italic;">}</span>
    
    <span style="color: #05c6e3; font-style: italic;"># Calculating the number of each comparison mode (grade1 vs grade3):</span>
    <span style="color: #05c6e3; font-style: italic;"># Create a list to store comparison groups</span>
    <span style="color: #ebedf0; font-style: italic;">g_list</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Create a list to store sample IDs</span>
    <span style="color: #ebedf0; font-style: italic;">sampleid</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Iterate over each group to process comparisons</span>
    <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">j</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">groups</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
      <span style="color: #05c6e3; font-style: italic;"># Identify rows matching the current comparison group</span>
      <span style="color: #ebedf0; font-style: italic;">g_row</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">groups</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">j</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
      <span style="color: #05c6e3; font-style: italic;"># Get the sample IDs for the current group</span>
      <span style="color: #ebedf0; font-style: italic;">s_id</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">g_row</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
      <span style="color: #05c6e3; font-style: italic;"># Store sample IDs in the list</span>
      <span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">j</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">s_id</span>
      <span style="color: #05c6e3; font-style: italic;"># Create factor levels for the current group</span>
      <span style="color: #ebedf0; font-style: italic;">g_list</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">j</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">factor</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rep</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">j</span> <span style="color: #68affc; font-style: italic;">-</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">g_row</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #68affc; font-style: italic;">}</span>
	
    <span style="color: #05c6e3; font-style: italic;"># Prepare factor levels, sample IDs, and expression matrix for analysis:</span>
    <span style="color: #05c6e3; font-style: italic;"># Unlist the factor levels for all comparison groups</span>
    <span style="color: #ebedf0; font-style: italic;">spl</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">unlist</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">g_list</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Convert factor levels to numeric</span>
    <span style="color: #ebedf0; font-style: italic;">spl</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">as.numeric</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">as.character</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">spl</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Store class labels for the current study</span>
    <span style="color: #ebedf0; font-style: italic;">Class</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">spl</span>
    <span style="color: #05c6e3; font-style: italic;"># Unlist the sample IDs for all comparison groups</span>
    <span style="color: #ebedf0; font-style: italic;">spsam</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">unlist</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Subset the matrix using the selected sample IDs</span>
    <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">spsam</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #05c6e3; font-style: italic;"># Convert to matrix class</span>
    <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">as.matrix</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Create an ExpressionSet object</span>
    <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">ExpressionSet</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">assayData</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Store the expression matrix in the list</span>
    <span style="color: #ebedf0; font-style: italic;">matrices_list</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span>
  <span style="color: #68affc; font-style: italic;">}</span>
 
  <span style="color: #05c6e3; font-style: italic;"># Determine the type of analysis based on the model type (FEM or REM):</span>
  <span style="color: #05c6e3; font-style: italic;"># Check if the model type is FEM for Fixed Effects Model analysis:</span>
  <span style="color: #05c6e3; font-style: italic;"># - If the selected model is 'FEM' (Fixed Effects Model), set the useREM flag to FALSE.</span>
  <span style="color: #05c6e3; font-style: italic;"># - This flag is used to indicate the use of the Fixed Effects Model in subsequent analysis.	</span>
  <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">model</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">'FEM'</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #05c6e3; font-style: italic;"># Set useREM flag to FALSE for FEM model (indicating the use of Fixed Effects Model)</span>
    <span style="color: #ebedf0; font-style: italic;">useREM</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #cf4275; font-style: italic;">FALSE</span>
  <span style="color: #68affc; font-style: italic;">}</span> 

  <span style="color: #05c6e3; font-style: italic;"># - If the selected model is 'REM' (Random Effects Model), set the useREM flag to TRUE.</span>
  <span style="color: #05c6e3; font-style: italic;"># - This flag is used to indicate the use of the Random Effects Model in subsequent analysis.</span>
  <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">model</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">'REM'</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #05c6e3; font-style: italic;"># Set useREM flag to TRUE for REM model (indicating the use of Random Effects Model)</span>
    <span style="color: #ebedf0; font-style: italic;">useREM</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #cf4275; font-style: italic;">TRUE</span>
  <span style="color: #68affc; font-style: italic;">}</span>

  <span style="color: #05c6e3; font-style: italic;"># Perform z-score calculation</span>	
  <span style="color: #ebedf0; font-style: italic;">ScoresFDR</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">zScoreFDR</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrices_list</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">Class</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">useREM</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">useREM</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">nperm</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">nperm</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Get the two-sided scores</span>
  <span style="color: #ebedf0; font-style: italic;">twosided</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">ScoresFDR</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #2ad43b; font-style: italic;">"two.sided"</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Sort by row names</span>
  <span style="color: #ebedf0; font-style: italic;">twosided</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">twosided</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">order</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">twosided</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Identify matching annotations and add annotation information:</span>
  <span style="color: #05c6e3; font-style: italic;"># Identify matching annotations</span>
  <span style="color: #ebedf0; font-style: italic;">anno_row</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">annotations</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">ID</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">twosided</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Add annotation information</span>
  <span style="color: #ebedf0; font-style: italic;">twosided</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">twosided</span><span style="color: #ebedf0; font-style: italic;">,</span>  <span style="color: #ebedf0; font-style: italic;">annotations</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">anno_row</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">2</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">3</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">4</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Removing missing gene symbols:</span>
  <span style="color: #05c6e3; font-style: italic;"># Identify missing gene symbols</span>
  <span style="color: #ebedf0; font-style: italic;">genemissing</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">is.na</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">twosided</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">TRUE</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Remove rows with missing gene symbols</span>
  <span style="color: #ebedf0; font-style: italic;">twosided</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">twosided</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">genemissing</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>

  <span style="color: #05c6e3; font-style: italic;"># Subset, Count, and Identify Duplicated Gene Symbols:</span>
  <span style="color: #05c6e3; font-style: italic;"># Subset columns</span>
  <span style="color: #ebedf0; font-style: italic;">combination</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">twosided</span><span style="color: #68affc; font-style: italic;">[</span> <span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"zSco"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"FDR"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"Gene.symbol"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"Chromosome.location"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GO.Function"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #05c6e3; font-style: italic;"># Count duplicated gene symbols</span>
  <span style="color: #ebedf0; font-style: italic;">dupgene_freq</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">table</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">combination</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Get duplicated gene symbols</span>
  <span style="color: #ebedf0; font-style: italic;">only_dupgene</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">dupgene_freq</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">dupgene_freq</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Freq</span><span style="color: #68affc; font-style: italic;">></span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #05c6e3; font-style: italic;"># Identify rows with duplicated gene symbols</span>
  <span style="color: #ebedf0; font-style: italic;">only_dupgene_row</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">combination</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">only_dupgene</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Subset rows with duplicated gene symbols</span>
  <span style="color: #ebedf0; font-style: italic;">duplicat_deg</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">combination</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">only_dupgene_row</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>

  <span style="color: #05c6e3; font-style: italic;"># Calculate and store the average expression values and associated information for each gene symbol with duplicated entries</span> 
  <span style="color: #05c6e3; font-style: italic;"># Create an empty list to store averaged genes</span>
  <span style="color: #ebedf0; font-style: italic;">averaged_genes</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Iterate over each duplicated gene symbol</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">b</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">:</span><span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">only_dupgene</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #05c6e3; font-style: italic;"># Identify rows for the current duplicated gene</span>
    <span style="color: #ebedf0; font-style: italic;">d_row</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">duplicat_deg</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">only_dupgene</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">b</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Calculate column means</span>
    <span style="color: #ebedf0; font-style: italic;">col_mean</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">colMeans</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">duplicat_deg</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">d_row</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">:</span><span style="color: #cf4275; font-style: italic;">2</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Combine column means with other columns</span>
    <span style="color: #ebedf0; font-style: italic;">col_all</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">col_mean</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">duplicat_deg</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">d_row</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">3</span><span style="color: #68affc; font-style: italic;">:</span><span style="color: #cf4275; font-style: italic;">5</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Store the averaged gene information</span>
    <span style="color: #ebedf0; font-style: italic;">averaged_genes</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">b</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">col_all</span>
  <span style="color: #68affc; font-style: italic;">}</span>
 
  <span style="color: #05c6e3; font-style: italic;"># Combine averaged genes into a single data frame</span>
  <span style="color: #ebedf0; font-style: italic;">averaged_genes</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">do.call</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">averaged_genes</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Combine the rows representing unique gene symbols with the rows representing averaged genes:</span>
  <span style="color: #05c6e3; font-style: italic;"># Subset rows with unique gene symbols</span>
  <span style="color: #ebedf0; font-style: italic;">unique_deg</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">combination</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">only_dupgene_row</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #05c6e3; font-style: italic;"># Combine unique genes and averaged genes</span>
  <span style="color: #ebedf0; font-style: italic;">all_unique_genes_combi</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">unique_deg</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">averaged_genes</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #05c6e3; font-style: italic;"># Reset row names</span>
  <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_unique_genes_combi</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #cf4275; font-style: italic;">NULL</span> 

  <span style="color: #05c6e3; font-style: italic;"># Sort the data frame by z-score in descending order</span>
  <span style="color: #ebedf0; font-style: italic;">all_unique_genes_combi</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">all_unique_genes_combi</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">order</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_unique_genes_combi</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">decreasing</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">TRUE</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #05c6e3; font-style: italic;"># Write the result to a file</span>
  <span style="color: #ebedf0; font-style: italic;">write_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_unique_genes_combi</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/volcano/combination.tsv"</span><span style="color: #68affc; font-style: italic;">)</span>
	
  <span style="color: #05c6e3; font-style: italic;"># Filter the data frame based on FDR threshold</span>
  <span style="color: #ebedf0; font-style: italic;">all_unique_genes_combi</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">all_unique_genes_combi</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_unique_genes_combi</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"FDR"</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><</span> <span style="color: #ebedf0; font-style: italic;">FDR</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #05c6e3; font-style: italic;"># Write the filtered result to a file</span>
  <span style="color: #ebedf0; font-style: italic;">write_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_unique_genes_combi</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/filtered/combination.tsv"</span><span style="color: #68affc; font-style: italic;">)</span>
  
  <span style="color: #05c6e3; font-style: italic;"># Seperating each study, averaging duplicated genes</span>
  <span style="color: #05c6e3; font-style: italic;"># Get column indices for FDR values</span>
  <span style="color: #ebedf0; font-style: italic;">sfdr</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">grep</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"FDR_Ex_{0-9}"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">twosided</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #05c6e3; font-style: italic;"># Iterate over the indices of sfdr</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">sfdr</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #05c6e3; font-style: italic;"># Get column indices for gene symbols</span>
    <span style="color: #ebedf0; font-style: italic;">gs_col</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">grep</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"Gene.symbol|Chromosome.location|GO.Function"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">twosided</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #05c6e3; font-style: italic;"># Subset columns for the current study</span>
    <span style="color: #ebedf0; font-style: italic;">common</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">twosided</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">sfdr</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">sfdr</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">gs_col</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">]</span>

    <span style="color: #05c6e3; font-style: italic;"># Rename columns with project names</span>
    <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">common</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">:</span><span style="color: #cf4275; font-style: italic;">2</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">gsub</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"Ex_."</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">common</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">:</span><span style="color: #cf4275; font-style: italic;">2</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Perform operations on duplicated gene symbols if there are multiple rows in the common data frame:</span>
    <span style="color: #05c6e3; font-style: italic;"># Check if there are multiple rows in the common data frame</span>
    <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">nrow</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">common</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">></span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span> 
      <span style="color: #05c6e3; font-style: italic;"># Count duplicated gene symbols</span>
      <span style="color: #ebedf0; font-style: italic;">dupgene_freq</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">table</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">common</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
      <span style="color: #05c6e3; font-style: italic;"># Get duplicated gene symbols</span>
      <span style="color: #ebedf0; font-style: italic;">only_dupgene</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">dupgene_freq</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">dupgene_freq</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Freq</span><span style="color: #68affc; font-style: italic;">></span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
      <span style="color: #05c6e3; font-style: italic;"># Identify rows with duplicated gene symbols</span>
      <span style="color: #ebedf0; font-style: italic;">only_dupgene_row</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">common</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">only_dupgene</span><span style="color: #68affc; font-style: italic;">)</span>
      <span style="color: #05c6e3; font-style: italic;"># Subset rows with duplicated gene symbols</span>
      <span style="color: #ebedf0; font-style: italic;">duplicat_deg</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">common</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">only_dupgene_row</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>

      <span style="color: #05c6e3; font-style: italic;"># Iterate over each duplicated gene symbol, calculate column means, and store the averaged gene information in a list:</span>
      <span style="color: #05c6e3; font-style: italic;"># Create a list to store averaged genes</span>
      <span style="color: #ebedf0; font-style: italic;">averaged_genes</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>

      <span style="color: #05c6e3; font-style: italic;"># Iterate over each duplicated gene symbol</span>
      <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">b</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">:</span><span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">only_dupgene</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
	<span style="color: #05c6e3; font-style: italic;"># Identify rows for the current duplicated gene</span>
        <span style="color: #ebedf0; font-style: italic;">d_row</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">duplicat_deg</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">only_dupgene</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">b</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
	<span style="color: #05c6e3; font-style: italic;"># Calculate column means</span>
        <span style="color: #ebedf0; font-style: italic;">col_mean</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">colMeans</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">duplicat_deg</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">d_row</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;"><span style="color: #cf4275; font-style: italic;">1</span></span><span style="color: #68affc; font-style: italic;">:</span><span style="color: #cf4275; font-style: italic;">2</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
	<span style="color: #05c6e3; font-style: italic;"># Combine column means with other columns</span>
        <span style="color: #ebedf0; font-style: italic;">col_all</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">col_mean</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">duplicat_deg</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">d_row</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;"><span style="color: #cf4275; font-style: italic;">1</span></span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">3</span><span style="color: #68affc; font-style: italic;">:</span><span style="color: #cf4275; font-style: italic;">5</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
	<span style="color: #05c6e3; font-style: italic;"># Store the averaged gene information</span>
        <span style="color: #ebedf0; font-style: italic;">averaged_genes</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">b</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">col_all</span>
      <span style="color: #68affc; font-style: italic;">}</span>

      <span style="color: #05c6e3; font-style: italic;"># Combine averaged genes and unique genes into a single data frame and sort by z-score in descending order:</span>
      <span style="color: #05c6e3; font-style: italic;"># Combine averaged genes into a single data frame</span>
      <span style="color: #ebedf0; font-style: italic;">averaged_genes</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">do.call</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">averaged_genes</span><span style="color: #68affc; font-style: italic;">)</span>
      <span style="color: #05c6e3; font-style: italic;"># Subset rows with unique gene symbols</span>
      <span style="color: #ebedf0; font-style: italic;">unique_deg</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">common</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">only_dupgene_row</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
      <span style="color: #05c6e3; font-style: italic;"># Combine unique genes and averaged genes</span>
      <span style="color: #ebedf0; font-style: italic;">all_unique_genes</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">unique_deg</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">averaged_genes</span><span style="color: #68affc; font-style: italic;">)</span>
      <span style="color: #05c6e3; font-style: italic;"># Reset row names</span>
      <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_unique_genes</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #cf4275; font-style: italic;">NULL</span> 
      <span style="color: #05c6e3; font-style: italic;"># Sort the genes by z-score in descending order</span>
      <span style="color: #ebedf0; font-style: italic;">all_unique_genes</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">all_unique_genes</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">order</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_unique_genes</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;"><span style="color: #cf4275; font-style: italic;">1</span></span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">decreasing</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">TRUE</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>

      <span style="color: #05c6e3; font-style: italic;"># Write the result to a tsv file</span>
      <span style="color: #ebedf0; font-style: italic;">write_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_unique_genes</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/volcano/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">".tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

      <span style="color: #05c6e3; font-style: italic;"># Apply FDR threshold</span>
      <span style="color: #ebedf0; font-style: italic;">all_unique_genes</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">all_unique_genes</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_unique_genes</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">2</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><</span> <span style="color: #ebedf0; font-style: italic;">FDR</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>
      <span style="color: #05c6e3; font-style: italic;"># Write the filtered result to a file</span>
      <span style="color: #ebedf0; font-style: italic;">write_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_unique_genes</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/filtered/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">".tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #68affc; font-style: italic;">}</span>
	
    <span style="color: #05c6e3; font-style: italic;"># Count genes with "///"</span>
    <span style="color: #ebedf0; font-style: italic;">eslash_genes</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">grep</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"///"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">all_unique_genes</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Display summary message for the current project</span>
    <span style="color: #ebedf0; font-style: italic;">message</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"###################### Summary for: "</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">" ############################"</span><span style="color: #68affc; font-style: italic;">)</span>

    <span style="color: #05c6e3; font-style: italic;"># Display summary information about the genes analysis</span>
    <span style="color: #ebedf0; font-style: italic;">message</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">cat</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"Number of missing gene symbols:"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">genemissing</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
                <span style="color: #2ad43b; font-style: italic;">"\nNumber of duplicated genes:"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">only_dupgene</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
                <span style="color: #2ad43b; font-style: italic;">"\nTotal number of genes after averaging duplicated genes and FDR filter:"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">NROW</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_unique_genes</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
                <span style="color: #2ad43b; font-style: italic;">"\nNumber of genes having ///:"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">eslash_genes</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
	
    <span style="color: #ebedf0; font-style: italic;">message</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"##########################################################################"</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #68affc; font-style: italic;">}</span>

    <span style="color: #05c6e3; font-style: italic;"># Display completion message for the analysis</span>
    <span style="color: #ebedf0; font-style: italic;">message</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"+++++++++++++++++++++++ Analysis has completed. +++++++++++++++++++++++"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #68affc; font-style: italic;">}</span>


<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">###################################################### 14- Makevolcano Function#######################################################</span> 
<span style="color: #05c6e3; font-style: italic;"># Function to generate a volcano plot</span>

<span style="color: #05c6e3; font-style: italic;"># Input:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - projname: Name of the project (default: "GSE11121")</span> 
<span style="color: #05c6e3; font-style: italic;">#   - padjlevel: Adjusted p-value threshold (default: 0.05)</span> 
<span style="color: #05c6e3; font-style: italic;">#   - pSE_thresh: Positive effect size threshold (default: 1)</span> 
<span style="color: #05c6e3; font-style: italic;">#   - nSE_thresh: Negative effect size threshold (default: -1)</span> 
<span style="color: #05c6e3; font-style: italic;">#   - ntop: Number of top genes to label (default: 10)</span> 
<span style="color: #05c6e3; font-style: italic;">#   - voltype: Type of volcano plot ("ggplot" or "plotly") (default: "ggplot")</span> 

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - A volcano plot visualization</span> 
<span style="color: #05c6e3; font-style: italic;">#   - DEG files (upregulated, downregulated, and top genes)</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function generates a volcano plot for differential gene expression analysis.</span>  
<span style="color: #05c6e3; font-style: italic;"># It takes several arguments to customize the plot, including the project name,</span> 
<span style="color: #05c6e3; font-style: italic;"># adjusted p-value threshold, effect size thresholds, number of top genes to label,</span>  
<span style="color: #05c6e3; font-style: italic;"># and the type of volcano plot (ggplot or plotly).</span> 

<span style="color: #05c6e3; font-style: italic;"># The function reads the volcano plot data, calculates adjusted p-values and assigns DEG labels based on the thresholds. </span> 
<span style="color: #05c6e3; font-style: italic;"># It then generates the volcano plot using either ggplot or plotly, visualizing the relationship between effect size and statistical significance.</span>  
<span style="color: #05c6e3; font-style: italic;"># The plot includes color-coded points representing upregulated, downregulated, and non-significant genes.</span> 
<span style="color: #05c6e3; font-style: italic;"># Additionally, the function saves DEG files containing upregulated, downregulated, and top genes,</span>  
<span style="color: #05c6e3; font-style: italic;"># and displays the number of upregulated and downregulated genes.</span> 
 	
<span style="color: #ebedf0; font-style: italic;">Makevolcano</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #ebedf0; font-style: italic;">,</span>
                        <span style="color: #ebedf0; font-style: italic;">padjlevel</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.05</span><span style="color: #ebedf0; font-style: italic;">,</span>
                        <span style="color: #ebedf0; font-style: italic;">pSE_thresh</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span>
                        <span style="color: #ebedf0; font-style: italic;">nSE_thresh</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span>
                        <span style="color: #ebedf0; font-style: italic;">ntop </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">10</span><span style="color: #ebedf0; font-style: italic;">,</span>
                        <span style="color: #ebedf0; font-style: italic;">voltype</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"ggplot"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  <span style="color: #ebedf0; font-style: italic;">dir.create</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/DEG"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">showWarnings</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>
  # Reading the DEGs table
  <span style="color: #ebedf0; font-style: italic;">volcano </span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">read_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/volcano/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">".tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">volcano </span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">volcano</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">volcano</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">:</span><span style="color: #cf4275; font-style: italic;">2</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">gsub</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"_"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">""</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">volcano</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">:</span><span style="color: #cf4275; font-style: italic;">2</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
  
  <span style="color: #ebedf0; font-style: italic;">volcano </span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">volcano </span><span style="color: #68affc; font-style: italic;">%>%</span>
    <span style="color: #ebedf0; font-style: italic;">mutate</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">AdjustedPvalue</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">log10</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">FDR</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%>%</span>
    <span style="color: #ebedf0; font-style: italic;">mutate</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">DEG</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"NotSignificant"</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%>%</span>
    <span style="color: #ebedf0; font-style: italic;">mutate</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">DEG</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #f79502; font-style: italic;">ifelse</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">AdjustedPvalue</span><span style="color: #68affc; font-style: italic;">></span> <span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">log10</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">padjlevel</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">&</span> <span style="color: #ebedf0; font-style: italic;">zSco</span><span style="color: #68affc; font-style: italic;">></span> <span style="color: #ebedf0; font-style: italic;">pSE_thresh</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"Upregulated"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">DEG</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%>%</span>
    <span style="color: #ebedf0; font-style: italic;">mutate</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">DEG</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #f79502; font-style: italic;">ifelse</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">AdjustedPvalue</span><span style="color: #68affc; font-style: italic;">></span> <span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">log10</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">padjlevel</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">&</span> <span style="color: #ebedf0; font-style: italic;">zSco</span> <span style="color: #68affc; font-style: italic;"><</span> <span style="color: #ebedf0; font-style: italic;">nSE_thresh</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"Downregulated"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">DEG</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  
  
  <span style="color: #ebedf0; font-style: italic;">zero_fdr</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">volcano</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">FDR</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0</span><span style="color: #68affc; font-style: italic;">)</span>
 <span style="color: #ebedf0; font-style: italic;">m</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">log10</span><span style="color: #68affc; font-style: italic;">(</span>min<span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">volcano</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">zero_fdr</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"FDR"</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span> <span style="color: #cf4275; font-style: italic;">0.5</span>
  <span style="color: #ebedf0; font-style: italic;">volcano</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">zero_fdr</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"AdjustedPvalue"</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">m</span>
  # Colors
  <span style="color: #ebedf0; font-style: italic;">my_pal</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #1B9E77; font-style: italic; padding: 2px;">#1B9E77</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #7570B3; font-style: italic; padding: 2px;">#7570B3</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #E7298A; font-style: italic; padding: 2px;">#E7298A</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #66A61E; font-style: italic; padding: 2px;">#66A61E</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #E6AB02; font-style: italic; padding: 2px;">#E6AB02</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #A6761D; font-style: italic; padding: 2px;">#A6761D</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #666666; font-style: italic; padding: 2px;">#666666</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #9A7D0A; font-style: italic; padding: 2px;">#9A7D0A</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #68affc; font-style: italic;">)</span>
  # Calculating the number of each Upregulated, Downregulated, and NotSignificant probes
  <span style="color: #ebedf0; font-style: italic;">volcano_up</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">volcano</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">volcano</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">DEG</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Upregulated"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">volcano_down</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">volcano</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">volcano</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">DEG</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Downregulated"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">volcano_down</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">volcano_down</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">order</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">volcano_down</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">zSco</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">decreasing</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">volcano_NA</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">volcano</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">volcano</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">DEG</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"NotSignificant"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>
  # Combining all with together 
  <span style="color: #ebedf0; font-style: italic;">volcano_all</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">volcano_up</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">volcano_down</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">volcano_NA</span><span style="color: #68affc; font-style: italic;">)</span>
  # Replacing the top probes with word Top
  <span style="color: #ebedf0; font-style: italic;">ntop_rep</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;"> rep</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"Top"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">ntop</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">volcano_all</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">DEG</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">ntop_rep</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">volcano_up</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">DEG</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">:ntop</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">ntop_rep</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">volcano_down</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">DEG</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">:ntop</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">volcano_NA</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">DEG</span><span style="color: #68affc; font-style: italic;">)</span>
  # Label only top genes
  <span style="color: #ebedf0; font-style: italic;">volcano_all</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Top</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">ifelse</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">volcano_all</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">DEG</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Top"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">volcano_all</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">""</span><span style="color: #68affc; font-style: italic;">)</span>
  # Plotting either with plotly or ggplot
  <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">voltype</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"ggplot"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">p</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">ggplot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">data</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">volcano_all</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">aes</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">zSco</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">AdjustedPvalue</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">color</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">DEG</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">fill</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">DEG</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">label</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">Top</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span> 
      <span style="color: #ebedf0; font-style: italic;">labs</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">'Effect size'</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"-log10(FDR)"</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #ebedf0; font-style: italic;">geom_point</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">shape</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">21</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #ebedf0; font-style: italic;">geom_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">check_overlap</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">TRUE</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">vjust</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.1</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">nudge_y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.1</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #ebedf0; font-style: italic;">scale_color_manual</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">values</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">my_pal</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #ebedf0; font-style: italic;">scale_fill_manual</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">values</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">my_pal</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"66"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">sep</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">""</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #ebedf0; font-style: italic;">theme_classic</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #ebedf0; font-style: italic;">theme</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">axis.text</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">axis.text.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">axis.text.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">plot.subtitle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">hjust</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.5</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">axis.title.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">90</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">axis.title.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">00</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">legend.text</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">10</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> 
            <span style="color: #ebedf0; font-style: italic;">legend.title</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">20</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #ebedf0; font-style: italic;">labs</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">subtitle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"Volcano plot-"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">p</span>
  <span style="color: #68affc; font-style: italic;">}</span><span style="color: #f79502; font-style: italic;"> else</span> <span style="color: #68affc; font-style: italic;">{</span>
    # Creating ggplot object, adding layers and annotation to the plot
    <span style="color: #ebedf0; font-style: italic;">p</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">ggplot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">data</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">volcano_all</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">aes</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">zSco</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">AdjustedPvalue</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">color</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">DEG</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">fill</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">DEG</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">text</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">paste</span><span style="color: #68affc; font-style: italic;">(</span>
      <span style="color: #2ad43b; font-style: italic;">"&lt;br&gt;Gene: "</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">Gene.symbol</span><span style="color: #ebedf0; font-style: italic;">,</span>
      <span style="color: #2ad43b; font-style: italic;">"&lt;br&gt;Chromosome: "</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">Chromosome.location</span><span style="color: #ebedf0; font-style: italic;">,</span>
      <span style="color: #2ad43b; font-style: italic;">"&lt;br&gt;GO function: "</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">GO.function</span> <span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #ebedf0; font-style: italic;">labs</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">'Effect size'</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;"></span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">title</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"Volcano plot-"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #ebedf0; font-style: italic;">geom_point</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">shape</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">21</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #ebedf0; font-style: italic;">scale_color_manual</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">values</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">my_pal</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #ebedf0; font-style: italic;">scale_fill_manual</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">values</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">my_pal</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"66"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">sep</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">""</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #ebedf0; font-style: italic;">theme_classic</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
      <span style="color: #ebedf0; font-style: italic;">theme</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">axis.text</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">axis.text.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">axis.text.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">plot.subtitle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">hjust</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.5</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">axis.title.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">90</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">axis.title.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">00</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">p</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">ggplotly</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">p</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">tooltip</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"text"</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%>%</span>
      <span style="color: #ebedf0; font-style: italic;">layout</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">title</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"Volcano plot-"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
             <span style="color: #ebedf0; font-style: italic;">font</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">color</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
             <span style="color: #ebedf0; font-style: italic;">legend</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">color</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">20</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">itemclick</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"toggle"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  # Calculation the up and down regulated genes number
  <span style="color: #ebedf0; font-style: italic;">write_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">volcano_up</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">volcano_down</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/DEG/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"_up_down.tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  # Creating the top table (up and down) based on the number specified (ntop)
  <span style="color: #ebedf0; font-style: italic;">Top</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">volcano_up</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">:ntop</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">volcano_down</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">:ntop</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">Top</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">Top</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">6</span><span style="color: #68affc; font-style: italic;">]</span>
  # Save top table into project folder
  <span style="color: #ebedf0; font-style: italic;">write_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">Top</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/DEG/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"_top.tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  
  <span style="color: #ebedf0; font-style: italic;">message</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"################# Significance #################"</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">message</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">cat</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"Up-regulated genes:"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">nrow</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">volcano_up</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
              <span style="color: #2ad43b; font-style: italic;">"\nDown-regulated genes:"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">nrow</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">volcano_down</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">message</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"################################################"</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">return</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">p</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #68affc; font-style: italic;">}</span>


	
<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">####################################################### 15- MakeVenna Function########################################################</span> 
<span style="color: #05c6e3; font-style: italic;"># Function to generate a volcano plot</span> 

<span style="color: #05c6e3; font-style: italic;"># Arguments:</span> 
<span style="color: #05c6e3; font-style: italic;">#    - projname: Name of the project (default: "GSE11121")</span> 
<span style="color: #05c6e3; font-style: italic;">#    - padjlevel: Adjusted p-value threshold (default: 0.05)</span> 
<span style="color: #05c6e3; font-style: italic;">#    - pSE_thresh: Positive effect size threshold (default: 1)</span> 
<span style="color: #05c6e3; font-style: italic;">#    - nSE_thresh: Negative effect size threshold (default: -1)</span> 
<span style="color: #05c6e3; font-style: italic;">#    - ntop: Number of top genes to label (default: 10)</span> 
<span style="color: #05c6e3; font-style: italic;">#    - voltype: Type of volcano plot ("ggplot" or "plotly") (default: "ggplot")</span> 
 
<span style="color: #05c6e3; font-style: italic;"># Input: Dataframe containing the differential expression analysis results</span> 

<span style="color: #05c6e3; font-style: italic;"># Output: Volcano plot object (ggplot or plotly)</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function generates a volcano plot based on differential expression analysis results.</span>  
<span style="color: #05c6e3; font-style: italic;"># It takes several arguments to customize the plot, including the project name, adjusted p-value threshold,</span>  
<span style="color: #05c6e3; font-style: italic;"># effect size thresholds, number of top genes to label, and the type of volcano plot (ggplot or plotly).</span> 

<span style="color: #05c6e3; font-style: italic;"># The function reads the differential expression analysis results from a dataframe.</span>  
<span style="color: #05c6e3; font-style: italic;"># It then identifies the common genes across all projects and creates separate files for common genes and top common genes.</span>  
<span style="color: #05c6e3; font-style: italic;"># The function calculates the mean values of z-score and FDR for the common genes and creates a new dataframe.</span>  
<span style="color: #05c6e3; font-style: italic;"># The common genes, as well as the Venn diagram showing the overlapping genes between projects, are saved in the "common" folder.</span> 

<span style="color: #05c6e3; font-style: italic;"># Finally, the function generates a volcano plot using either ggplot or plotly, visualizing the relationship between effect size and statistical significance of genes. </span> 
<span style="color: #05c6e3; font-style: italic;"># The plot includes color-coded points representing upregulated, downregulated, and non-significant genes. The function returns the volcano plot object.</span> 
	
<span style="color: #ebedf0; font-style: italic;">MakeVenna</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">common</span><span style="color: #ebedf0; font-style: italic;">,</span>
                      <span style="color: #ebedf0; font-style: italic;">ntop </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">10</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  
  <span style="color: #ebedf0; font-style: italic;">dir.create</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/common"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">showWarnings</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>
  # Reading all all_top_down files
  <span style="color: #ebedf0; font-style: italic;">com_table</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">common</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">DEG_table</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">read_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/DEG/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">common</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"_up_down.tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">com_table</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">common</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">DEG_table</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">6</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  # Calculating up and down regulated gens
  <span style="color: #ebedf0; font-style: italic;">DEGslist</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">com_table</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">DEGslist</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">common</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">com_table</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">3</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  # Common genes
  <span style="color: #ebedf0; font-style: italic;">com_prob</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">Reduce</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">intersect</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">DEGslist</span><span style="color: #68affc; font-style: italic;">)</span>
  # Writing all common genes into separated files as well as the top files
  <span style="color: #ebedf0; font-style: italic;">all_com</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">com_table</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">comn</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">com_table</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">names</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">com_table</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #2ad43b; font-style: italic;">"Gene.symbol"</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">com_prob</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">com_final_DEG</span>  <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">com_table</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">names</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">com_table</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">comn</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #ebedf0; font-style: italic;">write_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">com_final_DEG</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/common/"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">names</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">com_table</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #2ad43b; font-style: italic;">"_common_DEGs.tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">sorted_com_final_DEG</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">com_final_DEG</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">order</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">com_final_DEG</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #ebedf0; font-style: italic;">all_com</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">names</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">com_table</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">sorted_com_final_DEG</span>
    <span style="color: #ebedf0; font-style: italic;">com_final_up</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">com_final_DEG</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">com_final_DEG</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">DEG</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Upregulated"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #ebedf0; font-style: italic;">com_final_up</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">com_final_up</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">:ntop</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #ebedf0; font-style: italic;">com_final_down</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">com_final_DEG</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">com_final_DEG</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">DEG</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Downregulated"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #ebedf0; font-style: italic;">com_final_down</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">com_final_down</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">:ntop</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #ebedf0; font-style: italic;">write_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">com_final_up</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">com_final_down</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/common/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">names</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">com_table</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #2ad43b; font-style: italic;">"_top_common_DEGs.tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  
  <span style="color: #ebedf0; font-style: italic;">firstsecond_col</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">remaining</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_com</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">firstsecond_col</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_com</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">:</span><span style="color: #cf4275; font-style: italic;">2</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">remaining</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_com</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">3</span><span style="color: #68affc; font-style: italic;">:</span><span style="color: #cf4275; font-style: italic;">6</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  
  <span style="color: #ebedf0; font-style: italic;">firstsecond_col_df</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">do.call</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">firstsecond_col</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">sz</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">grep</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"zSco"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">firstsecond_col_df</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">fdr</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">grep</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"FDR"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">firstsecond_col_df</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">sz_mean</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">rowMeans</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">firstsecond_col_df</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">sz</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">fdr_mean</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">rowMeans</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">firstsecond_col_df</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">fdr</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">sz_fdr_df</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">zSco</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">sz_mean</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">FDR</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">fdr_mean</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">sz_fdr_df</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">sz_fdr_df</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">remaining</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">write_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">sz_fdr_df</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/common/all_mean_common_DEGs.tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  
  
  <span style="color: #ebedf0; font-style: italic;">message</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"+++++ Common genes between all datasets have saved into common folder. +++++"</span><span style="color: #68affc; font-style: italic;">)</span>
  # Creating venn diagram
  <span style="color: #ebedf0; font-style: italic;">DEGslist</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">com_table</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">DEGslist</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">common</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">com_table</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">3</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  <span style="color: #ebedf0; font-style: italic;">venlist</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">DEGslist</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">venlist</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">common</span> <span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">DEGslist</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  <span style="color: #ebedf0; font-style: italic;">set.seed</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">1234</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">my_pal</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #1B9E77; font-style: italic; padding: 2px;">#1B9E77</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #7570B3; font-style: italic; padding: 2px;">#7570B3</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #E7298A; font-style: italic; padding: 2px;">#E7298A</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #66A61E; font-style: italic; padding: 2px;">#66A61E</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #E6AB02; font-style: italic; padding: 2px;">#E6AB02</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #A6761D; font-style: italic; padding: 2px;">#A6761D</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #666666; font-style: italic; padding: 2px;">#666666</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #9A7D0A; font-style: italic; padding: 2px;">#9A7D0A</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">venaa</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">ggvenn</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">venlist</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                  <span style="color: #ebedf0; font-style: italic;">fill_color</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">my_pal</span><span style="color: #ebedf0; font-style: italic;">,</span>
                  <span style="color: #ebedf0; font-style: italic;">stroke_size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.5</span><span style="color: #ebedf0; font-style: italic;">,</span>
                  <span style="color: #ebedf0; font-style: italic;">set_name_size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">4</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">return</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">venaa</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #68affc; font-style: italic;">}</span>



<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">################################################### 16- Makenetworkanalyst Function###################################################</span>  
<span style="color: #05c6e3; font-style: italic;"># Function to prepare data for NetworkAnalyst platform</span> 

<span style="color: #05c6e3; font-style: italic;"># Arguments:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - matrix: Input matrix containing gene expression data</span> 
<span style="color: #05c6e3; font-style: italic;">#   - projname: Name of the project</span> 
<span style="color: #05c6e3; font-style: italic;">#   - compare: Comparison type (default: "grade")</span> 
<span style="color: #05c6e3; font-style: italic;">#   - groups: List of groups for comparison</span> 

<span style="color: #05c6e3; font-style: italic;"># Input: Gene expression matrix, phenotype data, annotation data</span> 

<span style="color: #05c6e3; font-style: italic;"># Output: Modified matrix file for NetworkAnalyst</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function prepares the gene expression data for the NetworkAnalyst platform.</span>  
<span style="color: #05c6e3; font-style: italic;"># It takes a gene expression matrix, project name, comparison type, and groups for comparison as input. </span> 
<span style="color: #05c6e3; font-style: italic;"># The function performs several steps to process the data and generate a modified matrix file compatible with NetworkAnalyst.</span> 

<span style="color: #05c6e3; font-style: italic;"># The function first creates a directory to store the network analysis files for NetworkAnalyst. </span> 
<span style="color: #05c6e3; font-style: italic;"># It then checks if the first column of the matrix is labeled as "ID" and adjusts the matrix accordingly.</span>  
<span style="color: #05c6e3; font-style: italic;"># The phenotype file is read and processed based on the specified comparison type. </span> 
<span style="color: #05c6e3; font-style: italic;"># The annotation file is also read and processed to ensure compatibility.</span> 

<span style="color: #05c6e3; font-style: italic;"># Next, the function finds matching samples based on the provided groups and subsets the matrix accordingly.</span>  
<span style="color: #05c6e3; font-style: italic;"># The values in the matrix are rounded to two decimal places. Rows with missing gene symbols are removed from the matrix.</span>  
<span style="color: #05c6e3; font-style: italic;"># Group information is extracted from the phenotype data and stored in the grouplis list.</span> 

<span style="color: #05c6e3; font-style: italic;"># The function renames the matrix file according to the group names specified by the user.</span>  
<span style="color: #05c6e3; font-style: italic;"># It modifies the column names and the second row to adhere to the file format required by NetworkAnalyst.</span>  
<span style="color: #05c6e3; font-style: italic;"># Finally, the modified matrix file is saved in the "MetaAnalysis/networkanalyst" directory with the name "projname_network_full.txt".</span> 

<span style="color: #05c6e3; font-style: italic;"># The completion message is displayed when the file has been successfully saved.</span> 
	
<span style="color: #ebedf0; font-style: italic;">Makenetworkanalyst</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #ebedf0; font-style: italic;">,</span>
                               <span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span>
                               <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #ebedf0; font-style: italic;">,</span>
                               <span style="color: #ebedf0; font-style: italic;">groups</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  # Reading files
  <span style="color: #ebedf0; font-style: italic;">dir.create</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/networkanalyst"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">showWarnings</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>
 <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"ID"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  
  <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">read_csv</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"phenotype/phenotype_"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">".csv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">paired_pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Sample</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">paired_pheno</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
  
  <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">read_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"annot.tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
  # Finding matching grades or subtypes
  <span style="color: #ebedf0; font-style: italic;">sampleid</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">groups</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">g_row</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">groups</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">g_row</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  <span style="color: #ebedf0; font-style: italic;">sampleid</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">do.call</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">sampleid</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">order</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Sample</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Sample</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">round</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">2</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">identical</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"Gene.symbol"</span>
  <span style="color: #ebedf0; font-style: italic;">genemissing</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">is.na</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">TRUE</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">genemissing</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>

  <span style="color: #ebedf0; font-style: italic;">grouplis</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">groups</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">name</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">groups</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">collapse</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"|"</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">rownum</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">grep</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">name</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">grouplis</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">names</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">groups</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Sample</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">rownum</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  # Renaming the matrix file according to the groups name specified by user 
  <span style="color: #ebedf0; font-style: italic;">updown_matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">grouplis</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">matname</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">grouplis</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">collapse</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"|"</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">matcoln</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">grep</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matname</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">updown_matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">updown_matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">matcoln</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">names</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">grouplis</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  # Adding col names and second row according to the file for networkanalyst
  <span style="color: #ebedf0; font-style: italic;">changedcol</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">grep</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">names</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">grouplis</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">collapse</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"|"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">updown_matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">updown_matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">updown_matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">changedcol</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">updown_matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"#CLASS"</span>
  <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">updown_matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"#NAME"</span>
  <span style="color: #ebedf0; font-style: italic;">write.table</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">updown_matrix</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/networkanalyst/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #2ad43b; font-style: italic;">"_network_full.txt"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">quote</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">row.names</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">sep</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"\t"</span> <span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">message</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"+++++ Your file has saved into networkanalyst folder. +++++"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #68affc; font-style: italic;">}</span> 



<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">###################################################### 17- MakeHeatmap Function ######################################################</span> 
<span style="color: #05c6e3; font-style: italic;"># Function to create a heatmap based on gene expression data</span> 

<span style="color: #05c6e3; font-style: italic;"># Arguments:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - matrix: The gene expression data matrix</span> 
<span style="color: #05c6e3; font-style: italic;">#   - projname: The project name or identifier</span> 
<span style="color: #05c6e3; font-style: italic;">#   - compare: The comparison for phenotype</span> 
<span style="color: #05c6e3; font-style: italic;">#   - groups: A list of groups for sample selection</span> 
<span style="color: #05c6e3; font-style: italic;">#   - ntop: The number of top genes to consider</span> 
<span style="color: #05c6e3; font-style: italic;">#   - sorted: A logical value indicating whether the heatmap should be sorted</span> 

<span style="color: #05c6e3; font-style: italic;"># Input:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - Gene expression data matrix</span> 
<span style="color: #05c6e3; font-style: italic;">#   - Phenotype data</span> 
<span style="color: #05c6e3; font-style: italic;">#   - Annotation data</span> 
<span style="color: #05c6e3; font-style: italic;">#   - Differential expression gene (DEG) file</span> 

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - Heatmap plot visualizing the gene expression data</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function generates a heatmap based on gene expression data. </span> 
<span style="color: #05c6e3; font-style: italic;"># It takes a gene expression data matrix, project name, comparison for phenotype, groups for sample selection,</span>  
<span style="color: #05c6e3; font-style: italic;"># number of top genes to consider, and a logical value indicating whether the heatmap should be sorted as input.</span> 

<span style="color: #05c6e3; font-style: italic;"># The function starts by checking if the matrix's first column is named "ID" and adjusts the matrix if necessary.</span>  
<span style="color: #05c6e3; font-style: italic;"># It reads the phenotype CSV file and converts it to a data frame. </span> 
<span style="color: #05c6e3; font-style: italic;"># The annotation file is also read and processed based on the project name.</span> 
<span style="color: #05c6e3; font-style: italic;"># The matrix is adjusted to match the IDs in the annotation data frame.</span> 

<span style="color: #05c6e3; font-style: italic;"># Next, the function performs averaging for duplicated genes by calculating the column-wise mean for rows with the same gene symbol.</span>  
<span style="color: #05c6e3; font-style: italic;"># The averaged genes are combined with unique non-duplicated genes into a single data frame.</span> 
<span style="color: #05c6e3; font-style: italic;"># The DEG file is read, and the top upregulated and downregulated genes are extracted.</span> 

<span style="color: #05c6e3; font-style: italic;"># The function selects the genes from the combined data frame that match the selected DEGs. </span> 
<span style="color: #05c6e3; font-style: italic;"># The network data frame is created, and the sample IDs are matched with the network data frame columns based on the groups provided.</span>  
<span style="color: #05c6e3; font-style: italic;"># The grades are extracted from the network data frame columns.</span> 

<span style="color: #05c6e3; font-style: italic;"># The function generates the heatmap plot using the network data frame.</span>  
<span style="color: #05c6e3; font-style: italic;"># If the heatmap should be sorted, the columns are ordered based on column names. </span> 
<span style="color: #05c6e3; font-style: italic;"># The plot includes row (gene) annotations, a bottom annotation indicating the grades, and a legend for expression levels.</span>  
<span style="color: #05c6e3; font-style: italic;"># The row title is positioned on the left side, and the column names are hidden.</span> 

<span style="color: #05c6e3; font-style: italic;"># The completion message is displayed when the heatmap plot is generated.</span> 
	
<span style="color: #ebedf0; font-style: italic;">MakeHeatmap</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #ebedf0; font-style: italic;">,</span>
                        <span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span>
                        <span style="color: #ebedf0; font-style: italic;">compare</span> <span style="color: #ebedf0; font-style: italic;">,</span>
                        <span style="color: #ebedf0; font-style: italic;">groups</span><span style="color: #ebedf0; font-style: italic;">,</span>
                        <span style="color: #ebedf0; font-style: italic;">ntop</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                        <span style="color: #ebedf0; font-style: italic;">sorted</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  <span style="color: #ebedf0; font-style: italic;">set.seed</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">1234</span><span style="color: #68affc; font-style: italic;">)</span>
 <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"ID"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
    <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">order</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  # Reading phenotype
  <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">read_csv</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"phenotype/phenotype_"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">".csv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">)</span>
  # Reading annotation  
 <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"combination"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">read_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"annot.tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #68affc; font-style: italic;">}</span><span style="color: #f79502; font-style: italic;"> else</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">read_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"annot.tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">[</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"ID"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #2ad43b; font-style: italic;">"Gene.symbol"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">order</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">ID</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
 <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">identical</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">ID</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">annot</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"Gene.symbol"</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  # Averaging duplicated genes
  <span style="color: #ebedf0; font-style: italic;">dupgene_freq</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">table</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">only_dupgene</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">dupgene_freq</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">dupgene_freq</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Freq</span><span style="color: #68affc; font-style: italic;"> ></span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">only_dupgene_row</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">only_dupgene</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">duplicat_deg</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">only_dupgene_row</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>
  
  <span style="color: #ebedf0; font-style: italic;">averaged_genes</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span>i <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">:</span><span style="color: #ebedf0; font-style: italic;">length</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">only_dupgene</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">d_row</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">duplicat_deg</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">only_dupgene</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">col_mean</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">colMeans</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">duplicat_deg</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">d_row</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">col_all</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">cbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">duplicat_deg</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">d_row</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">col_mean</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">averaged_genes</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">col_all</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  <span style="color: #ebedf0; font-style: italic;">averaged_genes</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">do.call</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">averaged_genes</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">averaged_genes</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #2ad43b; font-style: italic;">"Gene.symbol"</span>
  <span style="color: #ebedf0; font-style: italic;">unique_deg</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">matrix</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #ebedf0; font-style: italic;">only_dupgene_row</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">all_unique_genes</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">unique_deg</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">averaged_genes</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_unique_genes</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #cf4275; font-style: italic;">NULL</span> 
  # Reading DEG file
  <span style="color: #ebedf0; font-style: italic;">DEG_table</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">read_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/DEG/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"_up_down.tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  # Finding up and down regulated gene and make original matrix of them
  <span style="color: #ebedf0; font-style: italic;">up</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">DEG_table</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">DEG_table</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">DEG</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Upregulated"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">up</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">up</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">:ntop</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">2</span><span style="color: #68affc; font-style: italic;">:</span><span style="color: #cf4275; font-style: italic;">3</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">down</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">DEG_table</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">DEG_table</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">DEG</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Downregulated"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">down</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">down</span><span style="color: #68affc; font-style: italic;">[</span>1<span style="color: #ebedf0; font-style: italic;">:ntop</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #cf4275; font-style: italic;">2</span><span style="color: #68affc; font-style: italic;">:</span><span style="color: #cf4275; font-style: italic;">3</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">genelist</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">up</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">down</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">2</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">num</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_unique_genes</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">genelist</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">network_df</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all_unique_genes</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">num</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">Gene.symbol</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">network_df</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span>
  <span style="color: #ebedf0; font-style: italic;">network_df</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">network_df</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">network_df</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">as.matrix</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">sapply</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">network_df</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">as.numeric</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">rownames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">network_df</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">Gene.symbol</span>
  
  # Finding grades and matching with colnames
  <span style="color: #ebedf0; font-style: italic;">sampleid</span> <span style="color: #68affc; font-style: italic;"><-</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #f79502; font-style: italic;">for</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">i</span> <span style="color: #f79502; font-style: italic;">in</span> <span style="color: #ebedf0; font-style: italic;">seq_along</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">groups</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">g_row</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pheno</span> <span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">groups</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">)</span>
    <span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">i</span><span style="color: #68affc; font-style: italic;">]</span><span style="color: #68affc; font-style: italic;">]</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">pheno</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">g_row</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #68affc; font-style: italic;">}</span>
  <span style="color: #ebedf0; font-style: italic;">sampleid</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">do.call</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">rbind</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">sampleid_n</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Sample</span> <span style="color: #68affc; font-style: italic;">%in%</span> <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">network_df</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">sampleid</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">sampleid_n</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">sampleid</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">order</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">sampleid</span> <span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"Grade_"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span><span style="color: #68affc; font-style: italic;">)</span> 
  <span style="color: #ebedf0; font-style: italic;">network_df</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">network_df</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">sampleid</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Sample</span><span style="color: #68affc; font-style: italic;">]</span>
  <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">network_df</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">sampleid</span> <span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">grade</span> 
  # Grade info
  <span style="color: #ebedf0; font-style: italic;">type</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">network_df</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">ha</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">HeatmapAnnotation</span><span style="color: #68affc; font-style: italic;">(</span>
    <span style="color: #ebedf0; font-style: italic;">df</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">Grade</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> type</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
    <span style="color: #ebedf0; font-style: italic;">annotation_height</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">unit</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">4</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"mm"</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #68affc; font-style: italic;">)</span>
  # Heatmap plot
 <span style="color: #f79502; font-style: italic;">if</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">sorted </span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">TRUE</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  <span style="color: #ebedf0; font-style: italic;">Heatmap</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">network_df</span><span style="color: #ebedf0; font-style: italic;">,</span>
          <span style="color: #ebedf0; font-style: italic;">row_names_gp</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">gpar</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">fontsize </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">7</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
          <span style="color: #ebedf0; font-style: italic;">bottom_annotation</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">ha</span><span style="color: #ebedf0; font-style: italic;">,</span>
          <span style="color: #ebedf0; font-style: italic;">column_order</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">colnames</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">network_df</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
          <span style="color: #ebedf0; font-style: italic;">border_gp</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">gpar</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">col</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
          <span style="color: #ebedf0; font-style: italic;">row_title</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"DEGs"</span><span style="color: #ebedf0; font-style: italic;">,</span>
          <span style="color: #ebedf0; font-style: italic;">row_title_side</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"left"</span><span style="color: #ebedf0; font-style: italic;">,</span>
          <span style="color: #ebedf0; font-style: italic;">show_column_names</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #ebedf0; font-style: italic;">,</span>
          <span style="color: #ebedf0; font-style: italic;">heatmap_legend_param</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">legend_direction</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"vertical"</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                      <span style="color: #ebedf0; font-style: italic;">legend_height</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">unit</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">50</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"mm"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                      <span style="color: #ebedf0; font-style: italic;">grid_width</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">unit</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">6</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"mm"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                      <span style="color: #ebedf0; font-style: italic;">grid_height</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">unit</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">50</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"cm"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                      <span style="color: #ebedf0; font-style: italic;">title</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Expression"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #68affc; font-style: italic;">}</span><span style="color: #f79502; font-style: italic;"> else</span> <span style="color: #68affc; font-style: italic;">{</span>
    <span style="color: #ebedf0; font-style: italic;">Heatmap</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">network_df</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">row_names_gp</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">gpar</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">fontsize </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">7</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">bottom_annotation</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">ha</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">border_gp</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">gpar</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">col</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">row_title</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"DEGs"</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">row_title_side</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"left"</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">show_column_names</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">heatmap_legend_param</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">legend_direction</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"vertical"</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                        <span style="color: #ebedf0; font-style: italic;">legend_height</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">unit</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">50</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"mm"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                        <span style="color: #ebedf0; font-style: italic;">grid_width</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">unit</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">6</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"mm"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                        <span style="color: #ebedf0; font-style: italic;">grid_height</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">unit</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">50</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"cm"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                        <span style="color: #ebedf0; font-style: italic;">title</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Expression"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #68affc; font-style: italic;">}</span>
<span style="color: #68affc; font-style: italic;">}</span>



<span style="color: #05c6e3; font-style: italic;">######################################################################################################################################</span> 
<span style="color: #05c6e3; font-style: italic;">########################################################## 18- GSEAAnalysis ##########################################################</span> 
<span style="color: #05c6e3; font-style: italic;"># Function to perform Gene Set Enrichment Analysis (GSEA)</span> 

<span style="color: #05c6e3; font-style: italic;"># Arguments:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - projname: The project name or identifier</span> 
<span style="color: #05c6e3; font-style: italic;">#   - FDR: The false discovery rate (FDR) threshold for significance</span> 

<span style="color: #05c6e3; font-style: italic;"># Input:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - DEG_table: Data frame containing differential expression gene (DEG) information</span> 
<span style="color: #05c6e3; font-style: italic;">#   - H: Data frame containing hallmark pathway gene sets</span> 
<span style="color: #05c6e3; font-style: italic;">#   - FC: Data frame containing gene names and logFC values</span> 

<span style="color: #05c6e3; font-style: italic;"># Output:</span> 
<span style="color: #05c6e3; font-style: italic;">#   - GSEA plot visualizing the enriched gene sets</span> 

<span style="color: #05c6e3; font-style: italic;"># Function Description:</span> 
<span style="color: #05c6e3; font-style: italic;"># This function performs Gene Set Enrichment Analysis (GSEA) using the fgseaSimple function.</span> 
<span style="color: #05c6e3; font-style: italic;"># It takes the project name and FDR threshold as input and generates a GSEA plot of enriched gene sets.</span> 

<span style="color: #05c6e3; font-style: italic;"># The function reads the DEG table specific to the project name and prepares gene scores and gene set lookup table.</span> 
<span style="color: #05c6e3; font-style: italic;"># GSEA is performed using fgseaSimple, and the results are visualized in a GSEA plot.</span> 
<span style="color: #05c6e3; font-style: italic;"># The significance of gene sets is determined based on FDR and NES values.</span> 
<span style="color: #05c6e3; font-style: italic;"># The plot includes pathway names, NES values, and colored bars representing significance.</span> 
	
<span style="color: #ebedf0; font-style: italic;">GSEAAnalysis</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #f79502; font-style: italic;">function</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">FDR</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">{</span>
  # Reading file 
  <span style="color: #ebedf0; font-style: italic;">DEG_table</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">data.frame</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">read_tsv</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"MetaAnalysis/DEG/"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"_up_down.tsv"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  # Removing /// from some genes
  <span style="color: #ebedf0; font-style: italic;">DEG_table</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">gsub</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"///.*"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">""</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">DEG_table</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span><span style="color: #68affc; font-style: italic;">)</span>
  # Extracting Halmark pathway with 50 gene sets 
  <span style="color: #ebedf0; font-style: italic;">H</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">msigdbr</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">species</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Homo sapiens"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">category</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"H"</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">H.symbol.ls</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">H</span> <span style="color: #68affc; font-style: italic;">%>%</span> 
    <span style="color: #ebedf0; font-style: italic;">select</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">gs_name</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">gene_symbol</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%>%</span> 
    <span style="color: #ebedf0; font-style: italic;">group_by</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">gs_name</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%>%</span> 
    <span style="color: #ebedf0; font-style: italic;">summarise</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">all.genes</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">unique</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">gene_symbol</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%>%</span> 
    <span style="color: #ebedf0; font-style: italic;">deframe</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span>
  # Just gene names and logFC
  <span style="color: #ebedf0; font-style: italic;">FC</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">DEG_table</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #cf4275; font-style: italic;">3</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">]</span>
  
  ##format for gsea 
  <span style="color: #ebedf0; font-style: italic;">FC.vec</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">FC</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">zSco</span>
  <span style="color: #ebedf0; font-style: italic;">names</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">FC.vec</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">FC</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Gene.symbol</span>
  #Run GSEA
  <span style="color: #ebedf0; font-style: italic;">gsea.H</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">fgseaSimple</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pathways</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">H.symbol.ls</span><span style="color: #ebedf0; font-style: italic;">,</span>
                        <span style="color: #ebedf0; font-style: italic;">stats</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">FC.vec</span><span style="color: #ebedf0; font-style: italic;">,</span>
                        <span style="color: #ebedf0; font-style: italic;">scoreType</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"std"</span><span style="color: #ebedf0; font-style: italic;">,</span>
                        <span style="color: #ebedf0; font-style: italic;">nperm</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #cf4275; font-style: italic;">1000</span><span style="color: #68affc; font-style: italic;">)</span>

  <span style="color: #ebedf0; font-style: italic;">my_pal</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #1B9E77; font-style: italic; padding: 2px;">#1B9E77</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #7570B3; font-style: italic; padding: 2px;">#7570B3</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #E7298A; font-style: italic; padding: 2px;">#E7298A</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #66A61E; font-style: italic; padding: 2px;">#66A61E</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #E6AB02; font-style: italic; padding: 2px;">#E6AB02</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #A6761D; font-style: italic; padding: 2px;">#A6761D</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #666666; font-style: italic; padding: 2px;">#666666</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #9A7D0A; font-style: italic; padding: 2px;">#9A7D0A</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #68affc; font-style: italic;">)</span>
  # Remove prefixes
  <span style="color: #ebedf0; font-style: italic;">gsea.H</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">pathway</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">gsub</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"HALLMARK_"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #2ad43b; font-style: italic;">""</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">gsea.H</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">pathway</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">gsea.H</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">pathway</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">gsub</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"_"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #2ad43b; font-style: italic;">" "</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">gsea.H</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">pathway</span><span style="color: #68affc; font-style: italic;">)</span>
  # Calculating the Significance based on FDR and NES
  <span style="color: #ebedf0; font-style: italic;">gsea.H</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">gsea.H</span> <span style="color: #68affc; font-style: italic;">%>%</span>
    <span style="color: #ebedf0; font-style: italic;">mutate</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">Significance</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"NotSignificance"</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%>%</span>
    <span style="color: #ebedf0; font-style: italic;">mutate</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">Significance</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #f79502; font-style: italic;">ifelse</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">padj </span><span style="color: #68affc; font-style: italic;"><=</span> <span style="color: #ebedf0; font-style: italic;">FDR</span> <span style="color: #68affc; font-style: italic;">&</span> <span style="color: #2ad43b; font-style: italic;">NES</span><span style="color: #68affc; font-style: italic;"> ></span> <span style="color: #cf4275; font-style: italic;">0</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"Upregulated"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">Significance</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">%>%</span>
    <span style="color: #ebedf0; font-style: italic;">mutate</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">Significance</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #f79502; font-style: italic;">ifelse</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">padj </span><span style="color: #68affc; font-style: italic;"><=</span> <span style="color: #ebedf0; font-style: italic;">FDR</span> <span style="color: #68affc; font-style: italic;">&</span> <span style="color: #2ad43b; font-style: italic;">NES</span> <span style="color: #68affc; font-style: italic;"><</span> <span style="color: #cf4275; font-style: italic;">0</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"Downregulated"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">Significance</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
  <span style="color: #ebedf0; font-style: italic;">gsea.H</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">gsea.H</span><span style="color: #68affc; font-style: italic;">[</span><span style="color: #ebedf0; font-style: italic;">which</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">gsea.H</span><span style="color: #68affc; font-style: italic;">$</span><span style="color: #ebedf0; font-style: italic;">Significance</span> <span style="color: #68affc; font-style: italic;">!</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"NotSignificance"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #68affc; font-style: italic;">]</span>
  # Plotting the result
  <span style="color: #ebedf0; font-style: italic;">gsea.H</span> <span style="color: #68affc; font-style: italic;">%>%</span> 
    <span style="color: #ebedf0; font-style: italic;">ggplot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">aes</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">reorder</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">pathway</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">NES</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
               <span style="color: #ebedf0; font-style: italic;">y</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #2ad43b; font-style: italic;">NES</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #ebedf0; font-style: italic;">geom_col</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">width</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.5</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">aes</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">color</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">Significance</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">fill</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">Significance</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #ebedf0; font-style: italic;">labs</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">x</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">'Gene set'</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">y</span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">'Gene set'</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #ebedf0; font-style: italic;">theme_classic</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #ebedf0; font-style: italic;">scale_color_manual</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">values</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #0000FF; font-style: italic; padding: 2px;"><span style="color: #2ad43b; font-style: italic;">blue</span></span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #FF0000; font-style: italic; padding: 2px;"><span style="color: #2ad43b; font-style: italic;">red</span></span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #ebedf0; font-style: italic;">scale_fill_manual</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">values</span><span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #0000FF; font-style: italic; padding: 2px;"><span style="color: #2ad43b; font-style: italic;">blue</span></span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"</span><span style="background-color: #FF0000; font-style: italic; padding: 2px;"><span style="color: #2ad43b; font-style: italic;">red</span></span><span style="color: #2ad43b; font-style: italic;">"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #ebedf0; font-style: italic;">coord_flip</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #ebedf0; font-style: italic;">theme</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">axis.text</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span> <span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
          <span style="color: #ebedf0; font-style: italic;">axis.text.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
          <span style="color: #ebedf0; font-style: italic;">axis.text.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">9</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
          <span style="color: #ebedf0; font-style: italic;">plot.subtitle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">colour</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"black"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">hjust</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.5</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
          <span style="color: #ebedf0; font-style: italic;">axis.title.y</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">90</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
          <span style="color: #ebedf0; font-style: italic;">axis.title.x</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">24</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">angle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">00</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
          <span style="color: #ebedf0; font-style: italic;">legend.text</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">10</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> 
          <span style="color: #ebedf0; font-style: italic;">legend.title</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">element_text</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">size </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">20</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">family</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"Arial"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span> <span style="color: #68affc; font-style: italic;">+</span>
    <span style="color: #ebedf0; font-style: italic;">labs</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">subtitle</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">paste0</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSEA - "</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #68affc; font-style: italic;">}</span>


<span style="color: #05c6e3; font-style: italic;">###################################################################################################################################### </span>
<span style="color: #05c6e3; font-style: italic;">################################################### Running all functions ############################################################ </span>

# Downloading GEO 
<span style="color: #ebedf0; font-style: italic;">DownloadGEO</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">DownloadGEO</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">DownloadGEO</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">DownloadGEO</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #68affc; font-style: italic;">)</span>
# Reading GEO matrix into R environment
<span style="color: #ebedf0; font-style: italic;">GSE11121</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">ReadGEO</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">GSE25055</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">ReadGEO</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">GSE25065</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">ReadGEO</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">GSE7390</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">ReadGEO</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #68affc; font-style: italic;">)</span>
# Preparing phenotype for all 4 GEO 
<span style="color: #ebedf0; font-style: italic;">Makephenotype</span> <span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
              <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #68affc; font-style: italic;">)</span>

# Box plot for each matrix
<span style="color: #ebedf0; font-style: italic;">MakeBoxPlot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">MakeBoxPlot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">MakeBoxPlot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">MakeBoxPlot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> GSE7390</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #68affc; font-style: italic;">)</span>

# PCA plot for each matrix
<span style="color: #ebedf0; font-style: italic;">MakePCA</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">MakePCA</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">MakePCA</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">MakePCA</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> GSE7390</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #68affc; font-style: italic;">)</span>

# Normalization for each matrix
<span style="color: #ebedf0; font-style: italic;">normalized_GSE11121</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">VSNQuantilNorm</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> GSE11121</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">normalized_GSE25055</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">VSNQuantilNorm</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> GSE25055</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">normalized_GSE25065</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">VSNQuantilNorm</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> GSE25065</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">normalized_GSE7390</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">VSNQuantilNorm</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> GSE7390</span><span style="color: #68affc; font-style: italic;">)</span>

# Box and PCA after normalization for some matrix
<span style="color: #ebedf0; font-style: italic;">MakeBoxPlot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;"> normalized_GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">MakePCA</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;"> normalized_GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">MakeBoxPlot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">MakePCA</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">MakeBoxPlot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">MakePCA</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">MakeBoxPlot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE7390</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">MakePCA</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE7390</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #68affc; font-style: italic;">)</span>

# Merging studies without batch correction (just for comparison)
<span style="color: #ebedf0; font-style: italic;">merge_studies</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">Mergestudies</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">normalized_GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;"> normalized_GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE7390</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

# PCA before batch effect 
# Important note : studies should match projname 
<span style="color: #ebedf0; font-style: italic;">MakePCA</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">merge_studies</span><span style="color: #ebedf0; font-style: italic;">,</span> 
        <span style="color: #ebedf0; font-style: italic;">studies </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">normalized_GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;"> normalized_GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE7390</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> 
        <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> 
        <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #68affc; font-style: italic;">)</span>

# Batch effect correction
<span style="color: #ebedf0; font-style: italic;">corbatch</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">StudyBatchEffect</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">studies </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">normalized_GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;"> normalized_GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE7390</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

# PCA after batch effect 
# Important note : studies should match projname 
<span style="color: #ebedf0; font-style: italic;">MakePCA</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GEOmatrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">corbatch</span><span style="color: #ebedf0; font-style: italic;">,</span> 
        <span style="color: #ebedf0; font-style: italic;">studies </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">normalized_GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;"> normalized_GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE7390</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> 
        <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #68affc; font-style: italic;">)</span>




# Density plot before batch effect correction
<span style="color: #ebedf0; font-style: italic;">MakeDensityPlot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">merge_studies</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                <span style="color: #ebedf0; font-style: italic;">studies </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GSE25055</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                              <span style="color: #ebedf0; font-style: italic;"> GSE11121</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;"> normalized_GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                              <span style="color: #ebedf0; font-style: italic;"> GSE25065</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span>
                               <span style="color: #ebedf0; font-style: italic;"> GSE7390</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE7390</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>


# Density plot after batch effect correction
<span style="color: #ebedf0; font-style: italic;">MakeDensityPlot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">corbatch</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                <span style="color: #ebedf0; font-style: italic;">studies </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GSE25055</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                              <span style="color: #ebedf0; font-style: italic;"> GSE11121</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;"> normalized_GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                              <span style="color: #ebedf0; font-style: italic;"> GSE25065</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span>
                               <span style="color: #ebedf0; font-style: italic;"> GSE7390</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE7390</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

# MDS plot before batch effect correction
# Important note : studies should match projname 
<span style="color: #ebedf0; font-style: italic;">MakeMDSPlot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">merge_studies</span><span style="color: #ebedf0; font-style: italic;">,</span> 
            <span style="color: #ebedf0; font-style: italic;">studies </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">normalized_GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;"> normalized_GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE7390</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> 
            <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> 
            <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">nstudies </span><span style="color: #68affc; font-style: italic;">=</span>  <span style="color: #cf4275; font-style: italic;">4</span><span style="color: #68affc; font-style: italic;">)</span>


# MDS plot after batch effect correction
# Important note : studies should match projname
<span style="color: #ebedf0; font-style: italic;">MakeMDSPlot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">corbatch</span><span style="color: #ebedf0; font-style: italic;">,</span> 
            <span style="color: #ebedf0; font-style: italic;">studies </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">normalized_GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;"> normalized_GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE7390</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> 
            <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> 
            <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">nstudies </span><span style="color: #68affc; font-style: italic;">=</span>  <span style="color: #cf4275; font-style: italic;">4</span><span style="color: #68affc; font-style: italic;">)</span>

# Cohran Q test 
<span style="color: #ebedf0; font-style: italic;">cohranqtest</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">CochranQTest</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">studies </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;"> GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;">GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #ebedf0; font-style: italic;"> GSE7390</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
                            <span style="color: #ebedf0; font-style: italic;">groups</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"3"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"1"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
                            <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #68affc; font-style: italic;">)</span>
# QQ plot of Cohran Q test 
<span style="color: #ebedf0; font-style: italic;">MakeQQPlot</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">cohranq</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;"><span style="color: #ebedf0; font-style: italic;">cohranq</span>test</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">nstudies </span><span style="color: #68affc; font-style: italic;">=</span>  <span style="color: #cf4275; font-style: italic;">4</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">FEMREMAnalysis</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">studies </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">normalized_GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE7390</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
               <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
               <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #ebedf0; font-style: italic;">,</span>
               <span style="color: #ebedf0; font-style: italic;">model</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"REM"</span><span style="color: #ebedf0; font-style: italic;">,</span>
               <span style="color: #ebedf0; font-style: italic;">groups</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"3"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"1"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
               <span style="color: #ebedf0; font-style: italic;">FDR</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.05</span><span style="color: #ebedf0; font-style: italic;">,</span>
               <span style="color: #ebedf0; font-style: italic;">nperm</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">50</span><span style="color: #68affc; font-style: italic;">)</span>


<span style="color: #ebedf0; font-style: italic;">volcano_GSE11121</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">Makevolcano</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">padjlevel</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.05</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">pSE_thresh</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">nSE_thresh</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">ntop </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">10</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">voltype</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"ggplot"</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">volcano_GSE7390</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">Makevolcano</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #ebedf0; font-style: italic;">,</span>
                               <span style="color: #ebedf0; font-style: italic;">padjlevel</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.05</span><span style="color: #ebedf0; font-style: italic;">,</span>
                               <span style="color: #ebedf0; font-style: italic;">pSE_thresh</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span>
                               <span style="color: #ebedf0; font-style: italic;">nSE_thresh</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span>
                               <span style="color: #ebedf0; font-style: italic;">ntop </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">10</span><span style="color: #ebedf0; font-style: italic;">,</span>
                               <span style="color: #ebedf0; font-style: italic;">voltype</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"ggplot"</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">volcano_GSE25065</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">Makevolcano</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">padjlevel</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.05</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">pSE_thresh</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">nSE_thresh</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">ntop </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">10</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">voltype</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"ggplot"</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">volcano_GSE25055</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">Makevolcano</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">padjlevel</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.05</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">pSE_thresh</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">nSE_thresh</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">ntop </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">10</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">voltype</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"ggplot"</span><span style="color: #68affc; font-style: italic;">)</span>
# Combination
<span style="color: #ebedf0; font-style: italic;">volcano_combination</span> <span style="color: #68affc; font-style: italic;"><-</span> <span style="color: #ebedf0; font-style: italic;">Makevolcano</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"combination"</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">padjlevel</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.05</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">pSE_thresh</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">nSE_thresh</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #68affc; font-style: italic;">-</span><span style="color: #cf4275; font-style: italic;">1</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">ntop </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">10</span><span style="color: #ebedf0; font-style: italic;">,</span>
                                <span style="color: #ebedf0; font-style: italic;">voltype</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"ggplot"</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">MakeVenna</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">common</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">c</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #ebedf0; font-style: italic;">,</span><span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">ntop </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">10</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">MakeHeatmap</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
            <span style="color: #ebedf0; font-style: italic;">groups</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">grade1 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"1"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">grade3 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"3"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">ntop </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">25</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">sorted </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">MakeHeatmap</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;"> normalized_GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
            <span style="color: #ebedf0; font-style: italic;">groups</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">grade1 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"1"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">grade3 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"3"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">ntop </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">25</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">sorted </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">MakeHeatmap</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
            <span style="color: #ebedf0; font-style: italic;">groups</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">grade1 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"1"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">grade3 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"3"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">ntop </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">25</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">sorted </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">MakeHeatmap</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">normalized_GSE7390</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
            <span style="color: #ebedf0; font-style: italic;">groups</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">grade1 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"1"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">grade3 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"3"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">ntop </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">25</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">sorted </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>

# Combination 
<span style="color: #ebedf0; font-style: italic;">MakeHeatmap</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">merge_studies</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"combination"</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
            <span style="color: #ebedf0; font-style: italic;">groups</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">grade1 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"1"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">grade3 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"3"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">ntop </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">25</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">sorted </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">FALSE</span><span style="color: #68affc; font-style: italic;">)</span>
# Sorted grade
<span style="color: #ebedf0; font-style: italic;">MakeHeatmap</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #ebedf0; font-style: italic;">merge_studies</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"combination"</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
            <span style="color: #ebedf0; font-style: italic;">groups</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">grade1 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"1"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">grade3 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"3"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">ntop </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">25</span><span style="color: #ebedf0; font-style: italic;">,</span>
            <span style="color: #ebedf0; font-style: italic;">sorted </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">TRUE</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">GSEAAnalysis</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">FDR</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.05</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">GSEAAnalysis</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">FDR</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.05</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">GSEAAnalysis</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">FDR</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.05</span><span style="color: #68affc; font-style: italic;">)</span>
<span style="color: #ebedf0; font-style: italic;">GSEAAnalysis</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">FDR</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.05</span><span style="color: #68affc; font-style: italic;">)</span>

# Combination
<span style="color: #ebedf0; font-style: italic;">GSEAAnalysis</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"combination"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">FDR</span> <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #cf4275; font-style: italic;">0.05</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">Makenetworkanalyst</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> GSE11121</span><span style="color: #ebedf0; font-style: italic;">,</span>
                   <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE11121"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                   <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                   <span style="color: #ebedf0; font-style: italic;">groups</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">grade1 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"1"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">grade3 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"3"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">Makenetworkanalyst</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">GSE25055</span><span style="color: #ebedf0; font-style: italic;">,</span>
                   <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25055"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                   <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                   <span style="color: #ebedf0; font-style: italic;">groups</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">grade1 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"1"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">grade3 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"3"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">Makenetworkanalyst</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> GSE25065</span><span style="color: #ebedf0; font-style: italic;">,</span>
                   <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE25065"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                   <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                   <span style="color: #ebedf0; font-style: italic;">groups</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">grade1 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"1"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">grade3 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"3"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>

<span style="color: #ebedf0; font-style: italic;">Makenetworkanalyst</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">matrix</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;"> GSE7390</span><span style="color: #ebedf0; font-style: italic;">,</span>
                   <span style="color: #ebedf0; font-style: italic;">projname</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"GSE7390"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                   <span style="color: #ebedf0; font-style: italic;">compare</span>  <span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"grade"</span><span style="color: #ebedf0; font-style: italic;">,</span> 
                   <span style="color: #ebedf0; font-style: italic;">groups</span> <span style="color: #68affc; font-style: italic;">=</span><span style="color: #ebedf0; font-style: italic;">list</span><span style="color: #68affc; font-style: italic;">(</span><span style="color: #ebedf0; font-style: italic;">grade1 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"1"</span><span style="color: #ebedf0; font-style: italic;">,</span> <span style="color: #ebedf0; font-style: italic;">grade3 </span><span style="color: #68affc; font-style: italic;">=</span> <span style="color: #2ad43b; font-style: italic;">"3"</span><span style="color: #68affc; font-style: italic;">)</span><span style="color: #68affc; font-style: italic;">)</span>




	    </code></pre>
	</section>

	<footer class="footer">
	    <p>&copy; 2023 Mohammad Reza Mohajeri. All rights reserved.</p>
	</footer>
</body>
</html>
